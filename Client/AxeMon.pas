unit AxeMon;

interface

uses
  {svn, }Windows, Messages, SysUtils, Classes, ExtCtrls, Graphics, Controls, Forms, Dialogs,
  Grobal2, DxDraws, CliUtil, ClFunc, magiceff, Actor, ClEvent;


const
   DEATHEFFECTBASE = 340;
   DEATHFIREEFFECTBASE = 2860;
   AXEMONATTACKFRAME = 6;
   KUDEGIGASBASE = 1445;
   COWMONFIREBASE = 1800;
   COWMONLIGHTBASE = 1900;
   ZOMBILIGHTINGBASE = 350;
   ZOMBIDIEBASE = 340;
   ZOMBILIGHTINGEXPBASE = 520;
   SCULPTUREFIREBASE = 1680;
   MOTHPOISONGASBASE = 3590;
   DUNGPOISONGASBASE = 3590;
   WARRIORELFFIREBASE = 820;
   SUPERIORGUARDBASE = 760;

type
   TSkeletonOma = class (TActor) //Size:25C
   private
   protected
      EffectSurface: TDirectDrawSurface;    //0x240
      AttackEffectSurface: TDirectDrawSurface;    //0x240
      firedir :integer;    //0x25C
      ax: Integer;                           //0x244
      ay: integer;
      ex, ey: integer;                       //0x248
      bx, cx, by, cy: integer;
      SitDown : Boolean;
   public
      constructor Create; override;
      //destructor Destroy; override;
      procedure CalcActorFrame; override;
      function  GetDefaultFrame (wmode: Boolean): integer; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
      procedure DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer);  override;
   end;

   TDualAxeOma = class (TSkeletonOma)
   private
   public
      procedure Run; override;
   end;

   TCatMon = class (TSkeletonOma)
   private
   public
      procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
      procedure DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer);  override;
   end;

   TArcherMon = class (TCatMon)//±Ã¼ö
   public
      procedure Run; override;
   end;

   TScorpionMon = class (TCatMon)
   public
   end;

   THuSuABi = class (TSkeletonOma)
   public
      procedure LoadSurface; override;
   end;

   TZombiDigOut = class (TSkeletonOma)
   public
      procedure RunFrameAction (frame: integer); override;
   end;

   TZombiZilkin = class (TSkeletonOma)
   public
   end;

   TWhiteSkeleton = class (TSkeletonOma)
   public
   end;


   TGasKuDeGi = class (TActor)//Size 0x274
   protected
      AttackEffectSurface :TDirectDrawSurface;    //0x250
      DieEffectSurface    :TDirectDrawSurface;    //0x254
      BoUseDieEffect      :Boolean;    //0x258
      firedir             :integer;    //0x25C
      fire16dir           :integer;    //0c260
      ax                  :integer;    //0x264
      ay                  :integer;    //0x268
      bx                  :integer;
      by                  :integer;
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      function  GetDefaultFrame (wmode: Boolean): integer; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TFireCowFaceMon = class (TGasKuDeGi)
   public
      function   Light: integer; override;
   end;

   TCowFaceKing = class (TGasKuDeGi)
   public
      function   Light: integer; override;
   end;

   TZombiLighting = class (TGasKuDeGi)
   protected
   public
   end;
   TSuperiorGuard = class (TGasKuDeGi)
   protected
   public
   end;

   TExplosionDark = class (TGasKuDeGi)    //Ä¥Èæ¼ö
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;


   TExplosionSpider = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   TFlyingSpider = class (TSkeletonOma)//Size: 0x25C Address: 0x00461F38
   protected
   public
     procedure CalcActorFrame; override;
   end;
   TSculptureMon = class (TSkeletonOma)
   private
      AttackEffectSurface: TDirectDrawSurface;
      ax, ay, firedir: integer;
      ex, ey: Integer;
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      function  GetDefaultFrame (wmode: Boolean): integer; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
      procedure DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer); override;
      procedure Run; override;
   end;

   TSculptureKingMon = class (TSculptureMon)
   public
   end;

   TSmallElfMonster = class (TSkeletonOma)
   public
   end;

   TWarriorElfMonster = class (TSkeletonOma)
   private
      oldframe: integer;
   public
      procedure  RunFrameAction (frame: integer); override;
   end;
   //Èæ»ç¿Õ
   TElectronicScolpionMon = class (TGasKuDeGi)//Size 0x274 0x3c
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   TBossPigMon = class (TGasKuDeGi)//0x3d
   protected
   public
      procedure LoadSurface; override;   
   end;
   TKingOfSculpureKingMon = class (TGasKuDeGi)//0x3e
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   TSkeletonKingMon = class (TGasKuDeGi)//0x3f   //ÇØ°ñ¹Ý¿Õ
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;   
   end;
   TSamuraiMon = class (TGasKuDeGi)//0x41
   protected
   public
   end;
   TSkeletonSoldierMon = class (TGasKuDeGi)//0x42 0x43 0x44
   protected
   public
   end;
   TSkeletonArcherMon = class (TArcherMon)//Size: 0x26C Address: 0x004623B4 //0x45
      AttackEffectSurface :TDirectDrawSurface;//0x25C
      bo260:Boolean;
      n264:integer;
      n268:integer;
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;
   TBanyaGuardMon = class (TSkeletonArcherMon)
     LightningTimer: TTimer;
   protected
     n26C:TDirectDrawSurface;
     EffectBSurface:TDirectDrawSurface;
     SitDown : Boolean;
   public
      procedure LightningTimerTimer(Sender: TObject); //¼®¸¶¼ö
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
      procedure DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer); override;
   end;

   TShineCaveMon = class (TSkeletonArcherMon)
   protected
     n26C:TDirectDrawSurface;
     n27C:TDirectDrawSurface;
     EffectBSurface:TDirectDrawSurface;
     EffectPront:TDirectDrawSurface;
   public
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      function  GetDefaultFrame (wmode: Boolean): integer; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
      procedure DrawProntEff (dsurface: TDirectDrawSurface; dx, dy: integer);  override;
      procedure DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer); override;
   end;


   TYehaGuardMon = class (TSkeletonArcherMon)     //¿©ÇÏ½ÅÀü
     LightningTimer: TTimer;
   protected
     n26C:TDirectDrawSurface;
     SitDown : Boolean;
   public
      procedure LightningTimerTimer(Sender: TObject);  //°øÀÛÁÖ
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TPet = class (TSkeletonArcherMon)     //¿µ¹°
   protected
     n26C:TDirectDrawSurface;
   public
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TNamManMon = class (TSkeletonArcherMon)//
   protected
     n26C:TDirectDrawSurface;
     SitDown : Boolean;
   public
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;


   TMerMaidKingMon = class (TSkeletonArcherMon)//¼ö¾î±Í
   protected
     n26C:TDirectDrawSurface;
     SitDown : Boolean;
   public
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;



   TGumiBoss = class (TSkeletonArcherMon)
      n26C: TDirectDrawSurface;
      n270: TDirectDrawSurface;
      SpiderTimer: TTimer;
   protected
   public
      procedure SpiderTimerTimer(Sender: TObject);
      constructor Create; override;
      destructor  Destroy; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TStoneMonster = class (TSkeletonArcherMon)//Size: 0x270 0x4d 0x4b
     n26C:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TPotMon = class (TSkeletonArcherMon)//È£Áß±Í2
     n26C:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TIceHellMonster5 = class (TSkeletonArcherMon)//Size: 0x270 0x4d 0x4b
     n26C:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;
   TIceHellMonster6 = class (TSkeletonArcherMon)//Size: 0x270 0x4d 0x4b
     n26C:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;
   TExplosionMon = class (TCatMon)//Æø¸¶¾ßÂ÷
   protected
   public
      procedure Run; override;
   end;
   TArcherMon2 = class (TCatMon)//¼®¸¶¾ßÂ÷
   protected
   public
      procedure Run; override;
   end;
   TPBOMA1Mon = class (TCatMon)//0x49
   protected
   public
      procedure Run; override;   
   end;
   TPBOMA6Mon = class (TCatMon)//0x4f      //¿À¸¶¼®±Ãº´
   protected
   public
      procedure Run; override;
   end;
   TAngel = class (TBanyaGuardMon)//Size: 0x27C 0x51
     m_npx2, m_npy2 :integer;
     m_BodySurface2: TDirectDrawSurface;
   protected
   public
      procedure  LoadSurface; override;
      procedure  DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TDarkAngel = class (TBanyaGuardMon)//Size: 0x27C 0x51
   protected
   public
      procedure  LoadSurface; override;
      procedure  DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;
   Tyounhon = class (TBanyaGuardMon)//Size: 0x27C 0x51
     n270:Integer;
     n274:Integer;
     n278:TDirectDrawSurface;
   protected
   public
      procedure  LoadSurface; override;
      procedure  DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   Twino = class (TBanyaGuardMon)//Size: 0x27C 0x51
     n270:Integer;
     n274:Integer;
     n278:TDirectDrawSurface;
   protected
   public
      procedure  LoadSurface; override;
      procedure  DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TGreatKing = class (TSkeletonArcherMon)//0x53   //¿°¸¶ÅÂÀÚ
     n270:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TBossTreeMan = class (TSkeletonArcherMon)  //¿©ÇÏ¼ö
     n270:TDirectDrawSurface;
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TElectBossMon = class (TSkeletonArcherMon)//¿À¸¶Á¦»çÀå
     LightningTimer: TTimer;
   protected
     n26C:TDirectDrawSurface;
     SitDown : Boolean;
   public
      destructor Destroy; override;
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TFireDragon = class (TSkeletonArcherMon)  //¸¶·æ
      LightningTimer: TTimer;
   protected
      AttackEffectSurface: TDirectDrawSurface;
   public
      procedure LightningTimerTimer(Sender: TObject);
      constructor Create; override;
      destructor  Destroy; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TDragonStatue = class (TSkeletonArcherMon) // ¿ë¼®»ó
   protected
      AttackEffectSurface: TDirectDrawSurface;
   public
      constructor Create; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;
   TKhazardMon = class (TSkeletonOma)
   protected
   public
     procedure CalcActorFrame; override;
     constructor Create; override;
   end;
   TFrostTiger = class (TSkeletonOma)   //È¯¿µÇÑÈ£
    boActive:Boolean;
    boCasted:Boolean;
   protected
   public
     procedure Run; override;
     procedure CalcActorFrame; override;
     constructor Create; override;
     function   GetDefaultFrame (wmode: Boolean): integer; override;
   end;

   TJumaThunderMon = class (TSculptureMon)
   protected
     EffBackSurface: TDirectDrawSurface;
   public
     constructor Create; override;
     procedure LoadSurface; override;
     procedure DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure CalcActorFrame; override;
   end;

   TYimoogi = class (TGasKuDeGi)    //ºÎ·æ±Ý»ç
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
   end;

   TBlackFox = class (TGasKuDeGi)//Size 0x274 0x3c
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   TGuardianRock = class (TGasKuDeGi)//Size 0x274 0x3c
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   TRedEffect = class (TSculptureMon)    //¿ùÁö
     EffectSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     constructor Create; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure LoadSurface; override;
   end;


   TExplosionSpider2 = class (TGasKuDeGi)
   protected
   public
     procedure CalcActorFrame; override;
//     constructor Create; override;
//     function   GetDefaultFrame (wmode: Boolean): integer; override;
     procedure LoadSurface; override;
   end;

   TGumimasin = class (TGasKuDeGi)
   protected
   public
//      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
   //   procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;


  { Tsudugui = class (TGasKuDeGi)
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
   end; }

  { Twallgi = class (TGasKuDeGi)
   protected
   public
      constructor Create; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure Run; override;
   end;     }



   TGreatFoxSpirit = class (TSkeletonArcherMon)
     LightningTimer: TTimer;

   protected
      AttackEffectSurface: TDirectDrawSurface;
   public
      procedure LightningTimerTimer(Sender: TObject);
      constructor Create; override;
      destructor  Destroy; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TFireLead = class (TSkeletonArcherMon)  //¿°È­Àû±Í
   protected
      AttackEffectSurface: TDirectDrawSurface;
   public
      constructor Create; override;
      destructor  Destroy; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TWindLead = class (TSkeletonArcherMon)  //¸¶Ç³¼®±«
   protected
      AttackEffectSurface: TDirectDrawSurface;
      AttackEffectSurface2: TDirectDrawSurface;
   public
      constructor Create; override;
      destructor  Destroy; override;
      procedure Run; override;
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
      procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   TElement = class (TGasKuDeGi)
     n270:Integer;
     n274:Integer;
     n278:TDirectDrawSurface;
   protected
   public
      procedure LoadSurface; override;
      procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;


   THellGuard = class (TGasKuDeGi)//Size 0x260
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   THellMonster1 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   THellMonster2 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   THellMonster3 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   THellMonster4 = class (TGasKuDeGi)
    boCasted:Boolean;
   protected
   public
     procedure Run; override;
     procedure CalcActorFrame; override;
     constructor Create; override;
     function   GetDefaultFrame (wmode: Boolean): integer; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
   end;

   THellMonster5 = class (TGasKuDeGi)
    boCasted:Boolean;
   protected
   public
  //   procedure Run; override;
     procedure CalcActorFrame; override;
     constructor Create; override;
     function   GetDefaultFrame (wmode: Boolean): integer; override;
     procedure LoadSurface; override;
   end;

   TIceHellMonster1 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   TIceHellMonster = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
   end;

   TIceHellMonster2 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;
   TIceHellMonster3 = class (TGasKuDeGi)
   protected
   public
      procedure CalcActorFrame; override;
      procedure LoadSurface; override;
   end;

   TWarriorH = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TWizardH = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
     procedure Run; override;
   end;

   TToaistH = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
     procedure Run; override;
   end;

   TAssassinH = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TWarriorM2 = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TWizardM2 = class (TBanyaGuardMon)
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
     procedure Run; override;
   end;

   TToaistF2 = class (TBanyaGuardMon)   //Á¤¿¬µµ»ç
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
     procedure Run; override;
   end;

   TAssassinM2 = class (TBanyaGuardMon)   //Çõ¹®°´
     n270:Integer;
     n274:Integer;
     n26C:TDirectDrawSurface;
     m_npx2, m_npy2 :integer;
     m_WeaponSurface: TDirectDrawSurface;
     m_WeaponSurface2: TDirectDrawSurface;
     m_HairSurface: TDirectDrawSurface;
   protected
   public
     procedure CalcActorFrame; override;
     procedure LoadSurface; override;
     procedure DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer); override;
     procedure DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean); override;
   end;

   TAchorMonster = class (TGasKuDeGi)//Size 0x274 0x3c
   private
   protected
   public
      procedure CalcActorFrame; override;
      procedure Run; override;
   end;

   TJobking = class (TGasKuDeGi)//¾ç¿ë¿Õ
   private
   protected
   public
     procedure CalcActorFrame; override;
   end;


implementation

uses
   ClMain, SoundUtil, WIL, MShare;


{============================== TSkeletonOma =============================}
{--------------------------}


constructor TSkeletonOma.Create;
begin
   inherited Create;
   EffectSurface := nil;
   AttackEffectSurface:=nil;
   m_boUseEffect := FALSE;
end;

procedure TSkeletonOma.CalcActorFrame;
var
   pm: PTMonsterAction;
   haircount: integer;
begin
   m_nCurrentFrame := -1;
   m_boReverseFrame := FALSE;
   m_boUseEffect := FALSE;

   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of
      SM_TURN:
         begin
            if m_btRace in [106] then SitDown := False; // ÀÌ¹«±â
            if m_btRace in [107,108,216,217,218,28,92] then m_nStartFrame := pm.ActStand.start  //È£±â¿¬ È£±â¿Á
            else
            m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
            m_dwFrameTime := pm.ActStand.ftime;
            if m_btRace in [105,152] then m_dwFrameTime := 200; //È¯¿µÇÑÈ£,°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
            m_dwStartTime := GetTickCount;
            m_nDefFrameCount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);
            if m_btRace in [107,108,216,217,218] then begin  //È£±â¿¬ È£±â¿Á
               m_boUseEffect := TRUE;
               m_dwEffectStartTime := GetTickCount;
            end;
         end;
      SM_WALK, SM_BACKSTEP:
         begin

            if m_btRace in [106] then SitDown := False; // È¯¿µÇÑÈ£, ÀÌ¹«±â

            if m_btRace in [107,108,216,217,218,28,92] then m_nStartFrame := pm.ActWalk.start    //È£±â¿¬ È£±â¿Á
            else
            m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
            m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
            m_dwFrameTime := pm.ActWalk.ftime;
            if m_btRace in [105,152] then m_dwFrameTime := 150; //È¯¿µÇÑÈ£,°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
            m_dwStartTime := GetTickCount;
            m_nMoveStep := 1;
            if m_btRace in [107,108,216,217,218] then begin          //È£±â¿¬ È£±â¿Á
               if (Random(3000) mod 3) = 1 then begin
                  if m_btRace = 107 then PlaySound(2551);
                  if m_btRace = 108 then PlaySound(2561);
               end;
               m_boUseEffect := TRUE;
               m_dwEffectStartTime := GetTickCount;
            end;

            if m_nCurrentAction = SM_WALK then
               Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
            else
               Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
         end;
      SM_DIGUP:
         begin
            if m_btRace in [106] then SitDown := False;    //È£±â¿¬ È£±â¿Á

            if (m_btRace = 23) or (m_btRace = 81) or (m_btRace = 82) or  (m_btRace in [216,217,218,234])  then begin //¿ù·É  È¥·É  //¹é°ñ //Áø°ñ
               m_nStartFrame := pm.ActDeath.start;
            end else begin
               m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
            end;
            m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
            m_dwFrameTime := pm.ActDeath.ftime;
            m_dwStartTime := GetTickCount;
            //WarMode := FALSE;
            if m_btRace in [216,217,218] then begin
               m_boUseEffect := False;
            end;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_DIGDOWN:
         begin
            if m_btRace = 55 then begin     //½Å¼ö
               m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
               m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
               m_dwFrameTime := pm.ActCritical.ftime;
               m_dwStartTime := GetTickCount;
               m_boReverseFrame := TRUE;
               //WarMode := FALSE;
               Shift (m_btDir, 0, 0, 1);
            end;

            if m_btRace in [106] then begin // È¯¿µÇÑÈ£ //####
               SitDown := True;
               m_nStartFrame := 420 + m_btDir * 10;
               m_nEndFrame := m_nStartFrame + 3;
               m_dwFrameTime := 300;
               m_dwStartTime := GetTickCount;
               Shift (m_btDir, 0, 0, 1);
            end;

         end;
      SM_HIT,
      SM_FLYAXE,
      SM_LIGHTING:
         begin
            m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
            m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
            m_dwFrameTime := pm.ActAttack.ftime;
            m_dwStartTime := GetTickCount;
            //WarMode := TRUE;
            m_dwWarModeTime := GetTickCount;
            if (m_btRace = 16) or (m_btRace = 54) then
               m_boUseEffect := TRUE;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_STRUCK:
         begin
            if m_btRace in [106] then SitDown := False; //È¯¿µÇÑÈ£, ÀÌ¹«±â


            if m_btRace in [107,108,216,217,218,28,92] then m_nStartFrame := pm.ActStruck.start    //È£±â¿¬ È£±â¿Á
            else

            m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
            m_dwFrameTime := m_dwStruckFrameTime; //pm.ActStruck.ftime;
            if m_btRace in [105,152] then m_dwFrameTime := 130; //°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
            m_dwStartTime := GetTickCount;

            if m_btRace in [107,108,216,217,218] then begin
               m_boUseEffect := TRUE;
               m_dwEffectStartTime := GetTickCount;
            end;

            if m_btRace = 264 then PlaySound(4324); //°õ
            if m_btRace = 265 then PlaySound(4334); //Ç¥¹ü
         end;
      SM_DEATH:
         begin
            if m_btRace in [104,150,151,155] then m_boUseEffect := False; //ÁÖ¸¶°Ý·ÚÀåÀÎ°æ¿ì
            if m_btRace in [107,108,216,217,218,28,92] then m_nStartFrame := pm.ActDie.start    //È£±â¿¬ È£±â¿Á
            else
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_nStartFrame := m_nEndFrame; //
            m_dwFrameTime := pm.ActDie.ftime;
            if m_btRace in [105,152] then m_dwFrameTime := 110; //°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
            m_dwStartTime := GetTickCount;
         end;
      SM_NOWDEATH:
         begin
            if m_btRace in [107,108,216,217,218,28,92] then m_nStartFrame := pm.ActDie.start   //È£±â¿¬ È£±â¿Á
            else
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
            if m_btRace <> 22 then
               m_boUseEffect := TRUE;

            if m_btRace = 164 then begin  //°ÝÅõ±ªÀÌ
              PlaySound2 (fightcat_die_cat);
            end;

            if m_btRace = 165 then begin   //ºÒ±ªÀÌ
              PlaySound2 (firecat_die_cat);
            end;
            if m_btRace = 166 then begin   //Ã¢±ªÀÌ
              PlaySound2 (spearcat_die_cat);
            end;
            if m_btRace = 167 then begin   //¾ó·è¸ÁÄ¡±ªÀÌ
              PlaySound2 (hammercat_die_cat);
            end;

            if m_btRace = 169 then begin   //°©±ªÀÌ
              PlaySound2 (armorcat_die_cat);
            end;
            if m_btRace = 264 then PlaySound(4325); //°õ
            if m_btRace = 265 then PlaySound(4335); //Ç¥¹ü
         end;
      SM_SKELETON:
         begin
            m_nStartFrame := pm.ActDeath.start;
            m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
            m_dwFrameTime := pm.ActDeath.ftime;
            m_dwStartTime := GetTickCount;
         end;
      SM_ALIVE:   //½Å¼ö
         begin
            m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
            m_dwFrameTime := pm.ActDeath.ftime;
            m_dwStartTime := GetTickCount;
         end;  
   end;
end;

function  TSkeletonOma.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
   Result:=0;
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   if m_boDeath then begin
      if m_wAppearance in [30..34, 151] then    //¿ì¸é±ÍÀÎ °æ¿ì ½ÃÃ¼°¡ »ç¶÷À» µ¤´Â °ÍÀ» ¸·±â À§ÇØ
         m_nDownDrawLevel := 1;

      if m_boSkeleton then
         Result := pm.ActDeath.start
      else
      if m_btRace = 115 then begin  //ºñ¿ùÃµÁÖ
         Result := 417;
         m_boUseEffect := False;
      end else
      if m_btRace in [107,108,216,217,218,28,92] then begin      //È£±â¿¬ È£±â¿Á
        Result := pm.ActDie.start + (pm.ActDie.frame - 1);
        m_boUseEffect := False;
      end else
      Result := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip) + (pm.ActDie.frame - 1);
   end else begin
     if SitDown and (m_btRace in [106]) then begin //ÀÌ¹«±â ####
       m_nDefFrameCount := 4;
       if m_nCurrentDefFrame < 0 then cf := 0
       else if m_nCurrentDefFrame >= 4 then cf := 0
       else cf := m_nCurrentDefFrame;
       Result := 420 + m_btDir * 10 + cf;
     end else begin

      m_nDefFrameCount := pm.ActStand.frame;
      if m_nCurrentDefFrame < 0 then cf := 0
      else if m_nCurrentDefFrame >= pm.ActStand.frame then cf := 0
      else cf := m_nCurrentDefFrame;

         if m_btRace = 115 then begin      //ºñ¿ùÃµÃß
            case TempState of
               1: m_nStartFrame := 0;
               2: m_nStartFrame := 80;
               3: m_nStartFrame := 160;
               4: m_nStartFrame := 240;
               5: m_nStartFrame := 320;
            end;
            Result := m_nStartFrame + cf
         end
         else
      if m_btRace in [107,108,216,217,218,28,92] then     //È£±â¿¬ È£±â¿Á
         Result := pm.ActStand.start + cf
      else
      Result := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip) + cf;

     end;

    if m_btRace in [107,108,216,217,218] then begin   //È£±â¿¬ È£±â¿Á
       m_boUseEffect := True;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := pm.ActStand.ftime;
    end;

      if m_btRace = 107 then           //È£±â¿¬  È£±â¿Á
       m_nEffectFrame := 1500 + m_nCurrentFrame
      else
      if m_btRace = 108 then         //È£±â¿Á
       m_nEffectFrame := 1610 + m_nCurrentFrame;
      if m_btRace = 216 then         //±¸½½
       m_nEffectFrame := 3510 + m_nCurrentFrame;
      if m_btRace = 217 then         //±¸½½
       m_nEffectFrame := 3650 + m_nCurrentFrame;
      if m_btRace = 218 then         //±¸½½
       m_nEffectFrame := 3780 + m_nCurrentFrame;    

      if m_btRace = 115 then begin  //ºñ¿ùÃµÃß
         m_boUseEffect := True;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := pm.ActStand.ftime;
         m_nEffectFrame := 1710 + m_nCurrentFrame;
      end;

   end;


end;

procedure  TSkeletonOma.LoadSurface;
begin
   inherited LoadSurface;
   case m_btRace of
      14, 15, 17, 22, 53:
         begin
            if m_boUseEffect then
               EffectSurface := g_WMonImagesArr[2].GetCachedImage (DEATHEFFECTBASE + m_nCurrentFrame-m_nStartFrame, ax, ay);
         end;
      23:   //¹é°ñ
         begin
            if m_nCurrentAction = SM_DIGUP then begin
               m_BodySurface := nil;
               EffectSurface := g_WMonImagesArr[3].GetCachedImage (m_nBodyOffset + m_nCurrentFrame, ax, ay);
               m_boUseEffect := TRUE;
            end else
               m_boUseEffect := FALSE;
         end;
      234:   //Áø°ñ
         begin
            if m_nCurrentAction = SM_DIGUP then begin
               m_BodySurface := nil;
               EffectSurface := g_WKuLouImages.GetCachedImage (m_nBodyOffset + m_nCurrentFrame, ax, ay);
               m_boUseEffect := TRUE;
            end else
               m_boUseEffect := FALSE;
         end;
   end;

end;

procedure  TSkeletonOma.Run;
var
   prv: integer;
   m_dwFrameTimetime: longword;
   bofly: Boolean;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)   then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            if m_btRace in [150,151] then m_boUseEffect := True
            else m_boUseEffect := FALSE;
         end;
      end;
      if m_btRace in [104, 155] then begin        //ÁÖ¸¶°Ý·ÚÀå
        if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
          if g_boEffect then begin
            PlayScene.NewMagic (self, MAGIC_DUN_THUNDER, MAGIC_DUN_THUNDER, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY, m_nTargetRecog, mtThunder, FALSE, 30, bofly);
            PlaySound (8301);
          end;
        end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


procedure TSkeletonOma.DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean);
var
   idx: integer;
   d: TDirectDrawSurface;
   ceff: TColorEffect;
begin
   if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface; //bodysurface loadsurface
   end;

   ceff := GetDrawEffectValue;

   if m_BodySurface <> nil then begin
     DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
   end;

   if g_BoEffect then begin
     if m_boUseEffect and (not (m_btRace in [104,150,151,155])) then       //ÁÖ¸¶°Ý·ÚÀåÀÌ ¾Æ´Ï¸é..
     if EffectSurface <> nil then begin
      DrawBlend(dsurface,
        dx + ax + m_nShiftX,
        dy + ay + m_nShiftY,
        EffectSurface, 1);
      end;
   end;
end;


procedure TSkeletonOma.DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer);
var
   idx, ax, ay: integer;
   d: TDirectDrawSurface;
begin
   if m_nState and $00000800 <> 0 then begin   //Ç÷·æ¼ö
    idx := BLOODWATER + (m_nGenAniCount mod 2);
    d := g_WMagic3Images.GetCachedImage (idx, ax, ay);
    if d <> nil then
      DrawBlend (dsurface, dx + ax + m_nShiftX, dy + 100 + ay + m_nShiftY, d, 1);
  end;
end;

{============================== TSkeletonOma =============================}
{--------------------------}


procedure  TDualAxeOma.Run;
var
   prv: integer;
   m_dwFrameTimetime: longword;
   meff: TFlyingAxe;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame-m_nStartFrame = AXEMONATTACKFRAME-4) then begin
            meff := TFlyingAxe (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mtFlyAxe));
            if meff <> nil then begin
               if m_btRace = 25 then
                 meff.ImgLib := g_WMonImagesArr[38]
               else  meff.ImgLib := g_WMonImagesArr[2];
               case m_btRace of
                  15: meff.FlyImageBase := FLYOMAAXEBASE;
                  22: meff.FlyImageBase := THORNBASE;
                  25: meff.FlyImageBase := 2410;    //¼­¼ºÀÌ´Â±Ãº´
               end;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


procedure  TWarriorElfMonster.RunFrameAction (frame: integer);
var
   meff: TMapEffect;
   event: TClEvent;
begin
   if m_nCurrentAction = SM_HIT then begin
      if (frame = 5) and (oldframe <> frame) then begin
         meff := TMapEffect.Create (WARRIORELFFIREBASE + 10 * m_btDir + 1, 5, m_nCurrX, m_nCurrY);
         meff.ImgLib := g_WMonImagesArr[17];
         meff.NextFrameTime := 100;
         PlayScene.m_EffectList.Add (meff);
      end;
      oldframe := frame;
   end;
end;


{--------------------------}


procedure TCatMon.DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean);
var
   idx: integer;
   d: TDirectDrawSurface;
   ceff: TColorEffect;
begin
   if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

   ceff := GetDrawEffectValue;

   if m_BodySurface <> nil then
     if m_btRace in [91,232] then begin    //È¥ºÒ Ä®³¯¹Ù¶÷
       DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff, 1);
     end else begin
      if (m_btRace = 81) {or (m_btRace = 82)} then //¿ù·É È¥·É
        DrawEffSurface (dsurface, m_BodySurface, dx + m_npx + m_nShiftX, dy + m_npy + m_nShiftY, False, ceNone)
      else
        DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
     end;
end;

procedure TCatMon.DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer);
var
   idx, ax, ay: integer;
   d: TDirectDrawSurface;
begin
   if m_nState and $00000800 <> 0 then begin   //Ç÷·æ¼ö
    idx := BLOODWATER + (m_nGenAniCount mod 2);
    d := g_WMagic3Images.GetCachedImage (idx, ax, ay);
    if d <> nil then
      DrawBlend (dsurface, dx + ax + m_nShiftX, dy + 100 + ay + m_nShiftY, d, 1);
  end;
end;

{============================= TArcherMon =============================}


procedure TArcherMon.Run;       //±Ã¼ö
var
   prv: integer;
   m_dwFrameTimetime: longword;
   meff: TFlyingAxe;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

            meff := TFlyingArrow (PlayScene.NewFlyObject (self,    //±Ã¼ö
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mtFlyArrow));
            if meff <> nil then begin
               meff.ImgLib := g_WEffectImg;
               meff.NextFrameTime := 30;
               meff.FlyImageBase := ARCHERBASE2;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


{============================= TZombiDigOut =============================}


procedure TZombiDigOut.RunFrameAction (frame: integer);
var
   clevent: TClEvent;
begin
   if m_nCurrentAction = SM_DIGUP then begin
      if frame = 6 then begin
         clevent := TClEvent.Create (m_nCurrentEvent, m_nCurrX, m_nCurrY, ET_DIGOUTZOMBI);
         clevent.m_nDir := m_btDir;
         EventMan.AddEvent (clevent);
         //pdo.DSurface := g_WMonImagesArr[5].GetCachedImage (ZOMBIDIGUPDUSTBASE+Dir, pdo.px, pdo.py);
      end;
   end;
end;


{============================== THuSuABi =============================}

{--------------------------}


procedure  THuSuABi.LoadSurface;
begin
   inherited LoadSurface;
   if m_boUseEffect then
      EffectSurface := g_WMonImagesArr[2].GetCachedImage (DEATHFIREEFFECTBASE + m_nCurrentFrame-m_nStartFrame, ax, ay);
end;


{============================== TGasKuDeGi =============================}
{--------------------------}


constructor TGasKuDeGi.Create;
begin
   inherited Create;
   AttackEffectSurface := nil;
   DieEffectSurface := nil;
   m_boUseEffect := FALSE;
   BoUseDieEffect := FALSE;
end;

procedure TGasKuDeGi.CalcActorFrame;
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   m_nCurrentFrame := -1;

   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of
      SM_TURN:
         begin
            m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
            m_dwFrameTime := pm.ActStand.ftime;
            m_dwStartTime := GetTickCount;
            m_nDefFrameCount := pm.ActStand.frame;

            Shift (m_btDir, 0, 0, 1);
         end;
      SM_WALK:
         begin
            m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
            m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
            m_dwFrameTime := pm.ActWalk.ftime;
            m_dwStartTime := GetTickCount;
            m_nMoveStep := 1;
            if m_nCurrentAction = SM_WALK then
               Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
            else  //sm_backstep
               Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
         end;
      SM_HIT,
      SM_LIGHTING:
         begin
            m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
            m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
            m_dwFrameTime := pm.ActAttack.ftime;
            m_dwStartTime := GetTickCount;
            //WarMode := TRUE;
            m_dwWarModeTime := GetTickCount;
            Shift (m_btDir, 0, 0, 1);
            m_boUseEffect := TRUE;
            firedir := m_btDir;
            m_nEffectFrame := m_nStartFrame;
            m_nEffectStart := m_nStartFrame;
            if m_btRace = 20 then
              m_nEffectEnd := m_nEndFrame + 1
            else
            m_nEffectEnd := m_nEndFrame;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;

            actor := PlayScene.FindActor (m_nTargetRecog);
            if actor <> nil then begin
               PlayScene.ScreenXYfromMCXY (m_nCurrX, m_nCurrY, scx, scy);
               PlayScene.ScreenXYfromMCXY (actor.m_nCurrX, actor.m_nCurrY, stx, sty);
               fire16dir := GetFlyDirection16 (scx, scy, stx, sty);
            end else
               fire16dir := firedir * 2;
         end;
      SM_STRUCK:
         begin
            m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
            m_dwFrameTime := m_dwStruckFrameTime; //pm.ActStruck.ftime;
            m_dwStartTime := GetTickCount;
         end;
      SM_DEATH:
         begin
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_nStartFrame := m_nEndFrame; //
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
         end;
      SM_NOWDEATH:
         begin
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
            {
            if m_btRace = 40 then
               BoUseDieEffect := TRUE;
            }
            if (m_btRace = 40) or (m_btRace = 65) or (m_btRace = 66) or (m_btRace = 67) or (m_btRace = 68) or (m_btRace = 69) then
               BoUseDieEffect := TRUE;
         end;
      SM_SKELETON:
         begin
            m_nStartFrame := pm.ActDeath.start;
            m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
            m_dwFrameTime := pm.ActDeath.ftime;
            m_dwStartTime := GetTickCount;
         end;
   end;
end;

function  TGasKuDeGi.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
   Result:=0;
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   if m_boDeath then begin
      if m_boSkeleton then
         Result := pm.ActDeath.start
      else Result := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip) + (pm.ActDie.frame - 1);
   end else begin
      m_nDefFrameCount := pm.ActStand.frame;
      if m_nCurrentDefFrame < 0 then cf := 0
      else if m_nCurrentDefFrame >= pm.ActStand.frame then cf := 0
      else cf := m_nCurrentDefFrame;
      Result := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip) + cf;
   end;
end;

procedure  TGasKuDeGi.LoadSurface;
begin
   inherited LoadSurface;
   case m_btRace of
      //¹¥»÷Ð§¹û
      16://¶´Çù
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[2].GetCachedImage (
                        KUDEGIGASBASE-1 + (firedir * 10) + m_nEffectFrame-m_nEffectStart,
                        ax, ay);
         end;
      20://»ðÑæÎÖÂê
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[3].GetCachedImage (
                        COWMONFIREBASE + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;
      21://ÎÖÂê½ÌÖ÷
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[3].GetCachedImage (
                        COWMONLIGHTBASE + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;
      24:
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[0].GetCachedImage (
                        SUPERIORGUARDBASE + (m_btDir * 8) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;

      40://½©Ê¬1
         begin
            if m_boUseEffect then begin
               AttackEffectSurface := g_WMonImagesArr[4].GetCachedImage (
                        ZOMBILIGHTINGBASE + (fire16dir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
            end;
            if BoUseDieEffect then begin
               DieEffectSurface := g_WMonImagesArr[4].GetCachedImage (
                        ZOMBIDIEBASE + m_nCurrentFrame-m_nStartFrame, //
                        bx, by);
            end;
         end;
      52://Ð¨¶ê
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[3].GetCachedImage (
                        MOTHPOISONGASBASE + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;
      53://·à³æ
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[2].GetCachedImage (
                        DUNGPOISONGASBASE + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;
      64: begin
        if m_boUseEffect then begin
          AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                        720 + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
        end;
      end;
      65: begin
        if BoUseDieEffect then begin
          DieEffectSurface:= g_WMonImagesArr[19].GetCachedImage (
                        350 + m_nCurrentFrame-m_nStartFrame, bx, by);
        end;
      end;
      66: begin
        if BoUseDieEffect then begin
          DieEffectSurface:= g_WMonImagesArr[19].GetCachedImage (
                        1600 + m_nCurrentFrame-m_nStartFrame, bx, by);
        end;
      end;
      67: begin
        if BoUseDieEffect then begin
          DieEffectSurface:= g_WMonImagesArr[19].GetCachedImage (
                        1160 + (m_btDir * 10) + m_nCurrentFrame-m_nStartFrame, bx, by);
        end;
      end;
      68: begin
        if BoUseDieEffect then begin
          DieEffectSurface:= g_WMonImagesArr[19].GetCachedImage (
                        1600 + m_nCurrentFrame-m_nStartFrame, bx, by);
        end;
      end;
      122://¿¬È¥±«¼ö
         begin
              if m_boUseEffect then begin
               AttackEffectSurface := g_WMonImagesArr[13].GetCachedImage (
                        3500 + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
            end;
         end;
   end;
end;

procedure  TGasKuDeGi.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   //
   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            BoUseDieEffect := FALSE;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


procedure TGasKuDeGi.DrawChr (dsurface: TDirectDrawSurface; dx, dy: integer; blend: Boolean;boFlag:Boolean);
var
   idx: integer;
   d: TDirectDrawSurface;
   ceff: TColorEffect;
begin
   if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface; //bodysurface loadsurface
   end;

   ceff := GetDrawEffectValue;

   if m_BodySurface <> nil then
      DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);

end;

procedure TGasKuDeGi.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);
var
   idx: integer;
   d: TDirectDrawSurface;
   ceff: TColorEffect;
begin
   if m_boUseEffect then
     if AttackEffectSurface <> nil then begin
        DrawBlend (dsurface,
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    AttackEffectSurface, 1);
     end;


   if BoUseDieEffect then
      if DieEffectSurface <> nil then begin
         DrawBlend (dsurface,
                    dx + bx + m_nShiftX,
                    dy + by + m_nShiftY,
                    DieEffectSurface, 1);
      end;
end;



{-----------------------------------------------------------}

function  TFireCowFaceMon.Light: integer;
var
   l: integer;
begin
   l := m_nChrLight;
   if l < 2 then begin
      if m_boUseEffect then
         l := 2;
   end;
   Result := l;
end;

function  TCowFaceKing.Light: integer;
var
   l: integer;
begin
   l := m_nChrLight;
   if l < 2 then begin
      if m_boUseEffect then
         l := 2;
   end;
   Result := l;
end;


{-----------------------------------------------------------}

//procedure TZombiLighting.Run;


{-----------------------------------------------------------}


procedure TSculptureMon.CalcActorFrame;
var
   pm: PTMonsterAction;
   haircount: integer;
begin
   m_nCurrentFrame := -1;

   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   m_boUseEffect := FALSE;

   case m_nCurrentAction of
      SM_TURN:
         begin
            if (m_nState and STATE_STONE_MODE) <> 0 then begin
               if (m_btRace = 48) or (m_btRace = 49) then
                  m_nStartFrame := pm.ActDeath.start // + Dir * (pm.ActDeath.frame + pm.ActDeath.skip)
               else
                  m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
               m_nEndFrame := m_nStartFrame;
               m_dwFrameTime := pm.ActDeath.ftime;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := pm.ActDeath.frame;
            end else begin
               m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
               m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
               m_dwFrameTime := pm.ActStand.ftime;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := pm.ActStand.frame;
            end;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_WALK, SM_BACKSTEP:
         begin
            if m_btRace in [150,151] then m_boUseEffect := True;
            m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
            m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
            m_dwFrameTime := pm.ActWalk.ftime;
            m_dwStartTime := GetTickCount;
            //WarMode := FALSE;
            m_nMoveStep := 1;
            if m_nCurrentAction = SM_WALK then
               Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
            else  //sm_backstep
               Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
         end;
      SM_DIGUP:
         begin
            if (m_btRace = 48) or (m_btRace = 49) then begin
               m_nStartFrame := pm.ActDeath.start;
            end else begin
               m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
            end;
            m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
            m_dwFrameTime := pm.ActDeath.ftime;
            m_dwStartTime := GetTickCount;
            //WarMode := FALSE;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_HIT:
         begin
            m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
            m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
            m_dwFrameTime := pm.ActAttack.ftime;
            m_dwStartTime := GetTickCount;
            if m_btRace in [150,151] then m_boUseEffect := True;
            if m_btRace = 49 then begin
               m_boUseEffect := TRUE;
               firedir := m_btDir;
               m_nEffectFrame := 0; //startframe;
               m_nEffectStart := 0; //startframe;
               m_nEffectEnd := m_nEffectStart + 8;
               m_dwEffectStartTime := GetTickCount;
               m_dwEffectFrameTime := m_dwFrameTime;
            end;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_STRUCK:
         begin
            if m_btRace in [150,151] then m_boUseEffect := True;
            m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
            m_dwFrameTime := m_dwStruckFrameTime; //pm.ActStruck.ftime;
            m_dwStartTime := GetTickCount;
         end;
      SM_DEATH:
         begin
            if m_btRace in [150,151] then m_boUseEffect := False;
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_nStartFrame := m_nEndFrame; //
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
         end;
      SM_NOWDEATH:
         begin
           if m_btRace in [150,151] then m_boUseEffect := False;
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
         end;
   end;
end;

procedure  TSculptureMon.LoadSurface;
begin
   inherited LoadSurface;
   case m_btRace of
      48, 49:
         begin
            if m_boUseEffect then
               AttackEffectSurface := g_WMonImagesArr[6].GetCachedImage (
                        SCULPTUREFIREBASE + (firedir * 10) + m_nEffectFrame-m_nEffectStart, //
                        ax, ay);
         end;
   end;
end;

function  TSculptureMon.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
   effectframetimetime, frametimetime: longword;
begin
   Result:=0;
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   if m_boDeath then begin
      Result := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip) + (pm.ActDie.frame - 1);
   end else begin
      if (m_nState and STATE_STONE_MODE) <> 0 then begin
         case m_btRace of
            47, 150: Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
            48, 49, 151: Result := pm.ActDeath.start;
            104, 155: begin           //ÁÖ¸¶°Ý·ÚÀå
              m_boUseEffect := False;
              Result := 420 + m_btDir * 10;
            end;
         end;
      end else begin
         m_nDefFrameCount := pm.ActStand.frame;
         if m_nCurrentDefFrame < 0 then cf := 0
         else if m_nCurrentDefFrame >= pm.ActStand.frame then cf := 0
         else cf := m_nCurrentDefFrame;
         Result := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip) + cf;

         if m_btRace in [104,155] then begin         //ÁÖ¸¶°Ý·ÚÀå
           if Not m_boUseEffect then begin
             if m_btRace = 155 then begin
               m_neffectframe := 3650 + m_btDir * 10;
               m_neffectstart := 3650 + m_btDir * 10;
             end else begin
               m_neffectframe := 940 + m_btDir * 10;
               m_neffectstart := 940 + m_btDir * 10;
             end;
             m_neffectend := m_neffectstart + pm.ActStand.frame-1;//endframe;
             m_dweffectstarttime := GetTickCount;
             m_dweffectframetime := pm.ActStand.ftime+50;
           end;
           m_boUseEffect := True;
           effectframetimetime := m_dweffectframetime;
           if GetTickCount - m_dweffectstarttime > effectframetimetime-50 then begin
             // 50»©´Â ÀÌÀ¯´Â run¿¡¼­µµ effectstarttime °ªÀÌ º¯ÇÏ±â ¶§¹®¿¡ ¸ÕÀú ·çÆ¾À» Å¸±âÀ§ÇØ..
             m_dweffectstarttime := GetTickCount;
             if m_neffectframe < m_neffectend then begin
                Inc (m_neffectframe);
             end else begin
                m_boUseEffect := FALSE;
             end;
           end;
         end;

      end;
   end;
end;

procedure TSculptureMon.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);
var
   idx: integer;
   d: TDirectDrawSurface;
begin
  if g_boEffect then begin
   if m_boUseEffect then
      if AttackEffectSurface <> nil then begin
         DrawBlend (dsurface,
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    AttackEffectSurface, 1);
      end;
  end;
end;

procedure TSculptureMon.DrawBackEff(dsurface: TDirectDrawSurface; dx, dy: Integer);
var
  idx: Integer;
  d: TDirectDrawSurface;
begin
  if m_boUseEffect then
    if AttackEffectSurface <> nil then begin
      DrawBlend(dsurface,
        dx + ax + m_nShiftX,
        dy + ay + m_nShiftY,
        AttackEffectSurface, 1);
    end;
end;


procedure TSculptureMon.Run;
var
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   if m_boUseEffect then begin
      m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
           if not m_btRace in [150,151] then
            m_boUseEffect := FALSE;
         end;
      end;
   end;
   inherited Run;
end;


{ TBanyaGuardMon }

constructor TBanyaGuardMon.Create;
begin
  inherited Create;
  n26C:=nil;
  EffectBSurface  := nil;
  if m_btRace in [100,159] then begin
    LightningTimer := TTimer.Create (nil);   //¼®¸¶¼ö  ¾ß¼ö¿Õ
    LightningTimer.Interval := 10;
    LightningTimer.Tag := 0;
    LightningTimer.OnTimer := LightningTimerTimer;
    LightningTimer.Enabled := False;
  end;
end;

destructor TBanyaGuardMon.Destroy;
begin
  if m_btRace in [100,159] then begin //¼®¸¶¼ö  ¾ß¼ö¿Õ
    if LightningTimer <> nil then LightningTimer.Free;   //¼®¸¶¼ö
  end;
  inherited Destroy;
end;

procedure TBanyaGuardMon.LoadSurface;
begin
  inherited;
  if bo260 then begin   //Á×¾úÀ»¶§ ÀÌÆÑÆ® Ç¥½ÃÇÏ´Â°Íµé,
    case m_btRace of
      70: begin //¹Ý¾ß¿ì»ç
        AttackEffectSurface := g_WMonImagesArr[20].GetCachedImage (
                        2320 + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);
      end;
      71: begin //¹Ý¾ßÁÂ»ç
        AttackEffectSurface := g_WMonImagesArr[20].GetCachedImage (
                        2870 + (m_btDir * 10) + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);

      end;

      78: begin //ÆÄÈ²¸¶½Å
        AttackEffectSurface := g_WMonImagesArr[21].GetCachedImage (
                        3120 + (m_btDir * 20) +  m_nCurrentFrame - m_nStartFrame,
                        n264, n268);
      end;

      106:begin //È²±ÝÀÌ¹«±â //#### È¯¹Ì·æ»ç, Ã»¿µ»ç
        AttackEffectSurface := g_WMonImagesArr[22].GetCachedImage (
                        2900 + m_nCurrentFrame-m_nStartFrame,
                        n264, n268);
      end;
      107:   begin //È£±â¿¬(¼Ò)
        AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                        1540 + m_nCurrentFrame-m_nStartFrame, n264, n268);
      end;
      108:   begin //È£±â¿¬(´ë)
        AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                        1650 + m_nCurrentFrame-m_nStartFrame, n264, n268);
      end;

      216:   begin //±¸½½
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                        3540 + m_nCurrentFrame-m_nStartFrame, n264, n268);
      end;
      217:   begin //±¸½½
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                        3680 + m_nCurrentFrame-m_nStartFrame, n264, n268);
      end;
      218:   begin //±¸½½
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                        3810 + m_nCurrentFrame-m_nStartFrame, n264, n268);
      end;

      46,111,112:  begin //ºñ¿ù¿©¿ìÁ×´Â ÀÓÆåÆ®  ºñ¿ùÀûÈ£, ºñ¿ù¼ÒÈ£
        AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                        340 + m_nCurrentFrame-m_nStartFrame, n264, n268);
         if (m_nCurrentFrame - m_nStartFrame ) = 0 then PlaySound (10420);
      end;


      134: begin //¿ªÃµ±Í
        AttackEffectSurface := g_WMonImagesArr[31].GetCachedImage (
                        5240  + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);

      end;
      137: begin //ÇÑÃµ±Í
        AttackEffectSurface := g_WMonImagesArr[32].GetCachedImage (
                        980 + (m_btDir * 10) + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);

      end;

      159: begin //¼®¸¶¼ö
        AttackEffectSurface := g_WMonImagesArr[25].GetCachedImage (
                        3580 + (m_btDir * 20) + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);

      end;

      187: begin //°¢¼¶
        AttackEffectSurface := g_WMonImagesArr[35].GetCachedImage (
                        1010 + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);
      end;

      190: begin  //¶¥µÎ²¨ºñ
        AttackEffectSurface := g_WMonImagesArr[35].GetCachedImage (
                        3620 + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);
      end;

      1,2,100,119,126,135,139..144,147,158,164..167,   //¾îÃ¢ÀÎ  ,¾î¹ýÀÎ ,¾î¿ùÀÎ  ,Åä°ß ,È£Åä°ß  ,ÀÎ¿ë , ÀÇÀÎÃæ , ÀÎ°£¼ö, ¹®Á¶ÀÎ ,ÀÛÀº»Ô¼­¿ìÀÎ
      169,174,176,177,180..184,188,191..194: begin    //ÈæÃµ±Í ,±¤ÇÑ½Ã, ¹é»ó, ÈæÈ£, ¹éÈ£, Èæ¼º¼º , ¼­¿ì ,¾ß°ø¼öÈ£±Í
       bo260 := False;    //Á×À½ ÀÌÆÑ x
       m_boUseEffect := False;
      end;

      152: EffectBSurface := nil;
    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of
        1:  begin //°ËÀºÈæ¼º¼º
          case m_nCurrentAction of
            SM_LIGHTING: begin //close range attack
              n26C := g_WMonImagesArr[36].GetCachedImage (
                            5060 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        2:  begin //ÀÌµÎÈæÈ£
          case m_nCurrentAction of
            SM_LIGHTING: begin
              n26C := g_WMonImagesArr[36].GetCachedImage (
                            5630 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;

        56: begin //¼öÈ£±Í»ç
          case m_nCurrentAction of
            SM_LIGHTING: begin //close range attack
              n26C := g_WMonImagesArr[30].GetCachedImage (
                            4091 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        58: begin  //È¯»ç ¼ÒÈ¯
             case m_nCurrentAction of
               SM_HIT: begin   
                  m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin   //È¯»ç µ¶¹«
                n26C := g_WMonImagesArr[30].GetCachedImage (
                            5221 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_1: begin
                n26C := g_WMonImagesArr[30].GetCachedImage (
                            5141 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
         end;

        59: begin //ºñÈ£±Í¸¶
          case m_nCurrentAction of
            SM_LIGHTING: begin //close range attack
              n26C := g_WMonImagesArr[30].GetCachedImage (
                            5812 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;


        70: begin //¹Ý¾ß¿ì»ç
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[20].GetCachedImage (
                            2230 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        71: begin
          case m_nCurrentAction of    //¹Ý¾ßÁÂ»ç
            SM_HIT: begin //close range attack
              n26C := g_WMonImagesArr[20].GetCachedImage (
                            2780 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_LIGHTING:begin
            n26C := g_WMonImagesArr[20].GetCachedImage (
                            2960 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;
        72: begin       //»ç¿ìÃµ¿Õ
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[20].GetCachedImage (
                            3490 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        78: begin
          if m_nCurrentAction = SM_HIT then begin         //ÆÄÈ²¸¶½Å
            n26C := g_WMonImagesArr[21].GetCachedImage (
                            3440 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        100: begin //¾ß¼ö¿Õ
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[22].GetCachedImage (
                            5372 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;

          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[22].GetCachedImage (
                            5292 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;

          if m_nCurrentAction = SM_LIGHTING_2 then begin
            n26C := g_WMonImagesArr[22].GetCachedImage (
                            5450 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;

        end;

        105: // °Å¹Ì
            begin
                if m_nCurrentAction = SM_LIGHTING then begin
                   m_boUseEffect := TRUE;
                   n26C := g_WMonImagesArr[22].GetCachedImage (
                      2230 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart, ax, ay);
                end
                else m_boUseEffect := False;
            end;

        106: //ÀÌ¹«±â
             if m_nCurrentAction in [SM_LIGHTING, SM_LIGHTING_1] then begin
                   m_boUseEffect := TRUE;
                   n26C := g_WMonImagesArr[22].GetCachedImage (
                      2820 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart, ax, ay);
             end else m_boUseEffect:= False;
        107: //È£±â¿¬ ÀÓÆåÆ®
             begin
                if not bo260 then begin
                   m_dwEffectFrameTime := m_dwFrameTime;
                   n26C := g_WMonImagesArr[23].GetCachedImage (
                      1500 + m_nCurrentFrame, ax, ay);
                end;
             end;

        108: //È£±â¿Á ÀÓÆåÆ®
             begin
                if not bo260 then begin

                   m_dwEffectFrameTime := m_dwFrameTime;
                   n26C := g_WMonImagesArr[23].GetCachedImage (
                      1610 + m_nCurrentFrame, ax, ay);
                end;
             end;

        216: //±¸½½
             begin
                if (not bo260) then begin
                   m_dwEffectFrameTime := m_dwFrameTime;
                   n26C := g_WMonImagesArr[37].GetCachedImage (
                      3510 + m_nCurrentFrame, ax, ay);
                end;
             end;
        217: //±¸½½
             begin
                if (not bo260) then begin
                   m_dwEffectFrameTime := m_dwFrameTime;
                   n26C := g_WMonImagesArr[37].GetCachedImage (
                      3650 + m_nCurrentFrame, ax, ay);
                end;
             end;
        218: //±¸½½
             begin
                if (not bo260) then begin
                   m_dwEffectFrameTime := m_dwFrameTime;
                   n26C := g_WMonImagesArr[37].GetCachedImage (
                      3780 + m_nCurrentFrame, ax, ay);
                end;
             end;

        109: begin  //Àü»çºñ¿ù¿©¿ì Å©¸®Æ¼ÄÃ ÀÓÆåÆ®
             if  m_nCurrentAction = SM_LIGHTING then begin
                AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                   350 + (m_btDir * 10) + m_nCurrentFrame-m_nEffectStart, ax, ay);
             end;
        end;
        112: begin  //µµ»çºñ¿ù¿©¿ì ¼ÒÈ¯ ÀÓÆåÆ®
             if  m_nCurrentAction = SM_LIGHTING_2 then begin
                AttackEffectSurface := g_WMagic2Images.GetCachedImage (m_nCurrentFrame, ax, ay);
             end;
        end;

        119: begin //¼­±«
          case m_nCurrentAction of
            SM_HIT: begin //close range attack
              n26C := g_WMonImagesArr[13].GetCachedImage (
                            2320 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        120: begin //±¤¼­±«
          case m_nCurrentAction of
            SM_HIT: begin //close range attack
              n26C := g_WMonImagesArr[13].GetCachedImage (
                            2910 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        134: begin //¿ªÃµ±Í
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[31].GetCachedImage (
                            5082 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[31].GetCachedImage (
                            5160 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        135: begin //ÈæÃµ±Í
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[31].GetCachedImage (
                            5851 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[31].GetCachedImage (
                            5930 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        137: begin //ÇÑÃµ±Í
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            890 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            970 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        139: begin //±¤ÇÑ½Ã
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            1851 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_2 then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            1930 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        140: begin //¹é»ó
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            2530 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        141: begin //³²¸¸ÈæÈ£
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            2981 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        142: begin //³²¸¸¹éÈ£
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            3501 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        143: begin //Èæ¼º¼º
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            4019 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        144: begin //¼­¿ì
          if m_nCurrentAction = SM_HIT then begin
                  m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            4630 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_2 then begin
            n26C := g_WMonImagesArr[32].GetCachedImage (
                            4620 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        147: begin //¾ß°ø¼öÈ£±Í
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[29].GetCachedImage (
                            1850 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[29].GetCachedImage (
                            1870 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;
        152: // ¿ùÁö °Å¹Ì
            begin
                if m_nCurrentAction = SM_LIGHTING then begin
                   m_boUseEffect := TRUE;
                   n26C := g_WMonImagesArr[26].GetCachedImage (
                      2200 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart, ax, ay);
                end
                else m_boUseEffect := False;

                EffectBSurface := g_WEffectImg.GetCachedImage (600, ex, ey);
            end;

        164: begin //°ÝÅõ±ªÀÌ
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            338 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        165: begin //ºÒ±ªÀÌ
          if m_nCurrentAction = SM_HIT then begin
             m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            850 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        166: begin //Ã¢±ªÀÌ
          if m_nCurrentAction = SM_HIT then begin
             m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            1358 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        167: begin //¾ó·è¸ÁÄ¡±ªÀÌ
          if m_nCurrentAction = SM_HIT then begin
             m_boUseEffect:= False;
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            1850 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        169: begin //°©±ªÀÌ
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            4190 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            4350 + (m_btDir * 20) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_2 then begin
            n26C := g_WMonImagesArr[33].GetCachedImage (
                            4110 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;


        174: begin //ÀÎ¸é¼ö
          if m_nCurrentAction = SM_HIT then begin
             n26C := g_WMonImagesArr[5].GetCachedImage (
                            3082 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        176: begin //È£ÁßÃµ
          if m_nCurrentAction = SM_HIT then begin        //ÁÖº¯°ø°Ý
             n26C := g_WMonImagesArr[34].GetCachedImage (
                            560 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin   //1ÀÎ°ø°Ý
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            570 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_2 then begin     //¿ø°Å¸®
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            650 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_3 then begin    //¹Ð¾î³»±â
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            840 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        177: begin //Áø¹¦Àå±º
          if m_nCurrentAction = SM_HIT then begin        //ÀÏ¹Ý°ø°Ý
             n26C := g_WMonImagesArr[34].GetCachedImage (
                            1420 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING then begin   //1ÀÎ°ø°Ý
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            1500 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_2 then begin     //¿ø°Å¸® ¹ø°³
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            840 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
          if m_nCurrentAction = SM_LIGHTING_3 then begin     //²¿ºÀ¼ÒÈ¯
            n26C := g_WMonImagesArr[34].GetCachedImage (
                            1600 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;

        181: begin  //¾î¹ýÀÎ   - ¹°°ø°Ý
          case m_nCurrentAction of
            SM_HIT: begin
               m_boUseEffect:= False;
            end;
            SM_LIGHTING: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            3820 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        182: begin  //¾î¿ùÀÎ
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            4390 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_LIGHTING: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            4470 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        183: begin //Åä°ß
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            5208 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_LIGHTING: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            5290 + (m_btDir * 20) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;
        184: begin //È£Åä°ß
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[34].GetCachedImage (
                            6268 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_LIGHTING: begin
              m_boUseEffect:= False;
            end;
          end;
        end;

        188: begin //ÀÎ¿ë
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[35].GetCachedImage (
                            1740 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_LIGHTING: begin
              n26C := g_WMonImagesArr[35].GetCachedImage (
                            1820 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        193: begin //¹®Á¶ÀÎ
          if m_nCurrentAction = SM_HIT then begin
            m_boUseEffect:= False;
          end;

          if m_nCurrentAction = SM_LIGHTING then begin
            m_boUseEffect:= False;
          end;

          if m_nCurrentAction = SM_LIGHTING_2 then begin
            n26C := g_WMonImagesArr[35].GetCachedImage (
                            5270 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;

        end;


        194: begin //ÀÛÀº»Ô¼­¿ìÀÎ
          if m_nCurrentAction = SM_HIT then begin
            n26C := g_WMonImagesArr[35].GetCachedImage (
                            5770 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;

          if m_nCurrentAction = SM_LIGHTING then begin
            n26C := g_WMonImagesArr[35].GetCachedImage (
                            5850 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
          end;
        end;




      end;
    end;
  end;
end;

procedure TBanyaGuardMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       if m_btRace = 106 then SitDown := False;
       Shift (m_btDir, 0, 0, 1);
       if m_btRace in [107,108,216,217,218] then m_nStartFrame := pm.ActAttack.start
       else
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       if m_btRace = 105 then m_dwFrameTime := 130; //°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
       if m_btRace = 106 then m_dwFrameTime := 100;
       if m_btRace = 152 then m_dwFrameTime := 120; //°Å¹Ì(½Å¼®µ¶¸¶ÁÖ) ÇÁ·¹ÀÓ¼Óµµ
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;

       if m_btRace in [46,111,112] then  m_boUseEffect := False     //ºñ¿ùÀûÈ£
       else m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;

       if m_btRace in [216] then begin
         m_boUseEffect := TRUE;
         m_BoUseMagic := False;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
         m_nEffectFrame := 3520;
         m_nEffectStart := 3520;
         m_nEffectEnd := 3526;
       end;
       if m_btRace in [217] then begin
         m_boUseEffect := TRUE;
         m_BoUseMagic := False;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
         m_nEffectFrame := 3660;
         m_nEffectStart := 3660;
         m_nEffectEnd := 3666;
       end;
       if m_btRace in [218] then begin
         m_boUseEffect := TRUE;
         m_BoUseMagic := False;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
         m_nEffectFrame := 3790;
         m_nEffectStart := 3790;
         m_nEffectEnd := 3796;
       end;    

       if m_btRace = 147 then begin    //¾ß°ø¼öÈ£±Í
         PlaySound (3146);
       end;

       if m_btRace = 158 then begin    //Á¶ÀÎ»ó
         PlaySound (2798);
       end;

       if m_btRace = 164 then begin    //°ÝÅõ±ªÀÌ
         PlaySound2 (fightcat_att);
       end;

       if m_btRace = 165 then begin    //ºÒ±ªÀÌ
         PlaySound2 (firecat_att);
       end;

       if m_btRace = 166 then begin    //Ã¢±ªÀÌ
         PlaySound2 (spearcat_att);
       end;

       if m_btRace = 169 then begin    //°©±ªÀÌ
         PlaySound2 (armorcat_att2);
       end;

       if m_btRace = 159 then begin  //¼®¸¶¼ö
         PlaySound (2786);
       end;

       if m_btRace = 100 then begin  //¾ß¼ö¿Õ
         PlaySound (2497);
       end;

       if m_btRace = 176 then begin  //È£ÁßÃµ
         PlaySound (3602);
       end;

       if m_btRace = 190 then begin  //¶¥µÎ²¨ºñ
         PlaySound (3756);
       end;

     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin

       if m_btRace =106 then SitDown := False; //ÀÌ¹«±â
       if m_btRace in [107,108,216,217,218] then  m_nStartFrame:= pm.ActCritical.start
       else
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_nCurEffFrame:=0;
       m_boUseEffect := TRUE;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);


      if (m_btRace in [46,111]) then begin //Àü»çºñ¿ù¿©¿ì,¼ú»çºñ¿ù¿©¿ì Å©¸®Æ¼ÄÃ µ¿ÀÛ °ø°Ýµ¿ÀÛÀ¸·Î      //ºñ¿ùÀûÈ£
        m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
        m_nEndFrame   := m_nStartFrame + pm.ActAttack.frame - 1;
        m_dwFrameTime  := pm.ActAttack.ftime;
        m_dwStartTime  := GetTickCount;
      end;

      if (m_btRace <> 70) then begin //this hopefully fixes deva , 78 = omaking he's the only mob that uses this that CANT do effect while casting magic
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else
       if m_btRace in [105,152] then begin //New°Å¹Ì ¸¶¹ý ÀÓÆåÆ®
         m_boUseEffect := TRUE;
         m_nEffectFrame := 420 + m_btDir * 10;
         m_nEffectStart := m_nEffectFrame;
         m_nEffectEnd   := m_nEffectFrame+9;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end
       else if m_btRace = 106 then begin // ÀÌ¹«±â
         m_boUseEffect := TRUE;
         m_nEffectFrame := 500 + m_btDir * 10;
         m_nEffectStart := m_nEffectFrame;
         m_nEffectEnd   := m_nEffectFrame+5;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else
       if (m_btRace in [71,57]) then begin //¹Ý¾ß ÁÂ»ç¸¸ ÀÌÆåÆ®°¡ ÀÖÀ½
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd   := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else
       if m_btRace in [107,108] then begin
         m_boUseEffect := TRUE;
         m_BoUseMagic := False;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
         if m_btRace = 107 then
          PlaySound (2552);
          m_nEffectFrame := 1520;
          m_nEffectStart := 1520;
          m_nEffectEnd := 1529;
          if m_btRace = 108 then begin
            PlaySound (2562);
            m_nEffectFrame := 1630;
            m_nEffectStart := 1630;
            m_nEffectEnd := 1639;
          end;
       end;

       if m_btRace = 1 then PlaySound (3876);  //°ËÀºÈæ¼º¼º
       if m_btRace = 2 then PlaySound (3886);  //ÀÌµÎÈæÈ£

       if m_btRace = 140 then begin //¹é»ó
        PlaySound (3446);
       end;
       if m_btRace = 141 then begin //³²¸¸ÈæÈ£
        PlaySound (3456);
       end;
       if m_btRace = 142 then begin //³²¸¸¹éÈ£
        PlaySound (3466);
       end;
       if m_btRace = 143 then begin //Èæ¼º¼º
        PlaySound (3476);
       end;
       if m_btRace = 144 then begin //¼­¿ì
        PlaySound (3486);
       end;
       if m_btRace = 147 then begin  //¾ß°ø¼öÈ£±Í
        PlaySound (3148);
       end;
       if m_btRace = 158 then begin  //Á¶ÀÎ»ó
        PlaySound (2796);
       end;
       if m_btRace = 165 then begin  //ºÒ±ªÀÌ
        PlaySound2 (firecat_att2);
       end;
       if m_btRace = 166 then begin  //Ã¢±ªÀÌ
        PlaySound2 (spearcat_att2);
       end;
       if m_btRace = 167 then begin  //¾ó·è¸ÁÄ¡±ªÀÌ
        PlaySound2 (hammercat_att);
       end;
       if m_btRace = 169 then begin    //°©±ªÀÌ
        PlaySound2 (armorcat_att3);
       end;


       if m_btRace = 100 then begin    //¾ß¼ö¿Õ
        PlaySound (2497);
       end;
       if m_btRace = 176 then begin  //È£ÁßÃµ
         PlaySound (3607);
       end;

       if m_btRace = 190 then begin  //¶¥µÎ²¨ºñ
         PlaySound (3757);
       end;

       if m_btRace = 191 then begin  //ÀÇÀÎÃæ
         PlaySound (3766);
       end;
       if m_btRace = 193 then begin  //¹®Á¶ÀÎ
         PlaySound (3786);
       end;

       if m_btRace = 194 then begin  //ÀÛÀº»Ô¼­¿ìÀÎ
         PlaySound (3796);
       end;

       if m_btRace = 78 then
        m_boUseEffect:=FALSE;
     end;
     SM_LIGHTING_2:
         begin
             if m_btRace in [100,176,177,193] then begin
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              if m_btRace = 100 then begin
               PlaySound (2498);
              end;
              if m_btRace = 176 then begin  //È£ÁßÃµ
               PlaySound (3608);
              end;
              if m_btRace = 177 then begin  //Áø¹¦Àå±º
               PlaySound (3617);
              end;
              if m_btRace = 193 then begin  //¹®Á¶ÀÎ
                 PlaySound (3787);
              end;
            end;

            if m_btRace = 112 then begin  //ºñ¿ù¼ÒÈ£

               m_nStartFrame := 420 + m_btDir * 10;
               m_nEndFrame   := m_nStartFrame + 9;
               m_dwFrameTime  := pm.ActCritical.ftime;
               m_dwStartTime  := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               Shift (m_btDir, 0, 0, 1);

               m_boUseEffect := TRUE;
               m_nEffectFrame := 0;
               m_nEffectStart := 0;
               m_nEffectEnd   := 10;
               m_dwEffectStartTime := GetTickCount;
               m_dwEffectFrameTime := m_dwFrameTime;
               PlaySound (2528);
            end;
            if (m_btRace = 139) then begin //±¤ÇÑ½Ã
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound (3436);
            end;

            if m_btRace = 140 then begin //¹é»ó
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound (3448);
            end;

            if m_btRace = 144 then begin //¼­¿ì
              m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
              m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
              m_dwFrameTime := pm.ActAttack.ftime;
              m_dwStartTime := GetTickCount;
              m_dwWarModeTime := GetTickCount;

              m_nCurEffFrame:=0;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound (3482);
            end;

            if m_btRace = 159 then begin //¼®¸¶¼ö
              m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
              m_dwFrameTime := pm.ActCritical.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound (2788);
            end;

            if m_btRace = 169 then begin //°©±ªÀÌ
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound2 (armorcat_att);
            end;

         end;
    SM_LIGHTING_3:
         begin
           if m_btRace = 100 then begin //¾ß¼ö¿Õ
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              PlaySound (2497);
            end;

            if m_btRace in [176,177] then begin //È£ÁßÃµ
              m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
              m_dwFrameTime := pm.ActCritical3.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;
              if m_btRace = 176 then begin  //È£ÁßÃµ
               PlaySound (3609);
              end;
              if m_btRace = 177 then begin  //Áø¹¦Àå±º
               PlaySound (3619);
              end;
            end;

         end;

     else begin
       inherited CalcActorFrame;
     end;
   end;

end;


procedure TBanyaGuardMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff : TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin      //¾ß¼ö¿Õ
           if m_btRace in [100,159] then begin //¼®¸¶¼ö  ¾ß¼ö¿Õ
             if Not LightningTimer.Enabled then begin
                  LightningTimer.Enabled := True;
             end;
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 1)then begin      //¼®¸¶¼ö
           if m_btRace in [100,159] then begin //¼®¸¶¼ö  ¾ß¼ö¿Õ
             if Not LightningTimer.Enabled then begin
                  LightningTimer.Enabled := True;
             end;
           end;
           if m_btRace = 176 then begin //È£ÁßÃµ
             meff := TFlyingFireBall (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mt12));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[34];
               meff.NextFrameTime := 120;
               meff.FlyImageBase:=670;
            end;
           end;

         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin
            if m_btRace = 58 then begin
                PlaySound(3277);
            end;

            if (m_btRace = 57) then begin //ºù¿°±ÍÀå
              PlayScene.NewMagic (Self,1,39,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,False,30,bo11);
              PlaySound(10391);
            end;

            if(m_btRace = 106) then begin    //ÀÌ¹«±â ¸êÃµÈ­
                PlayScene.NewMagic (self,
                                      MAGIC_SERPENT_1,
                                      MAGIC_SERPENT_1,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,       //TargetX,
                                      m_nTargetY,       //TargetY,
                                      m_nTargetRecog,  //TargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (159);
                PlaySound (2449);//8101
            end;

            if (m_btRace in [46,111]) then begin    //¼ú»çºñ¿ù¿©¿ì:È­¿°     //ºñ¿ùÀûÈ£
                PlayScene.NewMagic (self,
                                      MAGIC_FOX_FIRE1,
                                      MAGIC_FOX_FIRE1,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (2517);
            end;

            if(m_btRace = 112) then begin    //µµ»çºñ¿ù¿©¿ì:ÀúÁÖ¼ú
                PlayScene.NewMagic (self,
                                      MAGIC_FOX_CURSE,
                                      MAGIC_FOX_CURSE,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtExploBujauk,
                                      FALSE,
                                      30,
                                      bo11);
               m_nmagicfiresound  := 10131;
               m_nmagicexplosionsound := 2527;
            end;
         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

             if (m_btRace = 70) then begin //¹Ý¾ß¿ì»ç
               PlayScene.NewMagic (Self,7,9,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,False,30,bo11);
               PlaySound(10112);
             end;
             if (m_btRace = 71) then begin  //¹Ý¾ßÁÂ»ç
               PlayScene.NewMagic (Self,1,1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
               PlaySound(10012);
             end;
             if (m_btRace = 72) then begin    //»ç¿ìÃµ¿Õ
               PlayScene.NewMagic (Self,11,32,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mt13,False,30,bo11);
               PlaySound(2276);
             end;
             if (m_btRace = 78) then begin   //ÆÄÈ²¸¶½Å
               FrmMain.UseNormalEffect (NE_OMAKING, self.m_nCurrX, self.m_nCurrY);
               PlaySound(2396);
             end;
             if (m_btRace = 81) then begin    //¿ù·É °­°Ý
               PlayScene.NewMagic (Self,7,9,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,False,30,bo11);
               PlaySound(10112);
             end;
             if (m_btRace = 82) then begin    //È¥·É ¾Ï¿¬¼ú
               PlayScene.NewMagic (Self,1,4,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,False,30,bo11);
               PlaySound(10062);
             end;

             if (m_btRace in [105,152]) then begin
               PlaySound (2437);  //°Å¹Ì
             end;
             if m_btRace = 192 then begin       //ÀÎ°£¼ö
                 PlayScene.NewMagic (self, MAGIC_FIREEXPLOSIN2, MAGIC_FIREEXPLOSIN2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
                 PlaySound (3776);
             end;

             if m_btRace = 167 then begin       //¾ó·è¸ÁÄ¡±ªÀÌ
                 PlayScene.NewMagic (self, MAGIC_HAMMERCAT,MAGIC_HAMMERCAT,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
                 PlaySound (2526);
             end;

             if(m_btRace = 58) then begin    //È¯»ç±ÍÀå µ¶¹«
                PlayScene.NewMagic (self,
                                      92,
                                      92,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mt13,
                                      FALSE,
                                      120,
                                      bo11);
               PlaySound(10553);
               PlaySound(3278);
            end;

            if(m_btRace = 111) then begin    //¼ú»çºñ¿ù¿©¿ì : °­°Ý     //ºñ¿ùÀûÈ£
                PlayScene.NewMagic (self,
                                      MAGIC_FOX_THUNDER, //11,
                                      MAGIC_FOX_THUNDER,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (2516);
            end;


            if (m_btRace = 46) then begin    //¼ú»çºñ¿ù¿©¿ì : ³«¿°   //°í´ëºñ¿ùÀûÈ£
               PlayScene.NewMagic (self,80,80,
               m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,
               m_nTargetRecog,mtFireShower,False,400,bo11);
               PlaySound (10533);
            end;


            if(m_btRace = 135) then begin    //ÈæÃµ±Í
                PlayScene.NewMagic (self,
                                      MAGIC_DARK_THUNDER, //11,
                                      MAGIC_DARK_THUNDER,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (3396);
            end;
            if(m_btRace = 112) then begin    //µµ»çºñ¿ù¿©¿ì:Æø»ì°è
                PlayScene.NewMagic (self,
                                      MAGIC_FOX_FIRE2,
                                      MAGIC_FOX_FIRE2,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtExploBujauk,
                                      FALSE,
                                      30,
                                      bo11);
               m_nmagicstartsound := 10130;
               m_nmagicfiresound  := 10131;
               m_nmagicexplosionsound := 2526;
            end;

             if(m_btRace = 126) then begin    //°©Ã¶±Í¼ö: ¹°°ø°Ý
                PlayScene.NewMagic (self,
                                      MAGIC_TURTLE_WARTERATT,
                                      MAGIC_TURTLE_WARTERATT,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtFly,
                                      TRUE,
                                      30,
                                      bo11);
                PlaySound (2374);
            end;
           end;

         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if m_btRace in [107,108,216,217,218] then begin //È£±â¿¬ È£±â¿Á
         if GetTickCount - m_dwDefFrameTime > 150 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end
      else
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;



procedure TBanyaGuardMon.LightningTimerTimer(Sender: TObject);
var
   tx, ty, n, kx, ky : integer;
   bofly: Boolean;
begin
   if m_btRace = 159 then begin  //¼®¸¶¼ö

       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 10;
          Exit;
       end;
       tx := g_Myself.m_nCurrX;
       ty := g_Myself.m_nCurrY;

       n := random(4);
       kx := random(7);
       ky := random(5);

       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_1, MAGIC_MILSTONE_ATT3_1, m_nCurrX, m_nCurrY, tx+kx, ty+ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_2, MAGIC_MILSTONE_ATT3_2, m_nCurrX, m_nCurrY, tx+kx-2, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_3, MAGIC_MILSTONE_ATT3_3, m_nCurrX, m_nCurrY, tx+kx, ty+ky-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_4, MAGIC_MILSTONE_ATT3_4, m_nCurrX, m_nCurrY, tx-kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_5, MAGIC_MILSTONE_ATT3_5, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);

          LightningTimer.Interval := 500;
       end
       else if LightningTimer.Tag = 2 then begin
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_1, MAGIC_MILSTONE_ATT3_1, m_nCurrX, m_nCurrY, tx+kx-2, ty-ky-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_2, MAGIC_MILSTONE_ATT3_2, m_nCurrX, m_nCurrY, tx+kx+2, ty+ky-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_3, MAGIC_MILSTONE_ATT3_3, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_4, MAGIC_MILSTONE_ATT3_4, m_nCurrX, m_nCurrY, tx-kx, ty+ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_5, MAGIC_MILSTONE_ATT3_5, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);

       end;

       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_5, MAGIC_MILSTONE_ATT3_5, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_1, MAGIC_MILSTONE_ATT3_1, m_nCurrX, m_nCurrY, tx-kx-2, ty+ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_2, MAGIC_MILSTONE_ATT3_2, m_nCurrX, m_nCurrY, tx-kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_3, MAGIC_MILSTONE_ATT3_3, m_nCurrX, m_nCurrY, tx+kx+2, ty+ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_4, MAGIC_MILSTONE_ATT3_4, m_nCurrX, m_nCurrY, tx+kx, ty, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_MILSTONE_ATT3_5, MAGIC_MILSTONE_ATT3_5, m_nCurrX, m_nCurrY, tx-kx, ty, 0, mtThunder, FALSE, 30, bofly);


       if LightningTimer.Tag = 4 then PlaySound (2789); //ÃÊÇÊ»ç±â
       LightningTimer.Interval := LightningTimer.Interval + 100;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 10;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
   end;


   if m_btRace = 100 then begin  //¾ß¼ö¿Õ

       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 10;
          Exit;
       end;
       tx := g_Myself.m_nCurrX;
       ty := g_Myself.m_nCurrY;

       n := random(4);
       kx := random(7);
       ky := random(5);

       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_1, MAGIC_WILDATTACK_ATT3_1, m_nCurrX, m_nCurrY, tx+2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_3, MAGIC_WILDATTACK_ATT3_3, m_nCurrX, m_nCurrY, tx-2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_4, MAGIC_WILDATTACK_ATT3_4, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_5, MAGIC_WILDATTACK_ATT3_5, m_nCurrX, m_nCurrY, tx-2, ty-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_6, MAGIC_WILDATTACK_ATT3_6, m_nCurrX, m_nCurrY, tx+2, ty-2, 0, mtThunder, FALSE, 30, bofly);

          LightningTimer.Interval := 500;
       end
       else if LightningTimer.Tag = 2 then begin
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_1, MAGIC_WILDATTACK_ATT3_1, m_nCurrX, m_nCurrY, tx+2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_3, MAGIC_WILDATTACK_ATT3_3, m_nCurrX, m_nCurrY, tx-2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_4, MAGIC_WILDATTACK_ATT3_4, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_5, MAGIC_WILDATTACK_ATT3_5, m_nCurrX, m_nCurrY, tx-2, ty-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_6, MAGIC_WILDATTACK_ATT3_6, m_nCurrX, m_nCurrY, tx+2, ty-2, 0, mtThunder, FALSE, 30, bofly);

       end;

       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_1, MAGIC_WILDATTACK_ATT3_1, m_nCurrX, m_nCurrY, tx+2, ty+2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_3, MAGIC_WILDATTACK_ATT3_3, m_nCurrX, m_nCurrY, tx-2, ty+2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_4, MAGIC_WILDATTACK_ATT3_4, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_5, MAGIC_WILDATTACK_ATT3_5, m_nCurrX, m_nCurrY, tx-2, ty-2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_6, MAGIC_WILDATTACK_ATT3_6, m_nCurrX, m_nCurrY, tx+2, ty-2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_WILDATTACK_ATT3_2, MAGIC_WILDATTACK_ATT3_2, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);


       if LightningTimer.Tag = 4 then PlaySound (2499); //ÃÊÇÊ»ç±â
       LightningTimer.Interval := LightningTimer.Interval + 100;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 10;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
   end;

end;

procedure TBanyaGuardMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
  end;
end;

procedure TBanyaGuardMon.DrawBackEff(dsurface: TDirectDrawSurface; dx,
  dy: Integer);
var
  idx: integer;
  d: TDirectDrawSurface;
begin
  inherited;
  if g_BoEffect then begin
    if (EffectBSurface <> nil) then begin
      DrawBlend(dsurface, dx + ex + m_nShiftX, dy + ey + m_nShiftY, EffectBSurface, 1);
    end;
  end;
  if m_nState and $00000800 <> 0 then begin   //Ç÷·æ¼ö
    idx := BLOODWATER {+ (m_nGenAniCount mod 2)};
    d := g_WMagic3Images.GetCachedImage (idx, ax, ay);
    if d <> nil then
      DrawBlend (dsurface, dx + ax + m_nShiftX, dy + ay + 100 + m_nShiftY, d, 1);
  end;
end;












{ TShineCaveMon }

constructor TShineCaveMon.Create;
begin
  inherited Create;
  n26C:=nil;
  n27C:=nil;
  EffectBSurface  := nil;
  EffectPront := nil;
end;

destructor TShineCaveMon.Destroy;
begin
   inherited Destroy;
   n26C:=nil;
   n27C:=nil;
   EffectBSurface  := nil;
   EffectPront := nil;
end;

procedure TShineCaveMon.LoadSurface;
begin
  inherited;

  if m_btRace = 7 then begin   //ÁÖ¸¶¼ú»ç
    EffectPront := g_WMonImagesArr[40].GetCachedImage (560 +  m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 27 then begin   //ÁÖ¸¶°Ë»ç
    EffectPront := g_WMonImagesArr[40].GetCachedImage (3520 +  m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 221 then begin   //º¯ÀÌ°©Ãæ
    EffectPront := g_WMonImagesArr[38].GetCachedImage (1060 +  m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 231 then begin   //º¯ÀÌµÈ°¨½Ãº´
    EffectPront := g_WMonImagesArr[39].GetCachedImage (1900 +  m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 233 then begin   //¾ÏÈæ¼±Àå
    EffectPront := g_WMonImagesArr[39].GetCachedImage (3620 +  m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 263 then begin   //Çö¿ùÈ¯È£
    EffectPront := WMon42Img.GetCachedImage (1840 + m_nCurrentFrame, bx, by);
  end;
  if m_btRace = 284 then begin   //¼³¾Ç±Í
    EffectPront := g_WMonImagesArr[42].GetCachedImage (4150 + m_nCurrentFrame, bx, by);
    if (m_nCurrentAction = SM_DEATH) or (m_nCurrentAction = SM_NOWDEATH) then EffectPront := nil;
  end;
  if m_btRace = 285 then begin   //¾Ç±Í
    EffectPront := g_WMonImagesArr[42].GetCachedImage (5060 + m_nCurrentFrame, bx, by);
  end;
  if bo260 then begin   //Á×¾úÀ»¶§ ÀÌÆÑÆ® Ç¥½ÃÇÏ´Â°Íµé,
    case m_btRace of
      3: begin      //¿©±Í
        AttackEffectSurface := g_WMonImagesArr[39].GetCachedImage ( 5330 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      5: begin      //ÀÛÀº´ë¸Á
        AttackEffectSurface := g_WMonImagesArr[39].GetCachedImage ( 7380 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      6: begin      //´ë¸Á
        AttackEffectSurface := g_WMonImagesArr[39].GetCachedImage ( 6877 + (m_btDir * 10) + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      28: begin      //¿©±Í¼®
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage ( 4530 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      92: begin      //¹ÙÀ§ÆøÅº
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage ( 6978 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      263: begin    //Çö¿ùÈ¯È£
        AttackEffectSurface := g_WMonImagesArr[22].GetCachedImage ( 1790 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      264: begin    //°õ
        AttackEffectSurface := g_WMonImagesArr[41].GetCachedImage ( 2920 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      280: begin  //ºù¿ø±Í
        AttackEffectSurface := g_WMonImagesArr[42].GetCachedImage ( 1770 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      284: begin  //¼³¾Ç±Í
        AttackEffectSurface := g_WMonImagesArr[42].GetCachedImage ( 4547 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      285: begin  //¾Ç±Í
        AttackEffectSurface := g_WMonImagesArr[42].GetCachedImage ( 5640 + (m_btDir * 10) + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      287: begin  //¼³ÅÂ¶û
        AttackEffectSurface := g_WMonImagesArr[43].GetCachedImage ( 1410 + m_nCurrentFrame -m_nStartFrame, n264, n268);
      end;
      4,7,8,26,27,29,51,91, 203,204,205,206,207,208,220,221,222,225,
       226,227,228,229,230,231,232, 261,262,265,281,282,283, 286: begin    //ÅÂ±¸¿À¸¶ °Å±Ç¿À¸¶ ¿À¸¶Èæº´ ´Ù¸ñ¿À¸¶  ¿À¸¶Àûº´  ¿À¸¶Á¦»çÀå
        bo260 := False;    //Á×À½ ÀÌÆÑ x
        m_boUseEffect := False;
        EffectBSurface := nil;
      end;
    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of
        5, 28,92, 203, 206, 222, 232, 263, 265, 280, 282, 284:  begin //ÀÛÀº´ë¸Á, ÅÂ±¸¿À¸¶ ¿À¸¶Àûº´ Çö¿ùÈ¯È£ ºù¿ø±Í ¼³¾Ç±Í
           m_boUseEffect:= False;
        end;
        3 : begin      //¿©±Í
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            5150 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            5230 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        4 : begin      //ÅÂ°ñ¼­
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            5880 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        6 : begin      //´ë¸Á
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            6530 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            6620 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        7 : begin      //ÁÖ¸¶¼ú»ç
          case m_nCurrentAction of
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            1130 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            1140 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;

        8 : begin      //ÁÖ¸¶È­±Ã»ç
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            1640 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        26 : begin      //ÁÖ¸¶Ç³±Ã»ç
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            2600 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        27 : begin      //ÁÖ¸¶°Ë»ç
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            4080 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            4160 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            4240 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;

        29 : begin      //¸¶¼®°ÅÀÎ
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            5130 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
               if m_btDir = 7 then begin
                 n27C := g_WMonImagesArr[40].GetCachedImage (
                            5207 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end else begin
                 n27C := g_WMonImagesArr[40].GetCachedImage (
                            5207 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            5280 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        51 : begin      //°Ý±«Àå
          case m_nCurrentAction of
             SM_HIT: begin      //±âº»
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6020 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin     //µÎÄ­
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6100 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_1: begin   //ÀÏ¼¶
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6200 + (m_btDir * 10)+ m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin      //ÀüÃ¼°ø°Ý
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6180 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_3: begin    //¸ð·¡ÆøÇ³
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6190 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        91 : begin      //Ä®³¯¹Ù¶÷
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[40].GetCachedImage (
                            6690 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;


        204: begin   //°Å±Ç¿À¸¶
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[37].GetCachedImage (
                            480 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        205: begin   //¿À¸¶Èæº´
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[37].GetCachedImage (
                            1460 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        207: begin      //¿À¸¶Á¦»çÀå
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[37].GetCachedImage (
                            3340 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[37].GetCachedImage (
                            3440 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        208: begin   //´Ù¸ñ¿À¸¶
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[37].GetCachedImage (
                            970 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        220: begin   //±äÄÚ¿ø¼þÀÌ
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            550 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        221: begin   //º¯ÀÌ°©Ãæ
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            1460 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        225: begin   //±×À»¸°¿ä¸®»ç
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            2980 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        226: begin   //¶°µµ´Â¼±¿ø
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            3470 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        227: begin      //ÀÍ»çÇÑ³ë¿¹
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            4050 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            4130 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        228: begin      //¼±¹ÚÀÇ³ë¿¹
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            4700 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            4700 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            4780 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        229: begin   //³ó³ë±º
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            480 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            else m_boUseEffect:= False;
          end;
        end;
        230: begin      //°ÅÄ£¼±¸ñ
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            1150 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            1150 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        231: begin      //º¯ÀÌµÈ°¨½Ãº´
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            2300 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        233: begin      //¾ÏÈæ¼±Àå
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            4420 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            4520 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            4500 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_3: begin
              n26C := g_WMonImagesArr[39].GetCachedImage (
                            4560 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        261 : begin      //½£°ÅºÏÀÌ
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[41].GetCachedImage (
                            770 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        262 : begin      //½£°ÅºÏÀÌ
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[41].GetCachedImage (
                            1580 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[41].GetCachedImage (
                            1660 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[41].GetCachedImage (
                            1740 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        264 : begin      //°õ
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[41].GetCachedImage (
                            2840 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        281 : begin      //ºù¿ø±Íº´
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            2270 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            2350 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        283 : begin      //ºù¿ø±ÍÁ¸
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            3490 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            3570 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        285 : begin      //¾Ç±Í
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            5150 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[42].GetCachedImage (
                            5230 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        286 : begin      //¼³¶û
          case m_nCurrentAction of
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[43].GetCachedImage (
                            480 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;
        287: begin      //¼³ÅÂ¶û
          case m_nCurrentAction of
             SM_HIT: begin
              n26C := g_WMonImagesArr[43].GetCachedImage (
                            1140 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING: begin
              n26C := g_WMonImagesArr[43].GetCachedImage (
                            1220 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_2: begin
              n26C := g_WMonImagesArr[43].GetCachedImage (
                            1230 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
             SM_LIGHTING_3: begin
              n26C := g_WMonImagesArr[43].GetCachedImage (
                            1330 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
             end;
            else m_boUseEffect:= False;
          end;
        end;

      end;
    end;
  end;
end;

procedure TShineCaveMon.CalcActorFrame;
var
   pm: PTMonsterAction;
   Eff8:TNormalDrawEffect;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_TURN:
         begin
           if ((m_btRace = 261) or (m_btRace = 262)) and (m_nState and STATE_STONE_MODE <> 0) then begin
             m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
             m_nEndFrame := m_nStartFrame;
             m_dwFrameTime := pm.ActDeath.ftime;
             m_dwStartTime := GetTickCount;
             m_nDefFrameCount := pm.ActDeath.frame;
           end else begin
             m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
             m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
             m_dwFrameTime := pm.ActStand.ftime;
             m_dwStartTime := GetTickCount;
             m_nDefFrameCount := pm.ActStand.frame;
           end;
           Shift (m_btDir, 0, 0, 1);
         end;

     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);

       if (m_btRace in [4,5,6,7,28,92,203,204,205,206,208,220,221,226,232]) or (m_btRace = 261)
         or (m_btRace = 263) or (m_btRace = 264) or (m_btRace = 280)  or (m_btRace = 282) or (m_btRace = 284)
         or (m_btRace = 286)
       then  m_boUseEffect := False

       else m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;

       if m_btRace = 190 then begin  //¶¥µÎ²¨ºñ
         PlaySound (3756);
       end;
       if m_btRace = 264 then PlaySound(4322); //°õ
       if m_btRace = 265 then PlaySound(4332); //Ç¥¹ü
     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_nCurEffFrame:=0;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);

       if (not (m_btRace in [8,26,203,222,232])) and (not( m_btRace = 282)) and (not( m_btRace = 285))

       then begin
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end;
       if (m_btRace = 285) then begin  //¾Ç±Í
         Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[42],5620,10,80,True);
         if Eff8 <> nil then begin
           Eff8.MagOwner:=g_MySelf;
           PlayScene.m_EffectList.Add(Eff8);
         end;
       end;
       if m_btRace = 3 then PlaySound (4166);    //¿©±Í
       if m_btRace = 4 then PlaySound (4176);    //ÅÂ°ñ¼­
       if m_btRace = 6 then PlaySound (4186);    //´ë¸Á
       if m_btRace = 7 then PlaySound (4206);    //ÁÖ¸¶¼ú»ç
       if m_btRace = 8 then PlaySound (4216);    //ÁÖ¸¶È­±Ã»ç
       if m_btRace = 26 then PlaySound (4226);   //ÁÖ¸¶Ç³±Ã»ç
       if m_btRace = 27 then PlaySound (4236);   //ÁÖ¸¶°Ë»ç
       if m_btRace = 29 then PlaySound (4256);   //¸¶¼®°ÅÀÎ

       if m_btRace = 51 then PlaySound (4266);   //°Ý±«Àå

       if m_btRace = 203 then PlaySound (3896);  //ÅÂ±¸¿À¸¶
       if m_btRace = 204 then PlaySound (3906);  //°Å±Ç¿À¸¶
       if m_btRace = 205 then PlaySound (3922);  //¿À¸¶Èæº´
       if m_btRace = 206 then PlaySound (3836);  //¿À¸¶Àûº´
       if m_btRace = 207 then PlaySound (3846);  //¿À¸¶Á¦»çÀå
       if m_btRace = 208 then PlaySound (3912);  //´Ù¸ñ¿À¸¶
       if m_btRace = 220 then PlaySound (4022);  //±äÄÚ¿ø¼þÀÌ
       if m_btRace = 221 then PlaySound (4032);  //º¯ÀÌ°©Ãæ
       if m_btRace = 222 then PlaySound (4046);  //°ÅÀåÈ­
       if m_btRace = 226 then PlaySound (4072);  //¶°µµ´Â¼±¿ø
       if m_btRace = 227 then PlaySound (4086);  //ÀÍ»çÇÑ³ë¿¹
       if m_btRace = 228 then PlaySound (4096);  //¼±¹ÚÀÇ¾Ç·É
       if m_btRace = 229 then PlaySound (4106);  //³ó³ë±º
       if m_btRace = 230 then PlaySound (4112);  //°ÅÄ£¼±¸ñ
       if m_btRace = 232 then PlaySound (4146);  //È¥ºÒ
       if m_btRace = 233 then PlaySound (4157);  //¾ÏÈæ¼±Àå
       if m_btRace = 261 then PlaySound (4306);  //½£°ÅºÏÀÌ
       if m_btRace = 262 then PlaySound (4316);  //»ï³ª¹«Á¤¹é
       if m_btRace = 264 then  PlaySound(4326);  //°õ
       if m_btRace = 283 then PlaySound(4476);   //ºù¿ø±ÍÁ¸
       if m_btRace = 285 then PlaySound(4496);   //¾Ç±Í
       if m_btRace = 286 then PlaySound(4506);   //¼³¶û
       if m_btRace = 287 then PlaySound(4516);   //¼³ÅÂ¶û
       if (m_nCurrentAction = SM_LIGHTING_1) and (m_btRace = 51) then begin  //°Ý±«Àå ÀÏ¼¶
         m_nStartFrame := pm.ActCritical4.start + m_btDir * (pm.ActCritical4.frame + pm.ActCritical4.skip);
         m_nEndFrame := m_nStartFrame + pm.ActCritical4.frame - 1;
         m_dwFrameTime := pm.ActCritical4.ftime;
         m_dwStartTime := GetTickCount;
         m_nCurEffFrame:=0;
         m_dwWarModeTime := GetTickCount;
         Shift (m_btDir, 0, 0, 1);
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
         if m_btRace = 51 then PlaySound (4269);   //°Ý±«Àå ÀÏ¼¶
       end;
     end;
     SM_LIGHTING_2:
         begin
           m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
           m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
           m_dwFrameTime := pm.ActCritical2.ftime;
           m_dwStartTime := GetTickCount;
           m_nCurEffFrame:=0;
           m_dwWarModeTime := GetTickCount;
           Shift (m_btDir, 0, 0, 1);
           m_boUseEffect := TRUE;
           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;

           if m_btRace = 6 then PlaySound (4187);    //´ë¸Á
           if m_btRace = 7 then PlaySound (4207);    //ÁÖ¸¶¼ú»ç
           if m_btRace = 27 then PlaySound (4237);   //ÁÖ¸¶°Ë»ç
           if m_btRace = 29 then PlaySound (4256);   //¸¶¼®°ÅÀÎ

           if m_btRace = 51 then PlaySound (4267);  //°Ý±«Àå ÀüÃ¼
           if m_btRace = 51 then PlaySound (4268);  //°Ý±«Àå ÀüÃ¼

           if m_btRace = 207 then PlaySound (3847);  //¿À¸¶Á¦»çÀå
           if m_btRace = 228 then PlaySound (4092);  //¼±¹ÚÀÇ¾Ç·É
           if m_btRace = 233 then PlaySound (4156);  //¾ÏÈæ¼±Àå
           if m_btRace = 233 then PlaySound (4156);  //¾ÏÈæ¼±Àå
           if m_btRace = 262 then PlaySound (4317);  //»ï³ª¹«Á¤¹é
           if m_btRace = 287 then PlaySound(4517);   //¼³ÅÂ¶û
         end;
    SM_LIGHTING_3:
         begin
            m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
            m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
            m_dwFrameTime := pm.ActCritical3.ftime;
            m_dwStartTime := GetTickCount;
            m_nCurEffFrame:=0;
            m_dwWarModeTime := GetTickCount;
            Shift (m_btDir, 0, 0, 1);
            m_boUseEffect := TRUE;
            m_nEffectFrame := m_nStartFrame;
            m_nEffectStart := m_nStartFrame;
            m_nEffectEnd := m_nEndFrame;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;
            if m_btRace = 233 then PlaySound (4146);  //¾ÏÈæ¼±Àå

            if m_btRace = 51 then PlaySound (4257);  //°Ý±«Àå ¸ð·¡ÆøÇ³
            if m_btRace = 51 then PlaySound (4258);  //°Ý±«Àå ¸ð·¡ÆøÇ³
            if m_btRace = 287 then PlaySound(4518);   //¼³ÅÂ¶û
         end;
    SM_DEATH:
         begin
            if m_btRace in [28,92] then begin  //¿©±Í¼® ¹ÙÀ§ÆøÅº
              m_nStartFrame := pm.ActDeath.start;
              m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
              m_dwFrameTime := pm.ActDeath.ftime;
              m_dwStartTime := GetTickCount;
              m_boUseEffect := False;
            end;
         end;

    SM_DIGUP:
         begin
            if m_btRace = 222 then begin  //°ÅÀåÈ­
              m_nStartFrame := pm.ActDeath.start;
              m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
              m_dwFrameTime := pm.ActDeath.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := False;
            end;
            if m_btRace = 261 then begin  //½£°ÅºÏÀÌ
              m_nStartFrame := pm.ActDeath.start+80 + m_btDir * (pm.ActDeath.frame+3 + pm.ActDeath.skip-3);
              m_nEndFrame := m_nStartFrame + pm.ActDeath.frame+3 - 1;
              m_dwFrameTime := pm.ActDeath.ftime;
              m_dwStartTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              PlaySound(4300);
            end;
            if m_btRace = 262 then begin   //»ï³ª¹«Á¤¹é
              m_nStartFrame := pm.ActDeath.start+80 + m_btDir * (pm.ActDeath.frame+3 + pm.ActDeath.skip-3);
              m_nEndFrame := m_nStartFrame + pm.ActDeath.frame+3 - 1;
              m_dwFrameTime := pm.ActDeath.ftime;
              m_dwStartTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              PlaySound(4310);
            end;
         end;
     SM_DIGDOWN:
         begin
            if m_btRace = 222 then begin  //°ÅÀåÈ­
              m_nStartFrame := pm.ActCritical3.start;
              m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
              m_dwFrameTime := pm.ActCritical3.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := False;
            end;
         end;
     else begin
       inherited CalcActorFrame;
     end;
   end;

end;


function  TShineCaveMon.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
   Result:=0;
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   if m_boDeath then begin
      if m_btRace in [92,28] then
         Result := pm.ActDeath.start + pm.ActDie.frame - 1
      else Result := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip) + (pm.ActDie.frame - 1);
      EffectPront := nil;
      EffectBSurface  := nil;
   end else begin
     if ((m_btRace = 261) or (m_btRace = 262)) and (m_nState and STATE_STONE_MODE <> 0) then begin      //½£°ÅºÏÀÌ, »ï³ª¹«Á¤¹é
       Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
     end else begin
       m_nDefFrameCount := pm.ActStand.frame;
       if m_nCurrentDefFrame < 0 then cf := 0
       else if m_nCurrentDefFrame >= pm.ActStand.frame then cf := 0
       else cf := m_nCurrentDefFrame;
       if m_btRace in [92,28] then
        Result := pm.ActStand.start + cf
       else
       Result := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip) + cf;
     end;
   end;
end;

procedure TShineCaveMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff : TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if (m_nCurrentAction = SM_HIT) and (m_nCurrentFrame-m_nStartFrame = 4) then begin
           if (m_btRace = 8) then begin  //ÁÖ¸¶È­±Ã»ç
             PlayScene.NewMagic (Self,MAGIC_JUMAFIREARC1,MAGIC_JUMAFIREARC1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 4)then begin
           if (m_btRace = 6) then begin  //´ë¸Á
             PlayScene.NewMagic (Self,MAGIC_BIG_SNAKE,MAGIC_BIG_SNAKE,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if m_btRace = 262 then begin //»ï³ª¹«Á¤¹é
             PlayScene.NewMagic (self, MAGIC_EXPLOSIN_TREE, MAGIC_EXPLOSIN_TREE, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY,
                                      m_nTargetRecog, mtThunder, FALSE,30, bo11);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
           if (m_btRace = 8) then begin  //ÁÖ¸¶È­±Ã»ç
             PlayScene.NewMagic (Self,MAGIC_JUMAFIREARC2,MAGIC_JUMAFIREARC2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 26) then begin  //ÁÖ¸¶Ç³±Ã»ç
             PlayScene.NewMagic (Self,MAGIC_JUMAWIND,MAGIC_JUMAWIND,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 203) then begin  //ÅÂ±¸¿À¸¶
             PlayScene.NewMagic (Self,MAGIC_TEGU_ATT,MAGIC_TEGU_ATT,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 206) then begin  //¿À¸¶Àûº´
             PlayScene.NewMagic (Self,MAGIC_JUCK_ATT,MAGIC_JUCK_ATT,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 228) then begin  //¼±¹ÚÀÇ¾Ç·É
             PlayScene.NewMagic (Self,MAGIC_GHOST_ATT,MAGIC_GHOST_ATT,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 229) then begin  //³ó³ë±º
             PlayScene.NewMagic (Self,MAGIC_FRAM_NO_ATT,MAGIC_FRAM_NO_ATT,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 282) then begin  //ºù¿ø±Í±Ã»ç
             PlayScene.NewMagic (Self,MAGIC_ICEARC,MAGIC_ICEARC,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
           end;
           if (m_btRace = 285) then begin //¾Ç±Í
             PlayScene.NewMagic (self, MAGIC_EXPLOSIN_DEVIL, MAGIC_EXPLOSIN_DEVIL, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY,
                                      m_nTargetRecog, mtThunder, FALSE, 30, bo11);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame - m_nStartFrame = 8) then begin
           if (m_btRace = 283) then begin //ºù¿ø±ÍÁ¸
             PlayScene.NewMagic (self, MAGIC_EXPLOSIN_ICE, MAGIC_EXPLOSIN_ICE, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY,
                                      m_nTargetRecog, mtThunder, FALSE,30, bo11);
           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TShineCaveMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
  if m_boUseEffect and (n27C <> nil) then begin
 //   DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n27C, 0);
    dsurface.Draw(dx + ax + m_nShiftX,dy + ay + m_nShiftY,n27C, True);
  end;
  end;
end;

procedure TShineCaveMon.DrawBackEff(dsurface: TDirectDrawSurface; dx,
  dy: Integer);
begin
  inherited;
  if g_BoEffect then begin
    if (EffectBSurface <> nil) then begin
      DrawBlend(dsurface, dx + ex + m_nShiftX, dy + ey + m_nShiftY, EffectBSurface, 1);   //DrawBlend3 2
    end;
  end;
end;

procedure TShineCaveMon.DrawProntEff(dsurface: TDirectDrawSurface; dx, dy: Integer);
begin
  inherited;
  if g_BoEffect then begin
    if (EffectPront <> nil) then begin
      DrawBlend(dsurface, dx + bx + m_nShiftX, dy + by + m_nShiftY, EffectPront, 1);       //DrawBlend3
    end;
  end;
end;




constructor TYehaGuardMon.Create;
begin
  inherited Create;
  n26C:=nil;
  if m_btRace in [201] then begin
   LightningTimer := TTimer.Create (nil);   //°øÀÛÁÖ
   LightningTimer.Interval := 10;
   LightningTimer.Tag := 0;
   LightningTimer.OnTimer := LightningTimerTimer;
   LightningTimer.Enabled := False;
  end;
end;

destructor TYehaGuardMon.Destroy;
begin
  if m_btRace in [201] then begin //°øÀÛÁÖ
    if LightningTimer <> nil then LightningTimer.Free;
  end;
  inherited Destroy;

end;

procedure TYehaGuardMon.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of

      195..199,201: begin  //Å«»Ô¼­¿ìÀÎ ¹é»óÀÎ  µ¹°ÅÀÎ  Èë°ÅÀÎ °¡³×¼ö °øÀÛÁÖ
        bo260 := False;
        m_boUseEffect := False;
      end;

    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of
        195: begin   //Å«»Ô¼­¿ìÀÎ
             case m_nCurrentAction of
               SM_HIT: begin
                  m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            560 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_2: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            640 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
         end;

         196: begin   //¹é»óÀÎ
             case m_nCurrentAction of
               SM_HIT: begin
                  m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            1210 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
         end;

         197: begin   //µ¹°ÅÀÎ
             case m_nCurrentAction of
               SM_HIT: begin
                  m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            1720 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
         end;


         199: begin   //°¡³×¼ö
             case m_nCurrentAction of
               SM_HIT: begin
                m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            3050 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING_2: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            3130 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING_3: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            3210 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
             end;
         end;

         201: begin   //°øÀÛÁÖ
             case m_nCurrentAction of
               SM_HIT: begin
                 m_boUseEffect:= False;
               end;
               SM_LIGHTING: begin
                n26C := g_WMonImagesArr[36].GetCachedImage (
                            4240 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING_2: begin
                 m_boUseEffect:= False;
               end;
               SM_LIGHTING_3: begin
                 m_boUseEffect:= False;
               end;
             end;
         end;


      end;
    end;
  end;
end;

procedure TYehaGuardMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
         m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
         m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
         m_dwFrameTime := pm.ActAttack.ftime;
         m_dwStartTime := GetTickCount;
         m_dwWarModeTime := GetTickCount;
         Shift (m_btDir, 0, 0, 1);
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       if m_btRace = 195 then   //Å«»Ô¼­¿ìÀÎ
         PlaySound(3806);
       if m_btRace = 196 then   //¹é»óÀÎ
         PlaySound(3816);
       if m_btRace = 197 then   //µ¹°ÅÀÎ
         PlaySound(3826);
       if m_btRace = 198 then   //Èë°ÅÀÎ
         PlaySound(3836);
       if m_btRace = 199 then   //°¡³×¼ö
         PlaySound(3846);
       if m_btRace = 201 then   //°øÀÛÁÖ 5x5
         PlaySound(3866);
     end;
     SM_LIGHTING_2: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
       m_dwFrameTime := pm.ActCritical2.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       if m_btRace = 195 then   //Å«»Ô¼­¿ìÀÎ
         PlaySound(3807);
       if m_btRace = 199 then   //°¡³×¼ö
         PlaySound(3847);
       if m_btRace = 201 then   //°øÀÛÁÖ °Å¹ÌÁÙ
         PlaySound (3867);
    end;
    SM_LIGHTING_3: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
       m_dwFrameTime := pm.ActCritical3.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       if m_btRace = 199 then   //°¡³×¼ö
         PlaySound(3848);
       if m_btRace = 201 then   //°øÀÛÁÖ µ¶ ¾È°³
         PlaySound(3868);
    end;
    else begin
       inherited CalcActorFrame;
    end;
  end;

end;


procedure TYehaGuardMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff : TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 1)then begin
           if m_btRace in [201] then begin //°øÀÛÁÖ
            if Not LightningTimer.Enabled then begin
                  LightningTimer.Enabled := True;
            end;
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin



           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;



procedure TYehaGuardMon.LightningTimerTimer(Sender: TObject);
var
   tx, ty, n, kx, ky : integer;
   bofly: Boolean;
begin
   if m_btRace = 201 then begin  //°øÀÛÁÖ

       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 10;
          Exit;
       end;
       tx := g_Myself.m_nCurrX;
       ty := g_Myself.m_nCurrY;

       n := random(4);
       kx := random(6);
       ky := random(5);

       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx+3, ty+ky+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx-2, ty-ky+5, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx, ty+ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx-kx-1, ty-ky-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx-kx+4, ty+ky+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx-3, ty-ky-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx-kx+4, ty+ky+1, 0, mtThunder, FALSE, 30, bofly);

          LightningTimer.Interval := 500;
       end
       else if LightningTimer.Tag = 2 then begin
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx-5, ty-ky-5, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx+5, ty+ky-3, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx+2, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx-kx-5, ty+ky+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx+2, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx-kx, ty+ky, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT_1, MAGIC_SPIDER_ATT_1, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
       end;


       if LightningTimer.Tag = 4 then PlaySound (3867); //ÃÊÇÊ»ç±â
       LightningTimer.Interval := LightningTimer.Interval + 100;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 10;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
   end;
end;

procedure TYehaGuardMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
     if m_btRace in [197] then begin   //µ¹°ÅÀÎ
       DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 0);
     end else begin
       DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
     end;
  end;
  end;
end;




//========================================================¿µ¹°

constructor TPet.Create;
begin
  inherited Create;
  n26C:=nil;
end;

destructor TPet.Destroy;
begin
   inherited Destroy;
end;

procedure TPet.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of

      240..251: begin
        bo260 := False;
        m_boUseEffect := False;
      end;

    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of


         240..251: begin
             case m_nCurrentAction of
               SM_HIT: begin
                 m_boUseEffect:= True;
                 n26C := g_WMagic3Images.GetCachedImage (
                            460 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING: begin
                 if m_btRace = 249 then begin
                   m_boUseEffect:= True;
                   n26C := g_WPetImg.GetCachedImage (
                            5060 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
                 end else begin
                   m_boUseEffect:= False;
                 end;
               end;
               SM_LIGHTING_2: begin
                 if m_btRace = 249 then begin
                   m_boUseEffect:= True;
                   n26C := g_WPetImg.GetCachedImage (
                            5060 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
                 end else begin
                   m_boUseEffect:= False;
                 end;
               end;
               SM_LIGHTING_3: begin
                 if m_btRace = 249 then begin
                   m_boUseEffect:= True;
                   n26C := g_WPetImg.GetCachedImage (
                            5060 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
                 end else begin
                   m_boUseEffect:= False;
                 end;
               end;
             end;
         end;


      end;
    end;
  end;
end;

procedure TPet.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
         m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
         m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
         m_dwFrameTime := pm.ActAttack.ftime;
         m_dwStartTime := GetTickCount;
         m_dwWarModeTime := GetTickCount;
         Shift (m_btDir, 0, 0, 1);
         m_boUseEffect := TRUE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;

         PlaySound2 (pet_pickup);
     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       if m_btRace = 249 then begin
         m_boUseEffect := TRUE;
         m_nEffectFrame := 0;
         m_nEffectStart := 11;
         m_nEffectEnd := 11;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else  m_boUseEffect := False;
     end;
     SM_LIGHTING_2: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
       m_dwFrameTime := pm.ActCritical2.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if m_btRace = 249 then begin
         m_boUseEffect := TRUE;
         m_nEffectFrame := 0;
         m_nEffectStart := 11;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else  m_boUseEffect := False;
    end;
    SM_LIGHTING_3: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
       m_dwFrameTime := pm.ActCritical3.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if m_btRace = 249 then begin
         m_boUseEffect := TRUE;
         m_nEffectFrame := 0;
         m_nEffectStart := 11;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end else  m_boUseEffect := False;
    end;
    else begin
       inherited CalcActorFrame;
    end;
  end;

end;


procedure TPet.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff : TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;


procedure TPet.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
end;




{ TNamManMon }

constructor TNamManMon.Create;
begin
  inherited Create;
  n26C:=nil;
end;

destructor TNamManMon.Destroy;
begin
   inherited Destroy;
end;

procedure TNamManMon.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of

     { 117: begin //´Ü¹¬
        AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage (
                        3580 + (m_btDir * 20) + m_nCurrentFrame - m_nStartFrame,
                        n264, n268);

      end;   }

      117: begin    //´Ü¹¬
       bo260 := False;    //Á×À½ ÀÌÆÑ x
       m_boUseEffect := False;
      end;

    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of



        117: begin  //´Ü¹¬
             case m_nCurrentAction of
               SM_HIT: begin     //ÀÏ¹Ý°ø°Ý
                n26C := g_WMonImagesArr[32].GetCachedImage (
                            5363 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING: begin   //À½ÆÄ°ø°Ý  ÀüÃ¼°ø°Ý
                n26C := g_WMonImagesArr[32].GetCachedImage (
                            5460 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;


               SM_LIGHTING_1: begin   //ÀüÃ¼°ø°Ý
                n26C := g_WMonImagesArr[32].GetCachedImage (
                            5730 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_2: begin  //¿ø°Å¸® 1ÀÎ °ø°Ý
                n26C := g_WMonImagesArr[32].GetCachedImage (
                            5540 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_3: begin  //¹ÚÁã ¼ÒÈ¯
                n26C := g_WMonImagesArr[32].GetCachedImage (
                            5720 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

             end;
         end;

      end;
    end;
  end;
end;

procedure TNamManMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;

       if m_btRace = 100 then begin  //¾ß¼ö¿Õ
         PlaySound (2497);
       end;

     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin

       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_nCurEffFrame:=0;
       m_boUseEffect := TRUE;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;

       if m_btRace = 117 then begin    //´Ü¹¬
        PlaySound (3496);
       end;

     end;
     SM_LIGHTING_2:
         begin
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;

              if m_btRace = 117 then begin  //´Ü¹¬
                PlaySound2 (namman_att2);
              end;
         end;
     SM_LIGHTING_3:
         begin
              m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical3.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;

              if m_btRace = 117 then begin  //´Ü¹¬
                PlaySound2 (namman_att3);
              end;
          end;

     else begin
       inherited CalcActorFrame;
     end;
   end;

end;


procedure TNamManMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff: TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if (m_nCurrentAction = SM_HIT) and (m_nCurrentFrame-m_nStartFrame = 4) then begin
             if m_btRace = 117 then begin       //´Ü¹¬
                 PlayScene.NewMagic (self, MAGIC_NAMMAN_ATT1_1,MAGIC_NAMMAN_ATT1_1,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
             end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 4)then begin
            meff := TFlyingFireBall (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mt12));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[32];
               meff.NextFrameTime := 100;
               meff.FlyImageBase := 5620;
            end;

             if m_btRace = 117 then begin       //´Ü¹¬
                 PlayScene.NewMagic (self, MAGIC_NAMMAN_ATT1_2,MAGIC_NAMMAN_ATT1_2,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
                 PlaySound (2526);
             end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

            if(m_btRace = 111) then begin    //¼ú»çºñ¿ù¿©¿ì:È­¿°
                PlayScene.NewMagic (self,
                                      MAGIC_FOX_FIRE1,
                                      MAGIC_FOX_FIRE1,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (2517);
            end;

         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

             if (m_btRace = 71) then begin  //¹Ý¾ßÁÂ»ç
               PlayScene.NewMagic (Self,1,1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,30,bo11);
               PlaySound(10012);
             end;
           end;

         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TNamManMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
  end;
end;






{ TMerMaidKingMon }

constructor TMerMaidKingMon.Create;
begin
  inherited Create;
  n26C:=nil;
end;

destructor TMerMaidKingMon.Destroy;
begin
   inherited Destroy;

end;

procedure TMerMaidKingMon.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of


      189: begin    //¼ö¾î±Í
       bo260 := False;    //Á×À½ ÀÌÆÑ x
       m_boUseEffect := False;
      end;

    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of



        189: begin  //¼ö¾î±Í
             case m_nCurrentAction of
               SM_HIT: begin     //ÀÏ¹Ý°ø°Ý
                n26C := g_WMonImagesArr[35].GetCachedImage (
                            2628 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING: begin   //ÀüÃ¼°ø°Ý
                n26C := g_WMonImagesArr[35].GetCachedImage (
                            2710 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;


               SM_LIGHTING_1: begin   //ÀüÃ¼°ø°Ý
                  m_boUseEffect:= False;
               end;

               SM_LIGHTING_2: begin  //¿ø°Å¸® 1ÀÎ °ø°Ý
                n26C := g_WMonImagesArr[35].GetCachedImage (
                            2820 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_3: begin
                 m_boUseEffect:= False;
               end;

             end;
         end;

      end;
    end;
  end;
end;

procedure TMerMaidKingMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;


     end;
     SM_LIGHTING_1,
     SM_LIGHTING: begin

       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_nCurEffFrame:=0;
       m_boUseEffect := TRUE;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;


     end;
     SM_LIGHTING_2:
         begin
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;

              if m_btRace = 189 then begin  //¼ö¾î±Í
                PlaySound (3747);
              end;
         end;
     SM_LIGHTING_3:
         begin
              m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical3.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;

              if m_btRace = 189 then begin  //¼ö¾î±Í
                PlaySound (3746);
              end;

          end;

     else begin
       inherited CalcActorFrame;
     end;
   end;

end;


procedure TMerMaidKingMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff: TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if (m_nCurrentAction = SM_HIT) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 4)then begin
            meff := TFlyingFireBall (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mt12));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[35];
               meff.NextFrameTime := 100;
               meff.FlyImageBase := 2860;
            end;

             if m_btRace = 189 then begin       //¼ö¾î±Í
                 PlayScene.NewMagic (self, MAGIC_MERMAID_ATT1_1,MAGIC_MERMAID_ATT1_1,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
                 PlaySound (3748);
             end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin
             if m_btRace = 189 then begin       //¼ö¾î±Í
                 PlayScene.NewMagic (self, MAGIC_MERMAID_ATT1_2,MAGIC_MERMAID_ATT1_2,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
                 PlaySound (3748);
             end;
         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin


           end;

         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TMerMaidKingMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
end;


{¿ùÁö°â½ÅÀå}

constructor TGumiBoss.Create;
begin
   inherited Create;
   n26C:=nil;

   SpiderTimer := TTimer.Create (nil);
   SpiderTimer.Interval := 70;
   SpiderTimer.Tag := 0;
   SpiderTimer.OnTimer := SpiderTimerTimer;
   SpiderTimer.Enabled := False;
end;

destructor TGumiBoss.Destroy;       //¿ùÁö°â½ÅÀå
begin

   if SpiderTimer <> nil then SpiderTimer.Free;

   inherited Destroy;

end;

procedure TGumiBoss.SpiderTimerTimer(Sender: TObject);   //¿ùÁö°â½ÅÀå
var
   tx, ty, n, kx, ky : integer;
   bofly: Boolean;
begin
       if SpiderTimer.Tag = 0 then begin
          SpiderTimer.Tag := SpiderTimer.Tag + 1;
          SpiderTimer.Interval := 800;
          Exit;
       end
       else SpiderTimer.Interval := 70;
       tx := m_nCurrX - 5;
       ty := m_nCurrY - 3;

       Randomize;
       if SpiderTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx-6, ty+6, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx-6, ty-6, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+4, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+6, ty-4, 0, mtThunder, FALSE, 30, bofly);
       end;

       n := random(4);
       kx := random(7);
       ky := random(5);
       case n of
          0: begin PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+kx-4, ty-ky+6, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx-kx+6, ty-ky+2, 0, mtThunder, FALSE, 30, bofly); end;
          1: begin PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx-kx,   ty+ky, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+kx+4, ty+ky, 0, mtThunder, FALSE, 30, bofly);   end;
          2: begin PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx-kx,   ty-ky+6, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+kx+6, ty+ky-2, 0, mtThunder, FALSE, 30, bofly); end;
          3: begin PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+kx-4, ty+ky, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, MAGIC_SPIDER_ATT1, MAGIC_SPIDER_ATT1, m_nCurrX, m_nCurrY, tx+kx+6, ty+ky+4, 0, mtThunder, FALSE, 30, bofly); end;
       end;

       if (SpiderTimer.Tag mod 3) = 0 then PlaySound (2279);
       SpiderTimer.Interval := SpiderTimer.Interval + 15;
       SpiderTimer.Tag := SpiderTimer.Tag+1;

       if SpiderTimer.Tag > 7 then begin
          SpiderTimer.Interval := 70;
          SpiderTimer.Tag := 0;
          SpiderTimer.Enabled := False;
       end;
end;

procedure TGumiBoss.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of
     SM_HIT: begin
        m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
        m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
        m_dwFrameTime := pm.ActAttack.ftime;
        m_dwStartTime := GetTickCount;
        m_dwWarModeTime := GetTickCount;
        Shift (m_btDir, 0, 0, 1);
        m_boUseEffect := False;
        PlaySound(2777);
     end;
     SM_LIGHTING: begin       //È­¿°°ø°Ý
        m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
        m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
        m_dwFrameTime := pm.ActAttack.ftime;
        m_dwStartTime := GetTickCount;
        m_dwWarModeTime := GetTickCount;
        Shift (m_btDir, 0, 0, 1);
        m_boUseEffect := False;
        PlaySound(2779);
     end;

     SM_LIGHTING_3: begin       //ÁÖº¯°ø°Ý
        m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
        m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
        m_dwFrameTime := pm.ActAttack.ftime;
        m_dwStartTime := GetTickCount;
        m_dwWarModeTime := GetTickCount;
        Shift (m_btDir, 0, 0, 1);

        m_boUseEffect := TRUE;
        m_nEffectStart := 0;
        m_nEffectFrame := 0;
        m_nEffectEnd :=10;
        m_dwEffectStartTime := GetTickCount;
        m_dwEffectFrameTime := 160;
        PlaySound(2776);
     end;

     SM_LIGHTING_2: begin      //°Å¹ÌÁÙ
        m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
        m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
        m_dwFrameTime := pm.ActCritical.ftime;
        m_dwStartTime := GetTickCount;
        m_nCurEffFrame:=0;
        m_boUseEffect := FALSE;
        m_dwWarModeTime := GetTickCount;
        Shift (m_btDir, 0, 0, 1);

        PlaySound(2778);
     end;
     SM_NOWDEATH: begin         //Á×À»¶§
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;

       m_boUseEffect := TRUE;
       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 6;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
     end;
     else begin
       inherited;
     end;
   end;

end;

procedure TGumiBoss.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY, n26C, 1);
  end;
end;

procedure TGumiBoss.LoadSurface;
begin
  inherited;

  if bo260 then begin
    AttackEffectSurface := g_WMonImagesArr[25].GetCachedImage(
                     2960 + m_nEffectFrame - m_nEffectStart,
                     n264, n268);
  end else begin
    if m_boUseEffect then begin
      case m_nCurrentAction of
        SM_LIGHTING_3: begin
           n26C := g_WMonImagesArr[25].GetCachedImage (
                            2950 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
              end;
        SM_NOWDEATH: begin
           n26C := g_WMonImagesArr[25].GetCachedImage (
                            2960 + m_nEffectFrame-m_nEffectStart,
                            ax, ay);
              end;
      end;
    end;
  end;
end;

procedure TGumiBoss.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bofly: Boolean;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260 := FALSE;
         end;
         if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame - m_nStartFrame = 4) then begin    //È­¿°°ø°Ý
           PlayScene.NewMagic (self, MAGIC_FIREBURN, MAGIC_FIREBURN, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY, 0, mtThunder, FALSE, 30, bofly);
           PlaySound(8222);
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame - m_nStartFrame = 1) then begin      //°Å¹ÌÁÙ °ø°Ý
           if Not SpiderTimer.Enabled then begin
               SpiderTimer.Enabled := True;
           end;
         end;


         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;


{ TElectronicScolpionMon }

procedure TElectronicScolpionMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
     end;
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     else begin
       inherited;
     end;
   end;
end;

procedure TElectronicScolpionMon.LoadSurface;
begin
  inherited;

  if (m_btRace = 60) and m_boUseEffect and (m_nCurrentAction = SM_LIGHTING) then begin
    AttackEffectSurface := g_WMonImagesArr[18].GetCachedImage (
                        430 + (firedir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
  end;


end;



{ TBossPigMon }

procedure TBossPigMon.LoadSurface;
begin
  inherited;
  if (m_btRace = 61) and m_boUseEffect then begin
    AttackEffectSurface := g_WMonImagesArr[18].GetCachedImage (
                        860 + (firedir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
  end;
end;

{ TKingOfSculpureKingMon }

procedure TKingOfSculpureKingMon.CalcActorFrame;     //ÈæÃµ¸¶¿Õ
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_nEffectFrame := pm.ActDie.start;
       m_nEffectStart := pm.ActDie.start;
       m_nEffectEnd := pm.ActDie.start + pm.ActDie.frame - 1;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       m_boUseEffect := TRUE;
     end;
     else begin
      inherited CalcActorFrame;
     end;
   end;
end;

procedure TKingOfSculpureKingMon.LoadSurface;      //ÈæÃµ¸¶¿Õ
begin
  inherited LoadSurface;
  if (m_btRace = 62) and m_boUseEffect then begin
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[18].GetCachedImage (
                        1490 + (firedir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
      end;
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[18].GetCachedImage (
                        1380 + (firedir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
      end;
      SM_NOWDEATH: begin
        AttackEffectSurface := g_WMonImagesArr[18].GetCachedImage (
                        1470 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
      end;
    end;

  end;
end;

{ TSkeletonArcherMon }

procedure TSkeletonArcherMon.CalcActorFrame;
begin
   inherited CalcActorFrame;
   case m_nCurrentAction of
      SM_NOWDEATH:
         begin
            if(m_btRace <> 72)then
               bo260 := TRUE;
            if m_btRace in [105,152] then bo260 := False; // ¼³ÀÎ´ëÃæÀÌ¸é Á×´Â ÀÓÆåÆ® ¾È³ª¿È   //¼­±«
         end;
   end;

end;

procedure TSkeletonArcherMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if bo260 and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + n264 + m_nShiftX,dy + n268 + m_nShiftY,AttackEffectSurface, 1);
  end;
end;

procedure TSkeletonArcherMon.LoadSurface;
begin
  inherited;
  if bo260 and (m_btRace = 69) then begin
     AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                  1600 + m_nEffectFrame - m_nEffectStart,
                   n264, n268);
  end;
end;

procedure TSkeletonArcherMon.Run;
var
  m_dwFrameTimetime: longword;
begin

  if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
  else m_dwFrameTimetime := m_dwFrameTime;
  if m_nCurrentAction <> 0 then begin
    if (GetTickCount - m_dwStartTime) > m_dwFrameTimetime then begin
      if m_nCurrentFrame < m_nEndFrame then begin
      end else begin
        m_nCurrentAction:=0;
        bo260:=False;
      end;
    end;
  end;

  inherited;
end;

{ TFlyingSpider }

procedure TFlyingSpider.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
begin
  inherited;
  if m_nCurrentAction = SM_NOWDEATH then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[11],1420,20,m_dwFrameTime,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
end;

{ TExplosionSpider }

procedure TExplosionSpider.CalcActorFrame;
begin
  inherited ;
  case m_nCurrentAction of
    SM_HIT: begin
      m_boUseEffect:=False;
    end;
    SM_NOWDEATH: begin
      m_nEffectStart:=m_nStartFrame;
      m_nEffectFrame:=m_nStartFrame;
      m_dwEffectStartTime:=GetTickCount();
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectEnd:=m_nEndFrame;
      m_boUseEffect:=True;
    end;
  end;
end;

procedure TExplosionSpider.LoadSurface;
begin
  inherited;
  if m_boUseEffect then
    AttackEffectSurface := g_WMonImagesArr[13].GetCachedImage (
                        730 + m_nEffectFrame-m_nEffectStart,
                        ax, ay);
end;



{ TExplosionDark }

procedure TExplosionDark.CalcActorFrame;
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
      m_boUseEffect:=False;
    end;
    SM_NOWDEATH: begin
      m_nEffectStart:=m_nStartFrame;
      m_nEffectFrame:=m_nStartFrame;
      m_dwEffectStartTime:=GetTickCount();
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectEnd:=m_nEndFrame;
      m_boUseEffect:=True;
    end;
  end;
end;

procedure TExplosionDark.LoadSurface;
begin
  inherited;
  if m_boUseEffect then
    AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage (
                        3600 + m_nEffectFrame-m_nEffectStart,
                        ax, ay);
end;



{ TSkeletonKingMon }

procedure TSkeletonKingMon.CalcActorFrame;   //ÇØ°ñ¹Ý¿Õ
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   m_nCurrentFrame := -1;

   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of
     SM_BACKSTEP,SM_WALK: begin
       m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
       m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
       m_dwFrameTime := pm.ActWalk.ftime;
       m_dwStartTime := GetTickCount;
       m_nEffectFrame:=pm.ActWalk.start;
       m_nEffectStart:=pm.ActWalk.start;
       m_nEffectEnd:=pm.ActWalk.start + pm.ActWalk.frame -1;
       m_dwEffectStartTime:=GetTickCount();
       m_dwEffectFrameTime:=m_dwFrameTime;
       m_boUseEffect:=True;
            //WarMode := FALSE;
       m_nMoveStep := 1;
       if m_nCurrentAction = SM_WALK then
         Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
       else
         Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
     end;
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime:= GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame:=m_nStartFrame;
       m_nEffectStart:=m_nStartFrame;
       m_nEffectEnd:=m_nEndFrame;
       m_dwEffectStartTime:=GetTickCount();
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_FLYAXE: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime:= GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame:=m_nStartFrame;
       m_nEffectStart:=m_nStartFrame;
       m_nEffectEnd:=m_nEndFrame;
       m_dwEffectStartTime:=GetTickCount();
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_LIGHTING: begin
       m_nStartFrame := 80 + pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime:= GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       firedir := m_btDir;
       m_nEffectFrame:=m_nStartFrame;
       m_nEffectStart:=m_nStartFrame;
       m_nEffectEnd:=m_nEndFrame;
       m_dwEffectStartTime:=GetTickCount();
       m_dwEffectFrameTime := m_dwFrameTime;
     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
       m_nEffectFrame:=pm.ActStruck.start;
       m_nEffectStart:=pm.ActStruck.start;
       m_nEffectEnd:=pm.ActStruck.start + pm.ActStruck.frame -1;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=m_dwFrameTime;
       m_boUseEffect := TRUE;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_nEffectFrame := pm.ActDie.start;
       m_nEffectStart := pm.ActDie.start;
       m_nEffectEnd := pm.ActDie.start + pm.ActDie.frame - 1;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       m_boUseEffect := TRUE;
     end;
     else begin
       inherited;
     end;
   end;
end;

procedure TSkeletonKingMon.LoadSurface;         //ÇØ°ñ¹Ý¿Õ
begin
  inherited;
   if (m_btRace = 63) and m_boUseEffect then begin
     case m_nCurrentAction of
       SM_WALK: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3060 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
       end;
       SM_HIT: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3140 + (firedir * 10) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
       end;
       SM_FLYAXE: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3300 + (firedir * 10) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
       end;
       SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3220 + (firedir * 10) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
       end;
       SM_STRUCK: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3380 + (m_btDir * 2) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);       
       end;
       SM_NOWDEATH: begin
         AttackEffectSurface := g_WMonImagesArr[19].GetCachedImage (
                                3400 + (m_btDir * 20) + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
       end;
     end;
   end;
end;

procedure TSkeletonKingMon.Run;              //ÇØ°ñ¹Ý¿Õ
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   meff: TFlyingFireBall;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN)  then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect:=False;
            BoUseDieEffect := FALSE;
         end;

         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame-m_nStartFrame = 4) then begin
            meff := TFlyingFireBall (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mt12));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[19];
               meff.NextFrameTime := 40;
               meff.FlyImageBase := 3570;
            end;
         end;
        m_nCurrentDefFrame := 0;
        m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

{ TStoneMonster }

procedure TStoneMonster.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_boUseMagic:=False;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   m_btDir:=0;
   case m_nCurrentAction of
     SM_TURN: begin
       m_nStartFrame := pm.ActStand.start;
       m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
       m_dwFrameTime := pm.ActStand.ftime;
       m_dwStartTime := GetTickCount;
       m_nDefFrameCount:=pm.ActStand.frame;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 300;
       end;
     end;
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start;
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nStartFrame + 25;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 150;
       end;
     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start;
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_DEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       if (m_btRace in [75,77]) then bo260:=True;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nStartFrame + 19;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 80;
     end;
   end;
end;

constructor TStoneMonster.Create;
begin
  inherited;
  n26C:=nil;
  m_boUseEffect:=False;
  bo260:=False;
end;

procedure TStoneMonster.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,
               dx + ax + m_nShiftX,
               dy + ay + m_nShiftY,
               n26C, 1);
  end;
end;

procedure TStoneMonster.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of
      75: begin
        AttackEffectSurface := g_WMonImagesArr[21].GetCachedImage (
                        2530 + m_nEffectFrame - m_nEffectStart,
                        n264, n268);
      end;
      77: begin
        AttackEffectSurface := g_WMonImagesArr[21].GetCachedImage (
                        2660 + m_nEffectFrame - m_nEffectStart,
                        n264, n268);
      end;
    end;
  end else begin
    if m_boUseEffect then
      case m_btRace of
        75: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2500 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2490 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;
        77: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2630 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2620 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

        206, 207: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            20 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
              n26C := g_WMonImagesArr[38].GetCachedImage (
                            20 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;

      end;
  end;
end;

procedure TStoneMonster.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime: longword;
   m_dwFrameTimetime: longword;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect or bo260 then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if (prv <> m_nCurrentFrame) or (prv <> m_nEffectFrame) then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

{ TPotMon }

constructor TPotMon.Create;
begin
  inherited;
  n26C:=nil;
  m_boUseEffect:=False;
  bo260:=True;
end;

procedure TPotMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_boUseMagic:=False;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  // m_btDir:=0;
   case m_nCurrentAction of
     SM_TURN: begin
       m_nStartFrame := pm.ActStand.start + (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
       m_dwFrameTime := pm.ActStand.ftime;
       m_dwStartTime := GetTickCount;
       m_nDefFrameCount:=pm.ActStand.frame;
      // if not m_boUseEffect then begin
       if m_btRace = 172 then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end;
     //  end;
     end;
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nStartFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := m_dwFrameTime;
       end;

       if m_btRace = 171 then begin      //È£Áß±Í2
           PlaySound2 (pot1_atk);
       end;
     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_DEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       if m_btRace = 172 then begin
        bo260:=True;
        m_boUseEffect := TRUE;
        m_nEffectFrame := m_nStartFrame;
        m_nEffectStart := m_nStartFrame;
        m_nEffectEnd := m_nEndFrame;
        m_dwEffectStartTime := GetTickCount;
        m_dwEffectFrameTime := m_dwFrameTime;
       end;
       if m_btRace = 171 then begin    //È£Áß±Í2
           PlaySound2 (pot1_die);
       end;
     end;
   end;
end;

procedure TPotMon.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of
      171: begin
        bo260 := False;
      end;
      77: begin
        AttackEffectSurface := g_WMonImagesArr[21].GetCachedImage (
                        2660 + m_nEffectFrame - m_nEffectStart,
                        n264, n268);
      end;
    end;
  end else begin
    if m_boUseEffect then
      case m_btRace of
        171: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[33].GetCachedImage (
                            5940 + (m_btDir * 10 ) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
               m_boUseEffect := False;
            end;
          end;
        end;
        77: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2630 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
              n26C := g_WMonImagesArr[21].GetCachedImage (
                            2620 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;
      end;
  end;
end;

procedure TPotMon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime: longword;
   m_dwFrameTimetime: longword;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect or bo260 then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if (prv <> m_nCurrentFrame) or (prv <> m_nEffectFrame) then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TPotMon.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,
               dx + ax + m_nShiftX,
               dy + ay + m_nShiftY,
               n26C, 1);
  end;
end;

  { TIceHellMonster5 }

procedure TIceHellMonster5.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_boUseMagic:=False;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   m_btDir:=0;
   case m_nCurrentAction of
     SM_TURN: begin
       m_nStartFrame := pm.ActStand.start;
       m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
       m_dwFrameTime := pm.ActStand.ftime;
       m_dwStartTime := GetTickCount;
       m_nDefFrameCount:=pm.ActStand.frame;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 300;
       end;
     end;
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start;
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nStartFrame + 25;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 150;
       end;
     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start;
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_DEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       bo260:=True;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nStartFrame + 19;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 80;
     end;
   end;
end;

constructor TIceHellMonster5.Create;
begin
  inherited;
  n26C:=nil;
  m_boUseEffect:=False;
  bo260:=False;
end;

procedure TIceHellMonster5.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,
               dx + ax + m_nShiftX,
               dy + ay + m_nShiftY,
               n26C, 1);
  end;
  end;
end;

procedure TIceHellMonster5.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of
      214: begin
        AttackEffectSurface := g_WMonImagesArr[6].GetCachedImage (
                        204 + m_nEffectFrame - m_nEffectStart,
                        n264, n268);
      end;
    end;
  end else begin
    if m_boUseEffect then
      case m_btRace of
        214: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[6].GetCachedImage (
                            204 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_TURN: begin
              n26C := g_WMonImagesArr[6].GetCachedImage (
                            204 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
          end;
        end;
      end;
  end;
end;

procedure TIceHellMonster5.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime: longword;
   m_dwFrameTimetime: longword;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect or bo260 then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if (prv <> m_nCurrentFrame) or (prv <> m_nEffectFrame) then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

 { TIceHellMonster6 }

procedure TIceHellMonster6.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_boUseMagic:=False;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   m_btDir:=0;
   case m_nCurrentAction of
     SM_TURN: begin
       m_nStartFrame := pm.ActStand.start;
       m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
       m_dwFrameTime := pm.ActStand.ftime;
       m_dwStartTime := GetTickCount;
       m_nDefFrameCount:=pm.ActStand.frame;
       if not m_boUseEffect then begin
         m_boUseEffect:=FALSE;
         m_nEffectFrame := m_nStartFrame;
         m_nEffectStart := m_nStartFrame;
         m_nEffectEnd := m_nEndFrame;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 300;
       end;
     end;
     SM_HIT: begin
       m_nStartFrame := pm.ActAttack.start;
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       if not m_boUseEffect then begin
         m_boUseEffect:=True;
         m_nEffectFrame := 0;
         m_nEffectStart := 0;
         m_nEffectEnd := 10;
         m_dwEffectStartTime := GetTickCount;
         m_dwEffectFrameTime := 150;
       end;
     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start;
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
     end;
     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
         m_boUseEffect:=True;
       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 10;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 150;
     end;
   end;
end;

constructor TIceHellMonster6.Create;
begin
  inherited;
  n26C:=nil;
  m_boUseEffect:=False;
  bo260:=False;
end;

procedure TIceHellMonster6.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,
               dx + ax + m_nShiftX,
               dy + ay + m_nShiftY,
               n26C, 1);
  end;
  end;
end;

procedure TIceHellMonster6.LoadSurface;
begin
  inherited;
  if bo260 then begin
    case m_btRace of
      215: begin
        AttackEffectSurface := g_WMonImagesArr[6].GetCachedImage (
                        204 + m_nEffectFrame - m_nEffectStart,
                        n264, n268);
      end;
    end;
  end else begin
    if m_boUseEffect then
      case m_btRace of
        215: begin
          case m_nCurrentAction of
            SM_HIT: begin
              n26C := g_WMonImagesArr[28].GetCachedImage (
                            3850 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
            end;
            SM_NOWDEATH: begin
             n26C := g_WMonImagesArr[28].GetCachedImage (
                                3870 + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
            end;
          end;
        end;
      end;
  end;
end;

procedure TIceHellMonster6.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime: longword;
   m_dwFrameTimetime: longword;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect or bo260 then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if (prv <> m_nCurrentFrame) or (prv <> m_nEffectFrame) then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;


{ TAngel }

procedure  TAngel.LoadSurface;
var
   mimg: TWMImages;
begin

   mimg := GetMonImg (m_wAppearance);
   if mimg <> nil then begin

      if (not m_boReverseFrame) then begin
         m_BodySurface := mimg.GetCachedImage (920{GetOffset (m_wAppearance)}+ m_nCurrentFrame, m_npx, m_npy);
         m_BodySurface2 := mimg.GetCachedImage (1280 + m_nCurrentFrame, m_npx2, m_npy2); // Åõ¸í¾Æ´Ñ ÀÌ¹ÌÁö
      end
      else begin
         m_BodySurface := mimg.GetCachedImage ( 920 {GetOffset (m_wAppearance)} + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame), m_npx, m_npy);
         m_BodySurface2 := mimg.GetCachedImage (1280 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame), m_npx2, m_npy2);
      end;
   end;
end;


procedure TAngel.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
  nx, ny : integer;
begin
  if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;


  ceff := GetDrawEffectValue;
  if (m_BodySurface <> nil) and (m_BodySurface2 <> nil) then begin
    Drawblend (dsurface, dx + m_npx + m_nShiftX, dy + m_npy + m_nShiftY, m_BodySurface, 1);
    if AngelFastDraw then blend := False;//¿ù·É
    DrawEffSurface (dsurface, m_BodySurface2, dx + m_npx2 + m_nShiftX, dy + m_npy2 + m_nShiftY, blend, ceff);
  end;


end;

{ TDarkAngel }        //È¥·É

procedure  TDarkAngel.LoadSurface;
var
   mimg: TWMImages;
begin

   mimg := GetMonImg (m_wAppearance);
   if mimg <> nil then begin

      if (not m_boReverseFrame) then begin
         m_BodySurface := mimg.GetCachedImage (920 + m_nCurrentFrame, m_npx, m_npy);
      end else begin
         m_BodySurface := mimg.GetCachedImage (920 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame), m_npx, m_npy);
      end;
   end;
end;


procedure TDarkAngel.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
  nx, ny : integer;
begin
  if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;


  ceff := GetDrawEffectValue;
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_npx + m_nShiftX, dy + m_npy + m_nShiftY, blend, ceff);
end;

{ Tyounhon }

procedure Tyounhon.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
  bo11: Boolean;
begin
  if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface; //bodysurface loadsurface
   end;

  if n278 <> nil then begin
    DrawBlend (dsurface, dx + n270 + m_nShiftX, dy + n274 + m_nShiftY, n278, 1);
  end;
  //inherited;

  ceff := GetDrawEffectValue;

  if m_BodySurface <> nil then begin
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  end;

  
end;

procedure Tyounhon.LoadSurface;
var
   mimg: TWMImages;
begin
   mimg := GetMonImg (m_wAppearance);


   if mimg <> nil then begin
    if m_boUseEffect then begin
       m_BodySurface := mimg.GetCachedImage (
                            1720 + m_nEffectFrame,
                            m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (
                            2140 + m_nEffectFrame,
                            n270, n274);
    end else begin
     if (not m_boReverseFrame) then begin
       m_BodySurface := mimg.GetCachedImage (1720 + m_nCurrentFrame, m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (2140 + m_nCurrentFrame, n270, n274);
     end else begin
       m_BodySurface := mimg.GetCachedImage (
                            1720 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame),
                            m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (
                            2140 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame),
                            n270, n274);
     end;
    end;
   end;
end;


{ Twino }

procedure Twino.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
  bo11: Boolean;
begin
  if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface; //bodysurface loadsurface
   end;

  if n278 <> nil then begin
    DrawBlend (dsurface, dx + n270 + m_nShiftX, dy + n274 + m_nShiftY, n278, 1);
  end;
  //inherited;

  ceff := GetDrawEffectValue;


  if m_BodySurface <> nil then begin
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  end;

  
end;

procedure Twino.LoadSurface;
var
   mimg: TWMImages;
begin
   mimg := GetMonImg (m_wAppearance);


   if mimg <> nil then begin
    if m_boUseEffect then begin
       m_BodySurface := mimg.GetCachedImage (
                            3620 + m_nEffectFrame,
                            m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (
                            4280 + m_nEffectFrame,
                            n270, n274);
    end else begin
     if (not m_boReverseFrame) then begin
       m_BodySurface := mimg.GetCachedImage (3620 + m_nCurrentFrame, m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (4280 + m_nCurrentFrame, n270, n274);
     end else begin
       m_BodySurface := mimg.GetCachedImage (
                            3620 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame),
                            m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (
                            4280 + m_nEndFrame - (m_nCurrentFrame-m_nStartFrame),
                            n270, n274);
     end;
    end;
   end;
end;

{ TPBOMA6Mon }

procedure TPBOMA6Mon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   meff: TFlyingAxe;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
            meff := TFlyingAxe (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             g_nTargetX,
                             g_nTargetY,
                             m_nTargetRecog,
                             mt16));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[21];
               meff.NextFrameTime := 50;
               meff.FlyImageBase:=1989;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;

// ¿ëÁ¶½Å»ó(¿ë¼®»ó) -----------------------------------------------------------------------------

constructor TDragonStatue.Create;
begin
   inherited Create;
   AttackEffectSurface := nil;
end;

procedure  TDragonStatue.LoadSurface;
var
   mimg: TWMImages;
begin
   mimg := g_WDragonImg;

   if mimg <> nil then
      m_BodySurface := mimg.GetCachedImage (GetOffset(m_wAppearance), m_nPx, m_nPy);

   if m_boUseEffect then begin
      case m_btRace of
         84,85,86: begin // ¿ë¼®»ó¿ì
             EffectSurface := g_WDragonImg.GetCachedImage (
                310 + m_nEffectFrame, ax, ay);
         end;
         87,88,89: begin // ¿ë¼®»óÁÂ
             EffectSurface := g_WDragonImg.GetCachedImage (
                330 + m_nEffectFrame, ax, ay);
          end;
      end;
   end;

end;

procedure TDragonStatue.CalcActorFrame;
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   m_btDir := 0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset(m_wAppearance);
   pm := GetRaceByPM (m_btRace, m_wAppearance);

   case m_nCurrentAction of
      SM_LIGHTING:
         begin
            m_nStartFrame := 0;
            m_nEndFrame    := 9;
            m_dwFrameTime  := 100;
            m_dwStartTime  := GetTickCount;

            m_boUseEffect := TRUE;
            m_nEffectStart := 0;
            m_nEffectFrame := 0;
            m_nEffectEnd   := 9;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := 100;
         end;
      SM_DIGUP: //°È±â ¾øÀ½, SM_DIGUP, ¹æÇâ ¾øÀ½.
         begin
            Shift (0, 0, 0, 1);
            m_nStartFrame := 0;
            m_nEndFrame := 9;
            m_dwFrameTime := 100;
            m_dwStartTime := GetTickCount;
         end;
   end;
end;

procedure TDragonStatue.Run;
var
   prv: integer;
   effectframetimetime, frametimetime: longword;
   meff: TFlyingAxe;
   bofly: Boolean;
   tx, ty, i : integer;
begin
   m_btDir := 0;
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTime:= Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            //µ¿ÀÛÀÌ ³¡³².
            m_nCurrentAction := 0; //µ¿ÀÛ ¿Ï·á
            m_boUseEffect := FALSE;
            bo260 := FALSE;
         end;

         if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame = 4) then begin
            PlayScene.NewMagic (self, MAGIC_FIREBURN, MAGIC_FIREBURN, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY, 0, mtThunder, FALSE, 30, bofly);
            PlaySound(8222);
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end
    else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TDragonStatue.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);
begin
   inherited DrawEff(dsurface, dx, dy);
   if g_boEffect then begin
   if m_boUseEffect then
      if EffectSurface <> nil then begin
         DrawBlend (dsurface,
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    EffectSurface, 1);
      end;
   end;
end;


{TExplosionMon }

procedure TExplosionMon.Run;    //Æø¸¶¾ßÂ÷
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   meff: TFlyingStone;
   bo11:Boolean;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
            meff := TFlyingStone (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mtFlyStone));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[29];
               meff.NextFrameTime := 50;
               meff.FlyImageBase:= 1040;
            end;

                PlayScene.NewMagic (self,
                                      MAGIC_EXPLOSIN, //11,
                                      MAGIC_EXPLOSIN,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bo11);
                PlaySound (2526);

         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


{TArcherMon2 }

procedure TArcherMon2.Run;    //Æø¸¶¾ßÂ÷
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   meff: TFlyingStone;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
            meff := TFlyingStone (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mtFlyStone));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[29];
               meff.NextFrameTime := 50;
               meff.FlyImageBase:= 1410;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;

{ TPBOMA1Mon }

procedure TPBOMA1Mon.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   meff: TFlyingBug;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) and (m_nCurrentFrame - m_nStartFrame = 4) then begin
            meff := TFlyingBug (PlayScene.NewFlyObject (self,
                             m_nCurrX,
                             m_nCurrY,
                             m_nTargetX,
                             m_nTargetY,
                             m_nTargetRecog,
                             mt15));
            if meff <> nil then begin
               meff.ImgLib := g_WMonImagesArr[21];
               meff.NextFrameTime := 50;
               meff.FlyImageBase:=350;
               meff.MagExplosionBase := 430;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;

{TGreatKing}   //¿°¸¶ÅÂÀÚ

procedure TGreatKing.CalcActorFrame;        //¿°¸¶ÅÂÀÚ
var
   pm: PTMonsterAction;
begin
   m_btDir:=0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace, m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_DIGUP: begin
       Shift (0, 0, 0, 1);
       m_nStartFrame:=0;
       m_nEndFrame:=9;
       m_dwFrameTime:=300;
       m_dwStartTime:=GetTickCount;
     end;
     SM_HIT: begin
       m_nStartFrame:=0;
       m_nEndFrame:=5;
       m_dwFrameTime:=120;
       m_dwStartTime:=GetTickCount;
       m_boUseEffect:=True;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;
       m_nEffectEnd:=5;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=120;
       m_nCurEffFrame:=0;
       m_boUseMagic:=True;
       m_dwWarModeTime:=GetTickcount;
       Shift (m_btDir, 0, 0, 1);

     end;
     SM_STRUCK: begin
       m_nStartFrame:=0;
       m_nEndFrame:=2;
       m_dwFrameTime:=160;
       m_dwStartTime:=GetTickCount;
     end;
     SM_84..SM_86: begin
       m_nStartFrame:=0;
       m_nEndFrame:=5;
       m_dwFrameTime:=120;
       m_dwStartTime:=GetTickCount;
       m_boUseEffect:=True;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;
       m_nEffectEnd:=5;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=120;
       m_nCurEffFrame:=0;
       m_boUseMagic:=True;
       m_dwWarModeTime:=GetTickcount;
       Shift (m_btDir, 0, 0, 1);
     end;
     SM_DEATH:
      begin
        m_nCurrentFrame := 0;
        m_nStartFrame:=80;
        m_nEndFrame:=81;
        m_boUseEffect:=FALSE;
        m_boDelActionAfterFinished := TRUE;
      end;
     SM_NOWDEATH:
      begin
        m_nCurrentFrame := 0;
        m_nStartFrame:=80;
        m_nEndFrame:=81;
        m_nCurrentFrame := 0;
        m_boUseEffect:=FALSE;
        m_boDelActionAfterFinished := TRUE;
      end;
   end;
end;

constructor TGreatKing.Create;                 //¿°¸¶ÅÂÀÚ
begin
  inherited;
  n270:=nil;
end;

procedure TGreatKing.DrawEff(dsurface: TDirectDrawSurface; dx,   //¿°¸¶ÅÂÀÚ
  dy: integer);
begin
  if m_boDeath then exit;
  inherited;
  if m_boUseEffect and (n270 <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n270, 1);
  end;
end;

procedure TGreatKing.LoadSurface;           //ÆÄÃµ¸¶·æ
begin
   inherited;

   if (not m_boReverseFrame) then begin
       case m_nCurrentAction of
         SM_HIT: begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (3470 + m_nCurrentFrame, m_nPx, m_nPy);
         end;

         SM_84..SM_86: begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (3470 + m_nCurrentFrame, m_nPx, m_nPy);
         end;

         else begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (GetOffset (m_wAppearance) + m_nCurrentFrame, m_nPx, m_nPy);
         end;
       end;
     end else begin
       case m_nCurrentAction of
         SM_HIT: begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (3470 + m_nEndFrame - m_nCurrentFrame, ax, ay);
         end;
         SM_84..SM_86: begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (3470 + m_nEndFrame - m_nCurrentFrame, ax, ay);
         end;
         else begin
           m_BodySurface := g_WMonImagesArr[30].GetCachedImage (GetOffset (m_wAppearance) + m_nEndFrame - m_nCurrentFrame, m_nPx, m_nPy);
         end;
       end;
   end;

   if m_boUseEffect then begin
     case m_nCurrentAction of
       SM_HIT: begin
         n270 := g_WMonImagesArr[30].GetCachedImage (3510 + m_nEffectFrame, ax, ay);
       end;
       SM_84: begin
         n270 := g_WMonImagesArr[30].GetCachedImage (3510 + m_nEffectFrame, ax, ay);
       end;
       SM_85: begin
         n270 := g_WMonImagesArr[30].GetCachedImage (3510 + m_nEffectFrame, ax, ay);
       end;
       SM_86: begin
         n270 := g_WMonImagesArr[30].GetCachedImage (3510 + m_nEffectFrame, ax, ay);
       end;
       else begin
         n270 := g_WMonImagesArr[30].GetCachedImage (3510 + m_nEffectFrame, ax, ay);
       end;

     end;
   end;


end;

procedure TGreatKing.Run;         //¿°¸¶ÅÂÀÚ
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;
   if m_boRunSound then begin
     m_boRunSound:=False;
   end;

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if (m_nCurrentAction = SM_84) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
              PlayScene.NewMagic (Self,84,84,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,100,bo11);
              PlaySound(3247);
           end;
         end;
         if (m_nCurrentAction = SM_85) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
              PlayScene.NewMagic (Self,85,85,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,100,bo11);
              PlaySound(3248);
           end;
         end;
         if (m_nCurrentAction = SM_86) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
              PlayScene.NewMagic (Self,86,86,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,True,100,bo11);
              PlaySound(3249);
           end;
         end;

      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;




{TBossTreeMan}

procedure TBossTreeMan.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_btDir:=0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of

     SM_DIGUP: begin
       Shift (0, 0, 0, 1);
       m_nStartFrame:=0;
       m_nEndFrame:=9;
       m_dwFrameTime:=300;
       m_dwStartTime:=GetTickCount;
     end;
     SM_HIT: begin
       m_nStartFrame:=0;
       m_nEndFrame:=10;
       m_dwFrameTime:=100;
       m_dwStartTime:=GetTickCount;
       m_boUseEffect:=True;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;
       m_nEffectEnd:=10;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=100;
       m_nCurEffFrame:=0;
       m_boUseMagic:=True;
       m_dwWarModeTime:=GetTickcount;
       Shift (m_btDir, 0, 0, 1);

     end;
     SM_STRUCK: begin
       m_nStartFrame:=0;
       m_nEndFrame:=3;
       m_dwFrameTime:=120;
       m_dwStartTime:=GetTickCount;
     end;
     SM_LIGHTING: begin
       m_nStartFrame:=0;
       m_nEndFrame:=10;
       m_dwFrameTime:=100;
       m_dwStartTime:=GetTickCount;
       m_boUseEffect:=True;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;
       m_nEffectEnd:=15;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=100;
       m_nCurEffFrame:=0;
       m_boUseMagic:=True;
       m_dwWarModeTime:=GetTickcount;
       Shift (m_btDir, 0, 0, 1);
       PlaySound(3858);
     end;
     SM_DEATH:
      begin
        m_nCurrentFrame := 0;
        m_nStartFrame:=40;
        m_nEndFrame:=50;
        m_boUseEffect:=FALSE;
        m_boDelActionAfterFinished := TRUE;
      end;
     SM_NOWDEATH:
      begin
        m_nCurrentFrame := 0;
        m_nStartFrame:=40;
        m_nEndFrame:=50;
        m_nCurrentFrame := 0;
        m_boUseEffect:=FALSE;
        m_boDelActionAfterFinished := TRUE;
      end;

   end;
end;

constructor TBossTreeMan.Create;
begin
  inherited;
  n270:=nil;
end;

procedure TBossTreeMan.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  if m_boDeath then exit;
  inherited;
  if g_boEffect then begin
  if m_boUseEffect and (n270 <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n270, 1);
  end;
  end;
end;

procedure TBossTreeMan.LoadSurface;
var
  mimg:TWMImages;
begin

   mimg := g_WMonImagesArr[36];

   if mimg = nil then exit;
     if (not m_boReverseFrame) then begin
       case m_nCurrentAction of
         SM_HIT,SM_LIGHTING: begin
           m_BodySurface := mimg.GetCachedImage (3320 + m_nCurrentFrame, m_nPx, m_nPy);
         end;

         else begin
           m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nCurrentFrame, m_nPx, m_nPy);
         end;
       end;
     end else begin
       case m_nCurrentAction of
         SM_HIT,SM_LIGHTING: begin
           m_BodySurface := mimg.GetCachedImage (3320 + m_nEndFrame - m_nCurrentFrame, ax, ay);
         end;

         else begin
           m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nEndFrame - m_nCurrentFrame, m_nPx, m_nPy);
         end;
       end;
     end;


   if m_boUseEffect then begin
     case m_nCurrentAction of
       SM_HIT: begin
         m_boUseEffect := FALSE;
       end;
       SM_LIGHTING: begin
         n270 := g_WMonImagesArr[36].GetCachedImage (3410 + m_nEffectFrame, ax, ay);
       end;
     end;
   end;


end;

procedure TBossTreeMan.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
begin

   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;
   if m_boRunSound then begin
     m_boRunSound:=False;
   end;

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;



{ TElectBossMon }

constructor TElectBossMon.Create;        //¿À¸¶Á¦»çÀå
begin
  inherited Create;
  n26C:=nil;
end;

destructor TElectBossMon.Destroy;       //¿À¸¶Á¦»çÀå
begin
   inherited Destroy;
end;

procedure TElectBossMon.LoadSurface;        //¿À¸¶Á¦»çÀå
begin
  inherited;
  if bo260 then begin
    case m_btRace of


      205: begin    //¿À¸¶Èæ·É
       bo260 := False;    //Á×À½ ÀÌÆÑ x
       m_boUseEffect := False;
      end;

    end;
  end else begin
    if m_boUseEffect then begin
      case m_btRace of



        205: begin  //¿À¸¶Èæ·É
             case m_nCurrentAction of
               SM_HIT: begin     //ÀÏ¹Ý°ø°Ý
                n26C := g_WMonImagesArr[37].GetCachedImage (
                            5770 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;
               SM_LIGHTING: begin   //ÀüÃ¼°ø°Ý
                n26C := g_WMonImagesArr[37].GetCachedImage (
                            5850 + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;


               SM_LIGHTING_1: begin   //´ë»ó 5x5
                  n26C := g_WMonImagesArr[37].GetCachedImage (
                            5890 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                            ax, ay);
               end;

               SM_LIGHTING_2: begin  //¿ø°Å¸® 1ÀÎ °ø°Ý
                  m_boUseEffect:= False;
               end;

               SM_LIGHTING_3: begin
                 m_boUseEffect:= False;
               end;

             end;
         end;

      end;
    end;
  end;
end;

procedure TElectBossMon.CalcActorFrame;           //¿À¸¶Á¦»çÀå
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_HIT: begin
       Shift (m_btDir, 0, 0, 1);
       m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;


     end;
     SM_STRUCK: begin
       m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
       m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
       m_dwFrameTime := pm.ActStruck.ftime;
       m_dwStartTime := GetTickCount;
       PlaySound(3944);
     end;

     SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       PlaySound(3945);
     end;


     SM_LIGHTING_1,
     SM_LIGHTING: begin

       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_nCurEffFrame:=0;
       m_boUseEffect := TRUE;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;


     end;
     SM_LIGHTING_2:
         begin
              m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical2.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;


         end;
     SM_LIGHTING_3:
         begin
              m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
              m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
              m_dwFrameTime := pm.ActCritical3.ftime;
              m_dwStartTime := GetTickCount;
              m_nCurEffFrame:=0;
              m_boUseEffect := TRUE;
              m_dwWarModeTime := GetTickCount;
              Shift (m_btDir, 0, 0, 1);
              m_boUseEffect := TRUE;
              m_nEffectFrame := m_nStartFrame;
              m_nEffectStart := m_nStartFrame;
              m_nEffectEnd := m_nEndFrame;
              m_dwEffectStartTime := GetTickCount;
              m_dwEffectFrameTime := m_dwFrameTime;


          end;

     else begin
       inherited CalcActorFrame;
     end;
   end;

end;


procedure TElectBossMon.Run;             //¿À¸¶Á¦»çÀå
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   meff: TFlyingFireBall;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN)or (m_nCurrentAction = SM_HORSERUN)  then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if (m_nCurrentAction = SM_HIT) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_3) and (m_nCurrentFrame-m_nStartFrame = 1)then begin
             PlayScene.NewMagic (self, MAGIC_MED_ATT1_2,MAGIC_MED_ATT1_2,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bo11);
             PlaySound (3748);
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 4)then begin

         end;
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 4) then begin

         end;
         if m_nCurrentAction = SM_LIGHTING then begin

         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;



procedure TElectBossMon.DrawEff(dsurface: TDirectDrawSurface; dx,   //¿À¸¶Á¦»çÀå
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);
  if g_boEffect then begin
  if m_boUseEffect and (n26C <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,n26C, 1);
  end;
  end;
end;


//ÆÄÃµ¸¶·æ(È­·æ) -------------------------------------------------------------------------------
constructor TFireDragon.Create;     //¸¶·æ
begin
   inherited Create;

   AttackEffectSurface := nil;
   LightningTimer := TTimer.Create (nil);  //ÆÄÃµ¸¶·æ
   LightningTimer.Interval := 70;
   LightningTimer.Tag := 0;
   LightningTimer.OnTimer := LightningTimerTimer;
   LightningTimer.Enabled := False; //FireDragon
   m_nDownDrawLevel := 1;
end;

destructor TFireDragon.Destroy;       //¸¶·æ
begin

   if LightningTimer <> nil then LightningTimer.Free;

   inherited Destroy;

end;

procedure  TFireDragon.LoadSurface;    //¸¶·æ
var
   mimg: TWMImages;
begin
   mimg := g_WDragonImg;


   if mimg <> nil then begin
      if (not m_boReverseFrame) then begin
             case m_nCurrentAction of
                SM_LIGHTING:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 40+ m_ncurrentframe, m_npx, m_npy);
                SM_81: // FireDragon
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 10+ m_ncurrentframe, m_npx, m_npy);
                SM_82:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 20+ m_ncurrentframe, m_npx, m_npy);
                SM_83:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 30+ m_ncurrentframe, m_npx, m_npy);
                else
                   m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_ncurrentframe, m_npx, m_npy);
             end;
      end
      else begin
             case m_nCurrentAction of
                SM_LIGHTING:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 40+ m_nendframe - m_ncurrentframe, ax, ay);
                SM_81: // FireDragon
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 10+ m_nendframe - m_ncurrentframe, ax, ay);
                SM_82:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 20+ m_nendframe - m_ncurrentframe, ax, ay);
                SM_83:
                   m_BodySurface := g_WDragonImg.GetCachedImage ( 30+ m_nendframe - m_ncurrentframe, ax, ay);
                else
                   m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nendframe - m_ncurrentframe, m_npx, m_npy);
             end;
      end;
   end;

   if m_BoUseEffect then begin
          case m_nCurrentAction of
             SM_LIGHTING:
                AttackEffectSurface := g_WDragonImg.GetCachedImage ( 60+ m_neffectframe, ax, ay);
             SM_81: // FireDragon
                AttackEffectSurface := g_WDragonImg.GetCachedImage ( 90+ m_neffectframe, ax, ay);
             SM_82:
                AttackEffectSurface := g_WDragonImg.GetCachedImage (100+ m_neffectframe, ax, ay);
             SM_83:
                AttackEffectSurface := g_WDragonImg.GetCachedImage (110+ m_neffectframe, ax, ay);
          end;
   end;
   if m_btRace = 83 then begin
      m_npx := m_npx - 14;
      m_npy := m_npy - 15;
      ax := ax - 14;
      ay := ay - 15;
   end;

end;

procedure TFireDragon.CalcActorFrame;       //¸¶·æ
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
//   startframe2: integer;
begin
   m_btDir := 0;
   m_ncurrentframe := -1;

   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPm (m_btRace, m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of

      SM_TURN:
         begin
            starttime := GetTickCount;
            m_ndefframecount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);

         end;
      SM_WALK, SM_BACKSTEP:
         begin

         end;
      SM_HIT:    // ±Ù°Å¸® °ø°Ý
         begin

         end;

      SM_LIGHTING,SM_LIGHTING_1..SM_LIGHTING_3:
         begin
            m_nstartframe := 0;
            m_nendframe   := 19;
            m_dwframetime  := 150;

            starttime  := GetTickCount;

            m_BoUseEffect := TRUE;
            m_neffectframe := 0;
            m_neffectstart := 0;

            m_neffectend   := 19;
            m_dweffectstarttime := GetTickCount;
            m_dweffectframetime := 150;

            m_nCurEffFrame := 0;
            m_BoUseMagic := TRUE;
            m_dwWarModeTime := GetTickCount;
            Shift (m_btDir, 0, 0, 1);
         end;
      SM_81, SM_82, SM_83:
         begin
            if m_btRace = 83 then begin
               m_nstartframe := 0;
               m_nendframe   := 5;
               m_dwframetime  := 150;
               starttime  := GetTickCount;

               m_BoUseEffect := TRUE;
               m_neffectframe := 0;
               m_neffectstart := 0;

               m_neffectend   := 10;
               m_dweffectstarttime := GetTickCount;
               m_dweffectframetime := 150;

               m_nCurEffFrame := 0;
               m_BoUseMagic := TRUE;
               m_dwWarModeTime := GetTickCount;
               Shift (m_btDir, 0, 0, 1);
            end;
         end;
      SM_STRUCK:
         begin
            if m_btRace = 83 then begin
               m_nstartframe := 0;
               m_nendframe := 9;
               m_dwframetime := 300; //pm.ActStruck.ftime;
               starttime := GetTickCount;
            end;
         end;
      SM_NOWDEATH:
         begin

         end;
      SM_DEATH:
         begin

         end;
      SM_DIGUP: //°È±â ¾øÀ½, SM_DIGUP, ¹æÇâ ¾øÀ½.
         begin
            if m_btRace = 83 then begin
               //WarMode := FALSE;
               Shift (0, 0, 0, 1);
               m_nstartframe := 0;
               m_nendframe := 9;
               m_dwframetime := 300;
               starttime := GetTickCount;
            end;
         end;
   end;

end;


procedure TFireDragon.Run;                 //¸¶·æ
var
   prv: integer;
   effectframetimetime, frametimetime: longword;
   meff: TFlyingAxe;
   bofly: Boolean;
   tx, ty, i : integer;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   //»ç¿îµå È¿°ú
   if m_borunsound then begin
      PlaySound(8201);
      m_borunsound := False;
    end;

   if m_BoUseEffect then begin
      if m_boMsgMuch then effectframetimetime := Round(m_dweffectframetime * 2 / 3)
      else effectframetimetime := m_dweffectframetime;
      if GetTickCount - m_dweffectstarttime > effectframetimetime then begin
         m_dweffectstarttime := GetTickCount;
         if m_neffectframe < m_neffectend then begin
            Inc (m_neffectframe);
         end else begin
             m_BoUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_ncurrentframe;
   if m_nCurrentAction <> 0 then begin
      if (m_ncurrentframe < m_nstartframe) or (m_ncurrentframe > m_nendframe) then
         m_ncurrentframe := m_nstartframe;

      if m_boMsgMuch then frametimetime := Round(m_dwframetime * 2 / 3)
      else frametimetime := m_dwframetime;

      if GetTickCount - starttime > frametimetime then begin
         if m_ncurrentframe < m_nendframe then begin
            Inc (m_ncurrentframe);
            starttime := GetTickCount;
         end else begin
            //µ¿ÀÛÀÌ ³¡³².
            m_nCurrentAction := 0; //µ¿ÀÛ ¿Ï·á
            m_BoUseEffect := FALSE;
        //    BoUseDieEffect := FALSE;
         end;


         if (m_nCurrentAction = SM_LIGHTING) and (m_ncurrentframe-m_nstartframe = 4) then begin
            PlaySound (8202);
            LightningTimer.Enabled := True;
         end else
         if ((m_nCurrentAction = SM_81) or (m_nCurrentAction = SM_82) or (m_nCurrentAction = SM_83))
             and (m_ncurrentframe-m_nstartframe = 4) then begin

                PlayScene.NewMagic (self,
                                      m_nCurrentAction, //11,
                                      m_nCurrentAction,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtFly,
                                      TRUE,
                                      30,
                                      bofly);
                PlaySound (8203);
         end;
      end;
      m_ncurrentdefframe := 0;
      m_dwdefframetime := GetTickCount;
   end else begin
      if GetTickCount - m_dwsmoothmovetime > 200 then begin
         if GetTickCount - m_dwdefframetime > 500 then begin
            m_dwdefframetime := GetTickCount;
            Inc (m_ncurrentdefframe);
            if m_ncurrentdefframe >= m_ndefframecount then
               m_ncurrentdefframe := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_ncurrentframe then begin
      m_dwloadsurfacetime := GetTickCount;
      LoadSurface;
   end;
end;


procedure TFireDragon.LightningTimerTimer(Sender: TObject);  //¸¶·æ
var
   tx, ty, n, kx, ky : integer;
   bofly: Boolean;
begin

    if m_btRace = 83 then begin
       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 800;
          Exit;
       end
       else LightningTimer.Interval := 70;
       tx := m_nCurrX - 5;
       ty := m_nCurrY + 3;



       Randomize;
       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx-3, ty+3, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx-3, ty-3, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+2, ty+1, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+3, ty-2, 0, mtThunder, FALSE, 30, bofly);
       end;

       n := random(4);
       kx := random(7);
       ky := random(5);
       case n of
          0: begin PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+kx-2, ty-ky+1, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx-kx+3, ty-ky+1, 0, mtThunder, FALSE, 30, bofly); end;
          1: begin PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx-kx,   ty+ky, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+kx+2, ty+ky, 0, mtThunder, FALSE, 30, bofly);   end;
          2: begin PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx-kx,   ty-ky+1, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+kx+3, ty+ky-1, 0, mtThunder, FALSE, 30, bofly); end;
          3: begin PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+kx-2, ty+ky, 0, mtThunder, FALSE, 30, bofly);
                   PlayScene.NewMagic (self, SM_DRAGON_LIGHTING, SM_DRAGON_LIGHTING, m_nCurrX, m_nCurrY, tx+kx+3, ty+ky+2, 0, mtThunder, FALSE, 30, bofly); end;
       end;

       if (LightningTimer.Tag mod 3) = 0 then PlaySound (8206);
       LightningTimer.Interval := LightningTimer.Interval + 15;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 70;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
    end;


end;

procedure TFireDragon.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);   //¸¶·æ
begin
   inherited DrawEff(dsurface, dx, dy);
   if (m_btRace = 83) or bo260 then begin
   if m_BoUseEffect then
      if AttackEffectSurface <> nil then begin
         DrawBlend (dsurface,
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    AttackEffectSurface, 1);
      end;
   end;
end;


constructor TKhazardMon.Create;
begin
  inherited;
end;

procedure TKhazardMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
     end;
     else begin
      inherited;
     end;
   end;
end;

constructor TFrostTiger.Create;        //È¯¿µÇÑÈ£
begin
  inherited;
  boActive:=FALSE;
  boCasted:=FALSE;
end;

procedure TFrostTiger.CalcActorFrame;     //È¯¿µÇÑÈ£
var
   pm: PTMonsterAction;
begin
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      boCasted:=TRUE;
      Shift (m_btDir, 0, 0, 1);
    end;
    SM_DIGDOWN: begin
      m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDeath.frame - 1;
      m_dwFrameTime := pm.ActDeath.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      boActive:=FALSE;
    end;
    SM_DIGUP: boActive:=TRUE;
    SM_WALK: begin
      boActive:=TRUE;
      inherited;
    end;
    SM_DEATH:
         begin
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_nStartFrame := m_nEndFrame; //
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwFrameTime := 160; //È¯¿µÇÑÈ£ ÇÁ·¹ÀÓ¼Óµµ
            m_dwStartTime := GetTickCount;
         end;
      SM_NOWDEATH:
         begin
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_dwFrameTime := pm.ActDie.ftime;
            m_dwStartTime := GetTickCount;
         end;
    else begin
      inherited;
    end;
  end;
end;

procedure TFrostTiger.Run;             //È¯¿µÇÑÈ£
var
  bo11:boolean;
begin
  if (m_nCurrentAction = SM_LIGHTING) and (boCasted=TRUE) then begin
    boCasted:=FALSE;
    PlayScene.NewMagic (Self,1,39,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,False,30,bo11);
    PlaySound(m_nMagicFireSound);
  end;
  inherited;
end;

function  TFrostTiger.GetDefaultFrame (wmode: Boolean): integer;     //È¯¿µÇÑÈ£
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
  Result:=0;
  if boActive = FALSE then begin
    pm := GetRaceByPM (m_btRace,m_wAppearance);
    if pm = nil then exit;
    if m_boDeath then begin
      m_boUseEffect := False;
      inherited GetDefaultFrame(wmode);
      exit;
    end;
    m_nDefFrameCount := pm.ActDeath.frame;
    if m_nCurrentDefFrame < 0 then cf := 0
    else if m_nCurrentDefFrame >= pm.ActDeath.frame then cf := 0
    else cf := m_nCurrentDefFrame;
    Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip) + cf;
  end else
    Result:= inherited GetDefaultFrame(wmode);
end;

constructor TJumaThunderMon.Create;
begin
   inherited Create;
   m_boUseEffect := True;
   AttackEffectSurface := nil;
   EffBackSurface := nil;
   EffectSurface := nil;
end;


procedure TJumaThunderMon.LoadSurface;
begin
  inherited LoadSurface;
  case m_btRace of
      //¸ó½ºÅÍ
      104:
         begin
            if m_boUseEffect then begin
               EffectSurface := g_WMonImagesArr[22].GetCachedImage (m_nEffectFrame, ax, ay);
            end;
         end;
      155:
         begin
            if m_boUseEffect then begin
               EffectSurface := g_WMonImagesArr[26].GetCachedImage (m_nEffectFrame, ax, ay);
            end;
            if m_nCurrentAction <> SM_DEATH then begin
              EffBackSurface := g_WEffectImg.GetCachedImage(601, ex, ey);
            end else  EffBackSurface := nil;
         end;
   end;

end;


procedure TJumaThunderMon.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

    case m_nCurrentAction of
      SM_HIT, // ±Ù°Å¸® °ø°Ý
      SM_FLYAXE:
         begin
            m_boUseEffect := TRUE;
            m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
            m_nEndFrame  := m_nStartFrame + pm.ActAttack.frame - 1;
            m_dwFrameTime := 110;
            m_dwStartTime := GetTickCount;

            m_dwWarModeTime := GetTickCount;
            Shift (m_btDir, 0, 0, 1);
            m_boUseEffect := TRUE;
            if m_btRace = 104 then begin
              m_nEffectFrame := 1100 + m_btDir * 10;
              m_nEffectStart := 1100 + m_btDir * 10;
            end else begin
              m_nEffectFrame := 3810 + m_btDir * 10;
              m_nEffectStart := 3810 + m_btDir * 10;
            end;
            m_nEffectEnd := m_nEffectStart + pm.ActAttack.frame-1;//endframe;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;
         end;

      SM_TURN:
         begin
            if (m_nState and STATE_STONE_MODE) <> 0 then begin
               m_boUseEffect := False;
               m_nStartFrame := 420 + m_btDir * 10;
               m_nEndFrame := m_nStartFrame;
               m_dwFrameTime := 100;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := 6;
            end else begin
               m_boUseEffect := True;
               m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
               m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
               m_dwFrameTime := 250;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := pm.ActStand.frame;
               if m_btRace = 104 then begin
                 m_nEffectFrame := 940 + m_btDir * 10;
                 m_nEffectStart := 940 + m_btDir * 10;
               end else begin
                 m_nEffectFrame := 3650 + m_btDir * 10;
                 m_nEffectStart := 3650 + m_btDir * 10;
               end;
               m_nEffectEnd := m_nEffectStart + pm.ActStand.frame-1;//endframe;
               m_dwEffectStartTime := GetTickCount;
               m_dwEffectFrameTime := m_dwFrameTime;
            end;

            Shift (m_btDir, 0, 0, 1);
         end;
      SM_WALK, SM_BACKSTEP:
         begin
            m_boUseEffect := TRUE;
            m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
            m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
            m_dwFrameTime := 160; //pm.ActWalk.ftime;
            m_dwStartTime := GetTickCount;
            if m_btRace = 104 then begin
              m_nEffectFrame := 1020 + m_btDir * 10;;
              m_nEffectStart := 1020 + m_btDir * 10;;
            end else begin
              m_nEffectFrame := 3730 + m_btDir * 10;;
              m_nEffectStart := 3720 + m_btDir * 10;;
            end;
            m_nEffectEnd := m_nEffectStart + pm.ActWalk.frame-1;//endframe;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;

            //WarMode := FALSE;
            m_nMoveStep := 1;
            if m_nCurrentAction = SM_WALK then begin
               Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
            end
            else begin  //sm_backstep
               Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
            end;
         end;

      SM_DIGUP: //°È±â ¾øÀ½, SM_DIGUP, ¹æÇâ ¾øÀ½.
         begin
            m_nStartFrame := 420 + m_btDir * 10;
            m_nEndFrame := m_nStartFrame + 5;
            m_dwFrameTime := 150;
            m_dwStartTime := GetTickCount;
            //WarMode := FALSE;
            Shift (m_btDir, 0, 0, 1);
         end;

      SM_STRUCK:
         begin
            m_boUseEffect := TRUE;
            m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
            m_dwFrameTime := 90; //pm.ActStruck.ftime;
            m_dwStartTime := GetTickCount;
            if m_btRace = 104 then begin
              m_nEffectFrame := 1180 + m_btDir * 10;
              m_nEffectStart := 1180 + m_btDir * 10;
            end else begin
              m_nEffectFrame := 3890 + m_btDir * 10;
              m_nEffectStart := 3890 + m_btDir * 10;
            end;
            m_nEffectEnd := m_nEffectStart + pm.ActStruck.frame-1;//endframe;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;
         end;

      SM_DEATH:
         begin
            m_boUseEffect := False;
            m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
            m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
            m_nStartFrame := m_nEndFrame; //
            m_dwFrameTime := 100;
            m_dwStartTime := GetTickCount;
         end;

      SM_LIGHTING:
         begin
            m_boUseEffect := TRUE;
            m_nStartFrame := 340 + m_btDir * 10;
            m_nEndFrame   := m_nStartFrame + 5;
            m_dwFrameTime  := 180;
            m_dwStartTime  := GetTickCount;
            m_nCurEffFrame := 0;
            m_boUseMagic := TRUE;
            m_dwWarModeTime := GetTickCount;
            Shift (m_btDir, 0, 0, 1);
            if m_btRace = 104 then begin
              m_nEffectFrame := 1200 + m_btDir * 10;
              m_nEffectStart := 1200 + m_btDir * 10;
            end else begin
              m_nEffectFrame := 3910 + m_btDir * 10;
              m_nEffectStart := 3910 + m_btDir * 10;
            end;
            m_nEffectEnd := m_nEffectStart + 5;//endframe;
            m_dwEffectStartTime := GetTickCount;
            m_dwEffectFrameTime := m_dwFrameTime;
         end;
      else
         inherited CalcActorFrame;
   end;
end;


procedure TJumaThunderMon.DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer);
var
   idx: integer;
   d: TDirectDrawSurface;
begin
   if g_BoEffect then begin
      if EffBackSurface <> nil then begin
         DrawBlend (dsurface,     //DrawBlend3  2
                    dx + ex + m_nShiftX,
                    dy + ey + m_nShiftY,
                    EffBackSurface, 1);
      end;
   end;
end;


procedure TJumaThunderMon.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);
var
   idx: integer;
   d: TDirectDrawSurface;
begin
   if g_BoEffect then begin
   if m_boUseEffect then
      if EffectSurface <> nil then begin
         DrawBlend (dsurface,
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    EffectSurface, 1);
      end;
   end;
end;



procedure TYimoogi.CalcActorFrame;   //ºÎ·æ±Ý»ç
var
   pm: PTMonsterAction;
begin
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_FLYAXE: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=6;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActCritical.ftime;
      m_nCurEffFrame:=0;
    end;
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=2;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActAttack.ftime;
      m_nCurEffFrame:=0;
    end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
    end;
    SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 10;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
     end;
    else begin
      inherited;
    end;
  end;
end;

procedure TYimoogi.LoadSurface;
var
  bo11:boolean;
  Meff:TMagicEff;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      AttackEffectSurface := nil;
      if (m_nEffectFrame = 1) then begin
        meff := TObjectEffects.Create(self,g_WMagic2Images,1330,10,100,TRUE);
        meff.ImgLib := g_WMagic2Images;
        PlayScene.m_EffectList.Add (meff);
      end;
    end;
    SM_FLYAXE: begin
      AttackEffectSurface := g_WMonImagesArr[22].GetCachedImage (
                        2820 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
      if (m_nEffectFrame = 3) then begin
        PlayScene.NewMagic (Self,93,93,m_nCurrX,m_nCurrY,m_nCurrX,m_nCurrY,0,mtExplosion,False,30,bo11);
           //PlaySound(8222);
      end;
    end;
    SM_NOWDEATH: begin
         AttackEffectSurface := g_WMonImagesArr[22].GetCachedImage (
                                2900 + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
    end;
  end;
end;


procedure TGuardianRock.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_btDir:=0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_HIT: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=3;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActAttack.ftime;
     // m_nCurEffFrame:=50;
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TBlackFox.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);

      if m_btRace = 109 then begin
       m_boUseEffect := TRUE;
       m_nEffectFrame := 350 + m_btDir * 10;
       m_nEffectStart := m_nEffectFrame;
       m_nEffectEnd   := m_nEffectFrame+5;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwframetime;
       PlaySound (2506);
      end;

      if m_btRace = 136 then begin
       PlaySound (3406);
      end;
    end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
    end;
    SM_NOWDEATH: begin
      if m_btRace = 109 then begin
       m_nStartFrame := pm.ActDie.start;
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 10;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
      end;
      if m_btRace = 136 then begin //¸ê±Í
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 10;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
      end;
     end;
    else begin
      inherited;
    end;
  end;
end;

procedure TBlackFox.LoadSurface;
begin
  inherited;
  if m_btRace = 109 then begin
   case m_nCurrentAction of
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                        350 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);

    end;
    SM_NOWDEATH: begin
         AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                                340 + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
    end;
   end;
  end;

  if m_btRace = 136 then begin   //¸ê±Í
   case m_nCurrentAction of
    SM_NOWDEATH: begin
         AttackEffectSurface := g_WMonImagesArr[32].GetCachedImage (
                                440 + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
    end;
   end;
  end;
end;

procedure TGuardianRock.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
         AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                        1435 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

constructor TRedeffect.Create;
begin
  inherited Create;
   m_boUseEffect := True;
   EffectSurface := nil;
end;

procedure TRedeffect.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;

   case m_nCurrentAction of
      SM_TURN: begin
           if (m_nState and STATE_STONE_MODE) <> 0 then begin
             m_boUseEffect := False;
             m_nStartFrame := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
             m_nEndFrame := m_nStartFrame;
             m_dwFrameTime := pm.ActDeath.ftime;
             m_dwStartTime := GetTickCount;
             m_nDefFrameCount := pm.ActDeath.frame;
           end else begin
             m_boUseEffect := TRUE;
             m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
             m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
             m_dwFrameTime := pm.ActStand.ftime;
             m_dwStartTime := GetTickCount;
             m_nDefFrameCount := pm.ActStand.frame;
           end;
           Shift(m_btDir, 0, 0, 1);
        end;
     SM_HIT, SM_LIGHTING: // ±Ù°Å¸® °ø°Ý
         begin
            m_boUseEffect := TRUE;
            m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
            m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
            m_dwFrameTime := pm.ActAttack.ftime;
            m_dwStartTime := GetTickCount;
             m_boUseEffect := True;
           Shift(m_btDir, 0, 0, 1);
         end;
      else
      inherited;
  end;
end;



procedure TRedEffect.DrawEff (dsurface: TDirectDrawSurface; dx, dy: integer);
begin
 //
end;

procedure TRedEffect.DrawBackEff (dsurface: TDirectDrawSurface; dx, dy: integer);
var
   idx: integer;
   d: TDirectDrawSurface;
begin
   if g_BoEffect then begin
   if m_boUseEffect then
      if EffectSurface <> nil then begin
         DrawBlend (dsurface,                 //DrawBlend3
                    dx + ax + m_nShiftX,
                    dy + ay + m_nShiftY,
                    EffectSurface, 1);
      end;
   end;
end;


procedure TRedeffect.LoadSurface;
begin
   inherited LoadSurface;
   case m_btRace of
      //¸ó½ºÅÍ
      150:
         begin
           EffectSurface := g_WEffectImg.GetCachedImage (600, ax, ay);
         end;
      151:
         begin
           EffectSurface := g_WEffectImg.GetCachedImage (601, ax, ay);
         end;
   end;
end;


{ TExplosionSpider2 }

procedure TExplosionSpider2.CalcActorFrame;
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
      m_boUseEffect:=False;
    end;
    SM_NOWDEATH: begin
      m_nEffectStart:=m_nStartFrame;
      m_nEffectFrame:=m_nStartFrame;
      m_dwEffectStartTime:=GetTickCount();
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectEnd:=m_nEndFrame;
      m_boUseEffect:=True;
    end;
  end;
end;

procedure TExplosionSpider2.LoadSurface;
begin
  inherited;
  if m_boUseEffect then
    AttackEffectSurface := g_WMonImagesArr[13].GetCachedImage (
                        730 + m_nEffectFrame-m_nEffectStart,
                        ax, ay);
end;

procedure TGumimasin.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_HIT: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=pm.ActAttack.start;
      m_nEffectFrame:=pm.ActAttack.start;
      m_nEffectEnd:=pm.ActAttack.start + pm.ActAttack.frame -1;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;;
      m_nCurEffFrame:=150;
  //    PlaySound(2788);
    end;
    SM_LIGHTING: begin
     m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
   //   PlaySound(2786);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TGumimasin.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
begin
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
          //  bo260:=False;
         end;
         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             if (m_btRace = 157) then begin //leftguard
               PlayScene.NewMagic (Self,7,9,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtGumizul2,False,30,bo11);
               PlaySound(10112);
             end;
            end;
           end;
          end;
         end;
end;


procedure TGumimasin.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
         m_boUseEffect := TRUE;
         AttackEffectSurface := g_WMonImagesArr[25].GetCachedImage (
                                2950  + m_nEffectFrame - m_nEffectStart,
                                ax, ay);
    end;
    SM_LIGHTING: begin
         m_boUseEffect := TRUE;
         AttackEffectSurface := g_WMonImagesArr[10].GetCachedImage (
                                2904  + m_nEffectFrame - m_nEffectStart,
                                ax, ay);
    end;
  end;
end;



procedure TElement.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
  bo11: Boolean;
begin
//  m_btDir:=0;
  if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

  if n278 <> nil then begin
    DrawBlend (dsurface, dx + n270 + m_nShiftX, dy + n274 + m_nShiftY, n278, 1);
  end;
  ceff := GetDrawEffectValue;

  if m_BodySurface <> nil then begin
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  end;
end;

procedure TElement.LoadSurface;
var
   mimg: TWMImages;
begin
   mimg := GetMonImg (m_wAppearance);
   if mimg <> nil then begin
       m_BodySurface := mimg.GetCachedImage (
                            1450 + m_nCurrentFrame,
                            m_nPx, m_nPy);
       n278 := mimg.GetCachedImage (
                            1500 + m_nCurrentFrame,
                            n270, n274);
  end;
end;


{ TFireLead }

constructor TFireLead.Create;     //¿°È­Àû±Í
begin
  inherited Create;
   AttackEffectSurface:=nil;
end;

destructor TFireLead.Destroy;
begin
   inherited Destroy;
end;

procedure TFireLead.LoadSurface;
var
   mimg: TWMImages;
begin
   mimg := GetMonImg (m_wAppearance);
   m_boUseEffect :=True;
   if mimg <> nil then
   m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nCurrentFrame, m_nPx, m_nPy);

  if m_boUseEffect then begin
    if m_btRace = 101 then begin    //¿°È­Àû±Í
     AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage ( 1890+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 114 then begin    //¿­ÀåÀû±Í
     AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage ( 2820+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 121 then begin    //Ã»½Å½Ã
     AttackEffectSurface := g_WMonImagesArr[13].GetCachedImage ( 1170+340 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 123 then begin    //¿¬È¥Èæ±«¼ö
     AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage ( 1720+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 124 then begin    //°ÅµµÀû±Í
     AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage ( 3840+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 128 then begin    //ÆÐ°ËÀû±Í
     AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage ( 4770+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 129 then begin    //µ¶ÀÎÀû±Í
     AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage ( 5870+500 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 148 then begin    //°ßºù¼öÈ£Àå
     AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage ( 0+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 149 then begin    //¸¶¿°¼öÈ£Àå
     AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage ( 880+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 160 then begin    //¾ÏÈ¥¼öÈ£Àå
     AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage ( 1740+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 163 then begin    //¿­Áø¼öÈ£Àå
     AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage ( 2600+420 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 168 then begin    //°ËÀº¸ÁÄ¡±ªÀÌ
     AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage ( 2020+560 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 170 then begin    //¹«´ç±ªÀÌ
     AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage ( 4600+500 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 172 then begin    //È£Áß±Í1
     AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage ( 6030+400 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 173 then begin    //°í´ë¼öÈ£±Í
     AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage ( 5900+580 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 175 then begin    //¹¦Àå±º
     AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage ( 6920+800 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 213 then begin    //ÇÑºù¼öÈ£±Í
     AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage ( 2740+500 + m_nCurrentFrame, ax, ay);
    end;
    if m_btRace = 219 then begin    //¿À¸¶Èæ·É
     AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage ( 3850+980 + m_nCurrentFrame, ax, ay);
    end;

   if m_btRace = 101 then begin         //¿°È­Àû±Í
    case m_nCurrentAction of
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage (
                         2730 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 118 then begin         //¿ø¿À
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage (
                         4539 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage (
                         4731 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_NOWDEATH: begin
        AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage (
                         4530 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 123 then begin         //¿¬È¥Èæ±«¼ö
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[5].GetCachedImage (
                         2650 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 128 then begin         //ÆÐ°ËÀû±Í
    case m_nCurrentAction of
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[29].GetCachedImage (
                         5610 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace in [148,149,160,163] then begin         //°ßºù¼öÈ£Àå
    case m_nCurrentAction of
      SM_NOWDEATH: begin
        AttackEffectSurface := g_WMonImagesArr[30].GetCachedImage (
                         860 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 168 then begin         //°ËÀº¸ÁÄ¡±ªÀÌ
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage (
                         1850 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage (
                         3140 + (m_btDir * 20) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;


   if m_btRace = 175 then begin         //¹¦Àå±º
    case m_nCurrentAction of
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage (
                         8680 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_3: begin
        AttackEffectSurface := g_WMonImagesArr[33].GetCachedImage (
                         8760 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 213 then begin         //ÇÑºù¼öÈ£±Í
    case m_nCurrentAction of
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                         3670 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_2: begin
        AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                         3750 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;

   if m_btRace = 219 then begin         //¿À¸¶Èæ·É
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                         5772 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                         5850 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_2: begin
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                         5980 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_3: begin
        AttackEffectSurface := g_WMonImagesArr[37].GetCachedImage (
                         6010 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
    end;
   end;



  end;
end;


procedure TFireLead.CalcActorFrame;
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_TURN:
         begin
            m_dwStartTime := GetTickCount;
            m_nDefframecount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
               m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
               m_dwFrameTime := pm.ActStand.ftime;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := pm.ActStand.frame;
               Shift (m_btDir, 0, 0, 1);
     end;

      SM_WALK, SM_BACKSTEP:
         begin
               m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
               m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
               m_dwFrameTime := pm.ActWalk.ftime;
               m_dwStartTime := GetTickCount;

               m_nMoveStep := 1;
               if m_nCurrentAction = SM_WALK then
                  Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
               else
                  Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
         end;
      SM_HIT:    // ±Ù°Å¸® °ø°Ý
         begin
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip); // pm.ActAttack.start + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + pm.ActAttack.frame - 1;
               m_dwFrameTime := pm.ActAttack.ftime;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;

               if m_btRace in [123,168,173,219] then begin  //°í´ë¼öÈ£Àå °ËÀº¸ÁÄ¡±ªÀÌ ¿¬È¥Èæ±«¼ö
                 m_boUseEffect := TRUE;

                 m_nEffectFrame := m_nStartFrame;
                 m_nEffectStart := m_nStartFrame;
                 m_nEffectEnd := m_nEndFrame;
                 m_dwEffectStartTime := GetTickCount;
                 m_dwEffectFrameTime := m_dwFrameTime;
               end;

               if m_btRace = 168 then begin  //°ËÀº¸ÁÄ¡±ªÀÌ
                 PlaySound2 (hammercat_att);
               end;

               if m_btRace = 170 then begin  //¹«´ç±ªÀÌ
                 PlaySound2 (shamancat_att);
               end;
               if m_btRace = 172 then begin  //È£Áß±Í1
                 PlaySound2 (pot1_atk);
               end;
               if m_btRace = 173 then begin  //°í´ë¼öÈ£Àå
                 PlaySound (3292);
               end;
               if m_btRace = 173 then begin  //¹¦Àå±º
                 PlaySound (3597);
               end;

         end;

     SM_LIGHTING,SM_LIGHTING_1,SM_LIGHTING_2,SM_LIGHTING_3: begin
       if (m_nCurrentAction = SM_LIGHTING) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical.frame - 1;
           m_dwFrameTime := pm.ActCritical.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           if (m_btRace = 101) then begin    //¿°È­Àû±Í
             PlaySound(3156);
           end;
           if (m_btRace = 114) then begin    //¿­ÀåÀû±Í
             PlaySound(3166);
           end;
           if (m_btRace = 124) then begin    //°ÅµµÀû±Í
             PlaySound(3176);
           end;
           if (m_btRace = 128) then begin    //ÆÐ°ËÀû±Í
             PlaySound(3186);
           end;
           if (m_btRace = 129) then begin    //µ¶ÀÎÀû±Í
             PlaySound(3196);
           end;
           if (m_btRace = 168) then begin    //°ËÀº¸ÁÄ¡±ªÀÌ
             PlaySound2 (blackhammercat_att);
           end;
           if (m_btRace = 170) then begin    //¹«´ç±ªÀÌ
             PlaySound2 (shamancat_att2);
           end;
           if m_btRace = 172 then begin  //È£Áß±Í1
             PlaySound2 (pot3_atk);
           end;
           if m_btRace = 213 then begin  //ÇÑºù¼öÈ£±Í
             PlaySound (3066);
           end;
           if m_btRace = 219 then PlaySound(3986);//¿À¸¶Èæ·É
       end
       else if (m_nCurrentAction = SM_LIGHTING_1) then begin
         if m_btRace = 129 then begin     //µ¶ÀÎÀû±Í
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical2.frame - 1;
           m_dwFrameTime := pm.ActCritical2.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
         end;

         if m_btRace = 118 then begin     //¿øÈ£ ¼ÒÈ¯
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical2.frame - 1;
           m_dwFrameTime := pm.ActCritical2.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
         end;

       end
       else if (m_nCurrentAction = SM_LIGHTING_2) then begin
         if m_btRace in [170,173,175,213,219] then begin  //¹«´ç±ªÀÌ
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical2.frame - 1;
           m_dwFrameTime := pm.ActCritical2.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;

           if m_btRace = 173 then begin  //°í´ë¼öÈ£Àå
             PlaySound(3298);
           end;
           if m_btRace = 175 then begin  //¹¦Àå±º
             PlaySound(3598);
           end;
           if m_btRace = 213 then begin  //ÇÑºù¼öÈ£±Í
             PlaySound (3067);
           end;
           if m_btRace = 219 then PlaySound(3988);//¿À¸¶Èæ·É

         end;
         if m_btRace in [118] then begin  //¿ø¿À ¹Ù´Ú¼Õ
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical3.frame - 1;
           m_dwFrameTime := pm.ActCritical3.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
         end;


       end
       else if (m_nCurrentAction = SM_LIGHTING_3) then begin
          if m_btRace in [173,175,219] then begin  //¹«´ç±ªÀÌ
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical3.frame - 1;
           m_dwFrameTime := pm.ActCritical3.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;

            if m_btRace = 173 then begin  //°í´ë¼öÈ£Àå
             PlaySound(3292);
            end;
            if m_btRace = 175 then begin  //¹¦Àå±º
             PlaySound(3599);
            end;
            if m_btRace = 219 then PlaySound(3989);//¿À¸¶Èæ·É
          end;

          if m_btRace in [118] then begin  //¿ø¿À Çìºñ
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActAttack2.start + m_btDir * (pm.ActAttack2.frame + pm.ActAttack2.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActAttack2.frame - 1;
           m_dwFrameTime := pm.ActAttack2.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
          end;

       end;
     end;


     SM_STRUCK: begin
           m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
           m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
           m_dwFrameTime := pm.ActStruck.ftime;
           m_dwStartTime := GetTickCount;
     end;

    SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       if m_btRace in [148,149,160,163] then begin  //°ßºù¼öÈ£Àå
         PlaySound (2547);
       end;

       if m_btRace = 168 then begin  //°ËÀº¸ÁÄ¡±ªÀÌ
         PlaySound2 (hammercat_die_cat);
       end;
       if m_btRace = 170 then begin  //¹«´ç±ªÀÌ
         PlaySound2 (shamancat_die_cat);
       end;
       if m_btRace = 172 then begin  //È£Áß±Í1
         PlaySound2 (pot3_die);
       end;
       if m_btRace = 173 then begin  //°í´ë¼öÈ£Àå
         PlaySound (3295);
       end;
    end;
   end;

   m_boUseEffect := TRUE;
end;

procedure TFireLead.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bofly: Boolean;
   meff: TFlyingAxe;
   tx, ty, i : integer;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);


   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := TRUE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


         if (m_nCurrentAction = SM_HIT) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

           end;
         end;

         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             if m_btRace = 114 then begin       //¿­ÀåÀû±Í
                 PlayScene.NewMagic (self, MAGIC_FIREEXPLOSIN, MAGIC_FIREEXPLOSIN,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 128 then begin       //ÆÐ°ËÀû±Í
                 PlayScene.NewMagic (self, MAGIC_SIDEARMS,MAGIC_SIDEARMS,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 129 then begin       //µ¶ÀÎÀû±Í
                 PlayScene.NewMagic (self, MAGIC_DAGGER,MAGIC_DAGGER,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 148 then begin       //°ßºù¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_ICEGUARD,MAGIC_ICEGUARD,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 149 then begin       //¸¶¿°¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_MAGICGUARD,MAGIC_MAGICGUARD,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 160 then begin       //¾ÏÈ¥¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_DARKGUARD,MAGIC_DARKGUARD,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;

             if m_btRace = 163 then begin       //¿­Áø¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_POWERGUARD,MAGIC_POWERGUARD,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
                 PlaySound (2526);
             end;
             if m_btRace = 172 then begin       //È£Áß±Í1
                 PlayScene.NewMagic (self, MAGIC_POT_ATT,MAGIC_POT_ATT,m_nCurrX, m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
             end;

           end;
         end else
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentAction-m_nStartFrame = 4) then begin

         end else
         if (m_nCurrentAction = SM_LIGHTING_2) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             if m_btRace = 173 then begin       //°í´ë¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_OLDKING_ATT1_2, MAGIC_OLDKING_ATT1_2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
             end;
             if m_btRace = 175 then begin       //¹¦Àå±º
                PlayScene.NewMagic (Self,1,39,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtFly,False,30,bofly);
                PlaySound(m_nMagicFireSound);
             end;
             if m_btRace = 213 then begin       //ÇÑºù¼öÈ£±Í
               if Random(2) = 0 then begin
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_1,MAGIC_ICEKING_ATT1_1,m_nCurrX,m_nCurrY,m_nCurrX + Random(2),m_nCurrY - 4 - Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_2,MAGIC_ICEKING_ATT1_2,m_nCurrX,m_nCurrY,m_nCurrX - 4 - Random(2),m_nCurrY + 2 + Random(2) ,m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_3,MAGIC_ICEKING_ATT1_3,m_nCurrX,m_nCurrY,m_nCurrX + 4 + Random(2),m_nCurrY + 2 + Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_4,MAGIC_ICEKING_ATT1_4,m_nCurrX,m_nCurrY,m_nCurrX - Random(2),m_nCurrY + Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
               end else begin
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_1,MAGIC_ICEKING_ATT1_1,m_nCurrX,m_nCurrY,m_nCurrX + Random(2),m_nCurrY + 4 - Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_2,MAGIC_ICEKING_ATT1_2,m_nCurrX,m_nCurrY,m_nCurrX - 4 - Random(2),m_nCurrY - 2 - Random(2) ,m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_3,MAGIC_ICEKING_ATT1_3,m_nCurrX,m_nCurrY,m_nCurrX + 4 + Random(2),m_nCurrY - 2 - Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
                PlayScene.NewMagic (Self,MAGIC_ICEKING_ATT1_4,MAGIC_ICEKING_ATT1_4,m_nCurrX,m_nCurrY,m_nCurrX + Random(2),m_nCurrY - Random(2),m_nTargetRecog,mtThunder,False,30,bofly);
               end;
             end;
           end;
         end else
         if (m_nCurrentAction = SM_LIGHTING_3) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             if m_btRace = 173 then begin       //°í´ë¼öÈ£Àå
                 PlayScene.NewMagic (self, MAGIC_OLDKING_ATT1_1, MAGIC_OLDKING_ATT1_1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
             end;
           end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;

   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TFireLead.DrawEff(dsurface: TDirectDrawSurface; dx,  //¿°È­Àû±Í
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);;
  if g_boEffect then begin
  if m_boUseEffect and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
  end;
end;



{ TWindLead }

constructor TWindLead.Create;     //¸¶Ç³¼®±«
begin
  inherited Create;
   AttackEffectSurface:=nil;
    AttackEffectSurface2:=nil;
end;

destructor TWindLead.Destroy;              //¸¶Ç³¼®±«
begin
   inherited Destroy;
   AttackEffectSurface:=nil;
   AttackEffectSurface2:=nil;
end;

procedure TWindLead.LoadSurface;             //¸¶Ç³¼®±«
var
  mimg:TWMImages;
begin

   mimg := GetMonImg (m_wAppearance);
   if mimg = nil then exit;
    m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nCurrentFrame, m_nPx, m_nPy);

  if m_boUseEffect then begin
    case m_nCurrentAction of
      SM_HIT: begin
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage (
                         8040 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING: begin
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage (
                         8200 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_1: begin
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage (
                         8640 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_2: begin
        AttackEffectSurface := g_WMonImagesArr[40].GetCachedImage (
                         8730 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
      end;
      SM_LIGHTING_3: begin
       //
      end;
      SM_LIGHTING_4: begin
        AttackEffectSurface2 := g_WMonImagesArr[40].GetCachedImage (
                         8760 + m_nEffectFrame-m_nEffectStart,
                         ex,
                         ey);
      end;

    end;




  end;
end;


procedure TWindLead.CalcActorFrame;          //¸¶Ç³¼®±«
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_TURN:
         begin
            m_boUseEffect := False;
            m_dwStartTime := GetTickCount;
            m_nDefframecount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);
            m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
            m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
            m_dwFrameTime := pm.ActStand.ftime;
            m_dwStartTime := GetTickCount;
            m_nDefFrameCount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);
     end;

      SM_WALK, SM_BACKSTEP:
         begin
            m_boUseEffect :=False;
               m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
               m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
               m_dwFrameTime := pm.ActWalk.ftime;
               m_dwStartTime := GetTickCount;

               m_nMoveStep := 1;
               if m_nCurrentAction = SM_WALK then
                  Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
               else
                  Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
         end;
      SM_HIT:    // ±Ù°Å¸® °ø°Ý
         begin
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip); // pm.ActAttack.start + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + pm.ActAttack.frame - 1;
               m_dwFrameTime := pm.ActAttack.ftime;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               m_boUseEffect := TRUE;
               m_nEffectFrame := m_nStartFrame;
               m_nEffectStart := m_nStartFrame;
               m_nEffectEnd := m_nEndFrame;
               m_dwEffectStartTime := GetTickCount;
               m_dwEffectFrameTime := m_dwFrameTime;
               PlaySound(4276);
         end;

     SM_LIGHTING,SM_LIGHTING_1,SM_LIGHTING_2,SM_LIGHTING_3,SM_LIGHTING_4: begin
       if (m_nCurrentAction = SM_LIGHTING) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical.frame - 1;
           m_dwFrameTime := pm.ActCritical.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           PlaySound(4278);
       end
       else if (m_nCurrentAction = SM_LIGHTING_1) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical2.frame - 1;
           m_dwFrameTime := pm.ActCritical2.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           PlaySound(4279);
       end
       else if (m_nCurrentAction = SM_LIGHTING_2) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical3.frame - 1;
           m_dwFrameTime := pm.ActCritical3.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;

           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           PlaySound(4276);
           PlaySound(4289);
       end
       else if (m_nCurrentAction = SM_LIGHTING_3) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical5.start + m_btDir * (pm.ActCritical5.frame + pm.ActCritical5.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical5.frame - 1;
           m_dwFrameTime := pm.ActCritical5.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := FALSE;
           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           PlaySound(4298);
           PlaySound(4299);
       end
       else if (m_nCurrentAction = SM_LIGHTING_4) then begin
           Shift (m_btDir, 0, 0, 1);
           m_nStartFrame := pm.ActCritical4.start + m_btDir * (pm.ActCritical4.frame + pm.ActCritical4.skip); // pm.ActAttack.start + m_btDir * 10;
           m_nEndFrame  := m_nStartFrame + pm.ActCritical4.frame - 1;
           m_dwFrameTime := pm.ActCritical4.ftime;
           m_dwStartTime := GetTickCount;
           m_dwWarModeTime := GetTickCount;
           m_boUseEffect := TRUE;
           m_nEffectFrame := m_nStartFrame;
           m_nEffectStart := m_nStartFrame;
           m_nEffectEnd := m_nEndFrame;
           m_dwEffectStartTime := GetTickCount;
           m_dwEffectFrameTime := m_dwFrameTime;
           PlaySound(4287);
       end;
     end;


     SM_STRUCK: begin
           m_boUseEffect :=False;
           m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
           m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
           m_dwFrameTime := pm.ActStruck.ftime;
           m_dwStartTime := GetTickCount;
           PlaySound(4294);
     end;

    SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
       PlaySound(4295);
    end;
   end;

  // m_boUseEffect := TRUE;
end;

procedure TWindLead.Run;        //¸¶Ç³¼®±«
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bofly: Boolean;
   meff: TFlyingAxe;
   tx, ty, i : integer;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);


   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := TRUE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;


         if (m_nCurrentAction = SM_HIT) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

           end;
         end;

         if m_nCurrentAction = SM_LIGHTING then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

           end;
         end else
         if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentAction-m_nStartFrame = 4) then begin

         end else
         if (m_nCurrentAction = SM_LIGHTING_2) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (self, MAGIC_WIND_LEAD_1, MAGIC_WIND_LEAD_1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtThunder,FALSE,30,bofly);
             PlaySound(3748);
           end;
         end else
         if (m_nCurrentAction = SM_LIGHTING_3) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin

           end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;

   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TWindLead.DrawEff(dsurface: TDirectDrawSurface; dx,  //¸¶Ç³¼®±«
  dy: integer);
begin
  inherited DrawEff(dsurface, dx, dy);;
  if m_boUseEffect and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
  if m_boUseEffect and (AttackEffectSurface2 <> nil) then begin
    dsurface.Draw(dx + ex + m_nShiftX,dy + ey + m_nShiftY,AttackEffectSurface2, True );
  end;
end;

{ TGreatFoxSpirit }

constructor TGreatFoxSpirit.Create;
begin
  inherited Create;
   AttackEffectSurface:=nil;
   if m_btRace in [115, 127] then begin //ÃµÁÖ
    LightningTimer := TTimer.Create (nil);  //ºñ¿ùÃµÁÖ Çö¹«Çö½Å
    LightningTimer.Interval := 10;
    LightningTimer.Tag := 0;
    LightningTimer.OnTimer := LightningTimerTimer;
    LightningTimer.Enabled := False; //FireDragon
   end;
end;

destructor TGreatFoxSpirit.Destroy;
begin
  if m_btRace in [115, 127] then begin  //ÃµÁÖ Çö¹«Çö½Å
   if LightningTimer <> nil then LightningTimer.Free;   //ÃµÁÖ
  end;
   inherited Destroy;

end;

procedure TGreatFoxSpirit.LoadSurface;
var
   mimg: TWMImages;
begin
  mimg := GetMonImg (m_wAppearance);
  m_boUseEffect :=True;
  if m_boDeath then begin
    m_boUseEffect:=False;
  end;

  m_BodySurface := mimg.GetCachedImage (GetOffset (m_wAppearance) + m_nCurrentFrame, m_nPx, m_nPy);

  if m_boUseEffect then begin
   case m_nCurrentAction of
    SM_NOWDEATH: begin
     if m_btRace = 115 then begin
       AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage (
                         2090 + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
     end;
     if m_btRace = 127 then begin             //Çö¹«Çö½Å
       AttackEffectSurface := g_WMonImagesArr[24].GetCachedImage (
                         2580 + (m_btDir * 10) + m_nEffectFrame-m_nEffectStart,
                         ax,
                         ay);
     end;

    end;
   end;
   if m_btRace = 115 then begin
     if ((1670 + m_nCurrentFrame+20) > 2089) and ((1670 + m_nCurrentFrame+20) < 2108)  then begin
              AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage ( 1670 + m_nCurrentFrame+20, ax, ay);
     end else
     AttackEffectSurface := g_WMonImagesArr[23].GetCachedImage ( 1670 + m_nCurrentFrame+40, ax, ay);
   end else
    if m_btRace = 127 then begin    //Çö¹«Çö½Å
     AttackEffectSurface := g_WMonImagesArr[24].GetCachedImage ( 1650+670 + m_nCurrentFrame, ax, ay);
    end;
  end;
end;


procedure TGreatFoxSpirit.CalcActorFrame;
var
   pm: PTMonsterAction;
   actor: TActor;
   haircount, scx, scy, stx, sty: integer;
   meff: TCharEffect;
begin
   if m_btRace <> 127 then       //Çö¹«Çö½Å
   m_btDir:=0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
   case m_nCurrentAction of
     SM_TURN:
         begin
            m_dwStartTime := GetTickCount;
            m_nDefframecount := pm.ActStand.frame;
            Shift (m_btDir, 0, 0, 1);
            if m_btRace = 115 then begin
            case TempState of
                  1: m_nStartFrame := 0;
                  2: m_nStartFrame := 80;
                  3: m_nStartFrame := 160;
                  4: m_nStartFrame := 240;
                  5: m_nStartFrame := 320;
            end;
               m_boWarMode := True;
               m_dwFrameTime := 150;
               m_nEndFrame := m_nStartFrame + 19;
               m_dwStartTime := GetTickCount;
               m_nDefframecount := 20;
               m_boUseEffect := TRUE;
               m_dwEffectStartTime := GetTickCount;
               m_dwEffectFrameTime := 150;
            end else
            if m_btRace = 127 then begin    //Çö¹«Çö½Å
               m_nStartFrame := pm.ActStand.start + m_btDir * (pm.ActStand.frame + pm.ActStand.skip);
               m_nEndFrame := m_nStartFrame + pm.ActStand.frame - 1;
               m_dwFrameTime := pm.ActStand.ftime;
               m_dwStartTime := GetTickCount;
               m_nDefFrameCount := pm.ActStand.frame;
               Shift (m_btDir, 0, 0, 1);
            end;

     end;

      SM_WALK, SM_BACKSTEP:
         begin
            if m_btRace = 127 then begin      //Çö¹«Çö½Å
               m_nStartFrame := pm.ActWalk.start + m_btDir * (pm.ActWalk.frame + pm.ActWalk.skip);
               m_nEndFrame := m_nStartFrame + pm.ActWalk.frame - 1;
               m_dwFrameTime := pm.ActWalk.ftime;
               m_dwStartTime := GetTickCount;

               m_nMoveStep := 1;
               if m_nCurrentAction = SM_WALK then
                  Shift (m_btDir, m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1)
               else
                  Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
            end;
         end;
      SM_HIT:    // ±Ù°Å¸® °ø°Ý
         begin
            if m_btRace = 127 then begin    //Çö¹«Çö½Å
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := pm.ActAttack.start + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + 9;
               m_dwFrameTime := pm.ActAttack.ftime;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
            end;
         end;

     SM_LIGHTING,SM_LIGHTING_1,SM_LIGHTING_2,SM_LIGHTING_3: begin
       m_nStartFrame:=0;
       m_nEndFrame:=19;
       m_dwFrameTime:=150;

       m_dwStartTime:=GetTickCount;

       m_boUseEffect:=True;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;

       m_nEffectEnd:=19;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=150;

       m_nCurEffFrame:=0;
       m_boUseMagic:=True;
       m_dwWarModeTime:=GetTickcount;
       Shift (m_btDir, 0, 0, 1);

       if m_btRace = 115 then begin
        case TempState of
                  1: m_nStartFrame := 20;
                  2: m_nStartFrame := 100;
                  3: m_nStartFrame := 180;
                  4: m_nStartFrame := 260;
                  5: m_nStartFrame := 340;
        end;
        m_nEndFrame   := m_nStartFrame + 9;
        m_dwFrameTime  := 150;
        m_boUseEffect := TRUE;
        m_dwEffectStartTime := GetTickCount;
        m_dwEffectFrameTime := 150;
       end;

            if (m_nCurrentAction = SM_LIGHTING) and (m_btRace = 127) then begin           //Çö¹«Çö½Å
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := 340 + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + 5;
               m_dwFrameTime := pm.ActAttack.ftime;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               m_boUseEffect := TRUE;
               PlaySound(2642);
            end
            else if (m_nCurrentAction = SM_LIGHTING_1) and (m_btRace = 127) then begin         //Çö¹«Çö½Å
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := 420 + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + 5;
               m_dwFrameTime := pm.ActCritical.ftime;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               m_boUseEffect := TRUE;
            end
            else if (m_nCurrentAction = SM_LIGHTING_2) and (m_btRace = 127) then begin      //Çö¹«Çö½Å
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := 500 + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + 5;
               m_dwFrameTime := 120;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               m_boUseEffect := TRUE;
            end
            else if (m_nCurrentAction = SM_LIGHTING_3) and (m_btRace = 127) then begin        //Çö¹«Çö½Å
               Shift (m_btDir, 0, 0, 1);
               m_nStartFrame := 580 + m_btDir * 10;
               m_nEndFrame  := m_nStartFrame + 7;
               m_dwFrameTime := 120;
               m_dwStartTime := GetTickCount;
               m_dwWarModeTime := GetTickCount;
               m_boUseEffect := TRUE;
            end;
     end;


     SM_STRUCK: begin
       if m_btRace = 127 then begin      //Çö¹«Çö½Å
           m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
           m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
           m_dwFrameTime := pm.ActStruck.ftime;
           m_dwStartTime := GetTickCount;
       end;
     end;

    SM_NOWDEATH: begin
     if m_btRace = 115 then begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_nEffectFrame:=pm.ActDie.start;
       m_nEffectStart:=pm.ActDie.start;
       m_nEffectEnd:=pm.ActDie.start + pm.ActDie.frame -1;
       m_dwEffectStartTime:=GetTickCount;
       m_dwEffectFrameTime:=pm.ActDie.frame;
       m_boUseEffect := TRUE;
     end else
     if m_btRace = 127 then begin       //Çö¹«Çö½Å
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;

       m_nEffectFrame := 0;
       m_nEffectStart := 0;
       m_nEffectEnd := 10;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
     end;
    end;
   end;

   m_boUseEffect := TRUE;
end;

procedure TGreatFoxSpirit.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bofly: Boolean;
   meff: TFlyingAxe;
   tx, ty, i : integer;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;
   if m_boRunSound then begin
    if m_btRace = 115 then
     PlaySound(2571)
    else
     PlaySound(2641);
     m_boRunSound:=False;
   end;


   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
          if m_btRace in [115,127] then begin
            if m_boDeath then
            m_boUseEffect := FALSE
            else m_boUseEffect := TRUE;
          end else
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;

         if m_btRace = 127 then begin       //Çö¹«Çö½Å
            if (m_nCurrentAction = SM_LIGHTING_1) {and (m_nCurrentAction-m_nStartFrame = 4)} then begin
                PlayScene.NewMagic (self,
                                      MAGIC_KINGTURTLE_ATT1,
                                      MAGIC_KINGTURTLE_ATT1,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,       //TargetX,
                                      m_nTargetY,       //TargetY,
                                      m_nTargetRecog,  //TargetRecog,
                                      mt13,
                                      FALSE,
                                      30,
                                      bofly);
                PlaySound (10022);
            end
            else if (m_nCurrentAction = SM_LIGHTING_2) {and (m_nCurrentAction-m_nStartFrame = 4)} then begin
              if m_btRace in [115, 127] then begin  //ÃµÁÖ
                if Not LightningTimer.Enabled then begin
                  LightningTimer.Enabled := True;
                  PlaySound (10450); //ÃÊÇÊ»ç±â
                end;
              end;
            end
            else if (m_nCurrentAction = SM_LIGHTING_3) {and (m_nCurrentAction-m_nStartFrame = 1)} then begin
                PlayScene.NewMagic (self,
                                      MAGIC_KINGTURTLE_ATT3,
                                      MAGIC_KINGTURTLE_ATT3,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,       //TargetX,
                                      m_nTargetY,       //TargetY,
                                      m_nTargetRecog,  //TargetRecog,
                                      mt13,
                                      FALSE,
                                      30,
                                      bofly);
                PlaySound (10160);
            end

         end else

         if m_btRace = 115 then begin //±ÙÁ¢¹üÀ§ Àü±â °ø°Ý
         if (m_nCurrentAction = SM_LIGHTING) and (m_nCurrentFrame-m_nStartFrame = 1) then begin
                PlayScene.NewMagic (self,
                                      MAGIC_SOULBALL_ATT1,
                                      MAGIC_SOULBALL_ATT1,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,       //TargetX,
                                      m_nTargetY,       //TargetY,
                                      m_nTargetRecog,  //TargetRecog,
                                      mtFoxAnnoy,
                                      FALSE,
                                      30,
                                      bofly);
                PlaySound (2576);
            end else
            if (m_nCurrentAction = SM_LIGHTING_1) and (m_nCurrentFrame-m_nStartFrame = 1) then begin
              PlayScene.NewMagic (self,
                                      MAGIC_SOULBALL_ATT2, //¿ø°Å¸®¹üÀ§ °ø°Ý
                                      MAGIC_SOULBALL_ATT2,
                                      m_nCurrX,
                                      m_nCurrY,
                                      m_nTargetX,
                                      m_nTargetY,
                                      m_nTargetRecog,
                                      mtThunder,
                                      FALSE,
                                      30,
                                      bofly);
                PlaySound (2577);
            end else
            if (m_nCurrentAction = SM_LIGHTING_2) and (m_nCurrentFrame-m_nStartFrame = 1)then begin      //ÃµÁÖ
              if m_btRace in [115, 127] then begin  //ÃµÁÖ
                if Not LightningTimer.Enabled then begin
                  LightningTimer.Enabled := True;
                  PlaySound (2578); //ÃÊÇÊ»ç±â
                end;
              end;
            end;
         end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;

   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure TGreatFoxSpirit.LightningTimerTimer(Sender: TObject);
var
   tx, ty, n, kx, ky : integer;
   bofly: Boolean;
begin
   if m_btRace = 115 then begin  //ÃµÁÖ

       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 10;
          Exit;
       end;
       tx := g_Myself.m_nCurrX;
       ty := g_Myself.m_nCurrY;

       n := random(4);
       kx := random(7);
       ky := random(5);

       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_1, MAGIC_SOULBALL_ATT3_1, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_2, MAGIC_SOULBALL_ATT3_2, m_nCurrX, m_nCurrY, tx-2, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_3, MAGIC_SOULBALL_ATT3_3, m_nCurrX, m_nCurrY, tx, ty-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_4, MAGIC_SOULBALL_ATT3_4, m_nCurrX, m_nCurrY, tx-kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
          LightningTimer.Interval := 500;
       end
       else if LightningTimer.Tag = 2 then begin
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_1, MAGIC_SOULBALL_ATT3_1, m_nCurrX, m_nCurrY, tx-2, ty-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_2, MAGIC_SOULBALL_ATT3_2, m_nCurrX, m_nCurrY, tx+2, ty-2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_3, MAGIC_SOULBALL_ATT3_3, m_nCurrX, m_nCurrY, tx+kx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_4, MAGIC_SOULBALL_ATT3_4, m_nCurrX, m_nCurrY, tx-kx, ty, 0, mtThunder, FALSE, 30, bofly);
       end;

       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_5, MAGIC_SOULBALL_ATT3_5, m_nCurrX, m_nCurrY, tx+kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_1, MAGIC_SOULBALL_ATT3_1, m_nCurrX, m_nCurrY, tx-kx-2, ty+ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_2, MAGIC_SOULBALL_ATT3_2, m_nCurrX, m_nCurrY, tx-kx, ty-ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_3, MAGIC_SOULBALL_ATT3_3, m_nCurrX, m_nCurrY, tx+kx+2, ty+ky, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_4, MAGIC_SOULBALL_ATT3_4, m_nCurrX, m_nCurrY, tx+kx, ty, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_SOULBALL_ATT3_5, MAGIC_SOULBALL_ATT3_5, m_nCurrX, m_nCurrY, tx-kx, ty, 0, mtThunder, FALSE, 30, bofly);

       LightningTimer.Interval := LightningTimer.Interval + 100;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 10;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
   end else


   if m_btRace = 127 then begin //Çö¹«Çö½Å
       if LightningTimer.Tag = 0 then begin
          LightningTimer.Tag := LightningTimer.Tag + 1;
          LightningTimer.Interval := 10;
          Exit;
       end;

       tx := g_Myself.m_nCurrX;
       ty := g_Myself.m_nCurrY;

       n := random(4);
       kx := random(7);
       ky := random(5);

       if LightningTimer.Tag = 0 then begin
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx-2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx, ty+3, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx-kx, ty-ky+1, 0, mtThunder, FALSE, 30, bofly);
          LightningTimer.Interval := 500;
       end
       else if LightningTimer.Tag = 2 then begin
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx-2, ty+3, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx+2, ty+2, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx+kx, ty, 0, mtThunder, FALSE, 30, bofly);
          PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx-kx, ty+1, 0, mtThunder, FALSE, 30, bofly);
       end;

       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx+kx, ty-ky+1, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx-kx-2, ty+ky+2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx-kx, ty-ky+3, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx+kx+2, ty+ky+1, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_2, MAGIC_KINGTURTLE_ATT2_2, m_nCurrX, m_nCurrY, tx+kx, ty+2, 0, mtThunder, FALSE, 30, bofly);
       PlayScene.NewMagic (self, MAGIC_KINGTURTLE_ATT2_1, MAGIC_KINGTURTLE_ATT2_1, m_nCurrX, m_nCurrY, tx-kx, ty, 0, mtThunder, FALSE, 30, bofly);

       if LightningTimer.Tag = 4 then PlaySound (10450);
       LightningTimer.Interval := LightningTimer.Interval + 200;
       LightningTimer.Tag := LightningTimer.Tag+1;

       if LightningTimer.Tag > 7 then begin
          LightningTimer.Interval := 10;
          LightningTimer.Tag := 0;
          LightningTimer.Enabled := False;
       end;
    end;


end;

procedure TGreatFoxSpirit.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  if m_boDeath then exit;
  inherited DrawEff(dsurface, dx, dy);;
  if m_boUseEffect and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;

{ THellGuard }

procedure THellGuard.CalcActorFrame;    //Áö¿Á¹®Áö±â
var
   pm: PTMonsterAction;
begin
   m_btDir:=0;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_HIT: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActAttack.ftime;
      m_nCurEffFrame:=50;
    end;
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActCritical.ftime;
      m_nCurEffFrame:=50;
    end;
    else begin
      inherited;
    end;
  end;
 end;

procedure THellGuard.LoadSurface;       //Áö¿Á¹®Áö±â
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                                2220 +  + m_nEffectFrame - m_nEffectStart,
                                ax,
                                ay);
    end;
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                                2230 + m_nEffectFrame-m_nEffectStart,
                                ax,
                                ay);
    end;
  end;
end;

{ THellMonster1 }

procedure THellMonster1.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActAttack.ftime;
      m_nCurEffFrame:=50;
    end;
    SM_NOWDEATH: begin
       m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := 100;
       playsound(10731);
     end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure THellMonster1.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        1120 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

{ THellMonster2 }

procedure THellMonster2.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect:=FALSE;
      playsound(2936);
    end;
    SM_HIT: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActCritical.ftime;
      m_nCurEffFrame:=50;
      playsound(2936);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure THellMonster2.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_HIT: begin
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        1630 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

{ THellMonster3 }

procedure THellMonster3.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect:=TRUE;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=20;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=50;
      m_nCurEffFrame:=0;
      playsound(2946);
    end;
    SM_HIT: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwWarModeTime := GetTickCount;
      m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=130;
      m_nCurEffFrame:=0;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect:=TRUE;
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure THellMonster3.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
    m_boUseEffect:=TRUE;
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        3220 + (m_btDir * 20) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
    SM_HIT: begin
    m_boUseEffect:=TRUE;
         AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        2140 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

{ TIceHellMonster1 }

procedure TIceHellMonster1.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect:=TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=100;
      m_nCurEffFrame:=0;
      PlaySound(3006);
    end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
      PlaySound(3005);
    end;
    else begin
      inherited;
    end;
  end;
end;

constructor THellMonster4.Create;
begin
  inherited;
  boCasted:=FALSE;
end;

procedure THellMonster4.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectFrame := m_nStartFrame;
      m_nEffectStart := m_nStartFrame;
      m_nEffectEnd := m_nEndFrame;
      m_dwEffectStartTime := GetTickCount;
      m_dwEffectFrameTime := m_dwFrameTime;
      boCasted:=TRUE;
      PlaySound(2966);
    end;
    SM_HIT: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      firedir := m_btDir;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=6;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=150;
      m_nCurEffFrame:=0;
      boCasted:=TRUE;
      PlaySound(2969);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure THellMonster4.Run;
var
  bo11:boolean;
begin
  if (m_nCurrentFrame - m_nStartFrame) = 2 then begin
    if (m_nCurrentAction = SM_LIGHTING) then begin
      if boCasted = true then begin
        boCasted:=FALSE;
        PlayScene.NewMagic (Self,80,80,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtHellThunder,False,30,bo11);
        PlaySound(2967);
      end;
    end;
  end;
  inherited;
end;

function  THellMonster4.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
  Result:=0;
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  {
  if boActive = FALSE then begin

    if pm = nil then exit;
    if m_boDeath then begin
      inherited GetDefaultFrame(wmode);
      exit;
    end;
    m_nDefFrameCount := 1;
    if m_nCurrentDefFrame < 0 then cf := 0
    else if m_nCurrentDefFrame >= 0 then cf := 0
    else cf := m_nCurrentDefFrame;
    Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip) + cf;
    }


  if (m_nState and STATE_STONE_MODE) <> 0 then begin
    Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
  end else begin
    Result:= inherited GetDefaultFrame(wmode);
  end;
end;

procedure THellMonster4.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if g_boEffect then begin
  if m_boUseEffect and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
  end;
end;

procedure THellMonster4.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
    m_boUseEffect := TRUE;
      AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        2670 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
    SM_Hit: begin
    m_boUseEffect := TRUE;
      AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        2700 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;


constructor THellMonster5.Create;
begin
  inherited;
  boCasted:=FALSE;
end;

procedure THellMonster5.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_LIGHTING: begin
       m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
       m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
       m_dwFrameTime := pm.ActCritical.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectStart:=0;
       m_nEffectFrame:=0;
       m_nEffectEnd:=20;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime:=50;
       PlaySound(2976);
    end;
    SM_HIT: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
       m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
       m_dwFrameTime := pm.ActAttack.ftime;
       m_dwStartTime := GetTickCount;
       m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
       m_boUseEffect := TRUE;
       m_nEffectFrame := m_nStartFrame;
       m_nEffectStart := m_nStartFrame;
       m_nEffectEnd := m_nEndFrame;
       m_dwEffectStartTime := GetTickCount;
       m_dwEffectFrameTime := m_dwFrameTime;
      PlaySound(2977);
    end;
    else begin
      inherited;
    end;
  end;
end;

{procedure THellMonster5.Run;
var
  bo11:boolean;
begin
  if (m_nCurrentFrame - m_nStartFrame) = 2 then begin
    if (m_nCurrentAction = SM_HIT) then begin
      if boCasted = true then begin
        boCasted:=FALSE;
        PlayScene.NewMagic (Self,80,80,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtHell2Thunder,False,30,bo11);
        PlaySound(2979);
      end;
    end;
  end;
  inherited;
end;      }

function  THellMonster5.GetDefaultFrame (wmode: Boolean): integer;
var
   cf, dr: integer;
   pm: PTMonsterAction;
begin
  Result:=0;
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  {
  if boActive = FALSE then begin

    if pm = nil then exit;
    if m_boDeath then begin
      inherited GetDefaultFrame(wmode);
      exit;
    end;
    m_nDefFrameCount := 1;
    if m_nCurrentDefFrame < 0 then cf := 0
    else if m_nCurrentDefFrame >= 0 then cf := 0
    else cf := m_nCurrentDefFrame;
    Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip) + cf;
    }


  if (m_nState and STATE_STONE_MODE) <> 0 then begin
    Result := pm.ActDeath.start + m_btDir * (pm.ActDeath.frame + pm.ActDeath.skip);
  end else begin
    Result:= inherited GetDefaultFrame(wmode);
  end;
end;

procedure THellMonster5.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        3170 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;   
    SM_HIT: begin
    m_boUseEffect := TRUE;
      AttackEffectSurface := g_WMonImagesArr[27].GetCachedImage (
                        3140 + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;


procedure TIceHellMonster1.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                        420 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

{ TIceHellMonster }

procedure TIceHellMonster.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      {m_nEffectStart:=pm.ActCritical.start;
      m_nEffectFrame:=pm.ActCritical.start;
      m_nEffectEnd:=m_nStartFrame + pm.ActCritical.frame ;- 1;}
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;
      //m_nCurEffFrame:=100;
    end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
    end;
    else begin
      inherited;
    end;
  end;
end;


{ TIceHellMonster2 }

procedure TIceHellMonster2.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
       Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_dwStartTime := GetTickCount;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=10;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=50;
      m_nCurEffFrame:=0;
      PlaySound(3016);
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
       m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
       m_dwFrameTime := pm.ActDie.ftime;
       m_dwStartTime := GetTickCount;
       m_boUseEffect := TRUE;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=m_dwFrameTime;
       PlaySound(3015);
     end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=FALSE;
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TIceHellMonster2.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                        930 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;

procedure TIceHellMonster3.CalcActorFrame;
var
   pm: PTMonsterAction;
begin
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_boUseEffect := TRUE;
      m_nEffectStart:=0;
      m_nEffectFrame:=0;
      m_nEffectEnd:=5;
      m_dwEffectStartTime:=GetTickCount;
      m_dwEffectFrameTime:=pm.ActCritical.ftime;
      m_nCurEffFrame:=50;
      PlaySound(3057);
    end;
    SM_HIT: begin
      inherited;
      m_boUseEffect:=TRUE;
      PlaySound(3056);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TIceHellMonster3.LoadSurface;
begin
  inherited;
  case m_nCurrentAction of
    SM_LIGHTING: begin
         AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                        2650 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
    SM_HIT: begin
         AttackEffectSurface := g_WMonImagesArr[28].GetCachedImage (
                        2570 + (m_btDir * 10) + m_nEffectFrame - m_nEffectStart,
                        ax, ay);
    end;
  end;
end;



//Çö¿ù´ÜÀü»ç
procedure TWarriorH.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_LIGHTING then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,800 + (m_btDir * 10),6,85,TRUE);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;

  if m_nCurrentAction = SM_LIGHTING_2 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,220 + (m_btDir * 20),6,85,TRUE);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(s_hit_do);
    end;
    SM_LIGHTING: Begin //¿¹µµ°ø°Ý
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      if m_btRace = 266 then PlaySound(s_yedo_man);
      if m_btRace = 267 then PlaySound(s_yedo_woman);
    end;

    SM_LIGHTING_2: Begin //¿¹µµ°ø°Ý
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(141);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 266 then PlaySound(s_man_struck);
      if m_btRace = 267 then PlaySound(s_wom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 266 then PlaySound(s_man_die);
      if m_btRace = 267 then PlaySound(s_wom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TWarriorH.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    if m_btRace = 266 then begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(52,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(2224 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(12,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end else begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(52,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(16680 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(13,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end;
  end;
end;

procedure TWarriorH.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
   if not (m_btDir in [0..7]) then exit;
   if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
  ceff := GetDrawEffectValue;
  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TWarriorH.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


//Çö¿ù´Ü¼ú»ç
procedure TWizardH.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_FLYAXE then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,400,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,1650,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_2 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,900,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_FLYAXE: Begin       //±Ý°­È­¿°Àå
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime+40;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10050);
    end;
    SM_LIGHTING: Begin  //Æø¿­ÆÄ
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10230);
    end;
    SM_LIGHTING_2: Begin //È­¿°Ç³
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10080);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 268 then PlaySound(s_man_struck);
      if m_btRace = 269 then PlaySound(s_wom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 268 then PlaySound(s_man_die);
      if m_btRace = 269 then PlaySound(s_wom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TWizardH.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   bofly: Boolean;
begin
   if GetTickCount - m_dwGenAnicountTime > 120 then begin
      m_dwGenAnicountTime := GetTickCount;
      Inc (m_nGenAniCount);
      if m_nGenAniCount > 100000 then m_nGenAniCount := 0;
   end;
  if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
         if m_nCurrentAction = SM_FLYAXE then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
               PlayScene.NewMagic (Self,1,3,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtfly,False,30,bofly);
               PlaySound (10052);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (self, MAGIC_EXPLOSIN_WIZARD, MAGIC_EXPLOSIN_WIZARD, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY,
                                      m_nTargetRecog, mtThunder, FALSE,30, bo11);
             PlaySound(10232);
           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure  TWizardH.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    if m_btRace = 268 then begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(56,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(2224 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(14,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end else begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(56,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(16680 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(15,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end;
  end;
end;

procedure TWizardH.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;
  ceff := GetDrawEffectValue;
  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TWizardH.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;



//Çö¿ù´Ü³²µµ»ç
procedure TToaistH.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_HIT then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,0,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin       //½Å¼ö, ¿ø·É¼ÒÈ¯
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10060);
    end;
    SM_LIGHTING: Begin  //Æø»ì°è
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10130);
    end;
    SM_LIGHTING_2: Begin //ÀúÁÖ¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10300);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 270 then PlaySound(s_man_struck);
      if m_btRace = 271 then PlaySound(s_wom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 270 then PlaySound(s_man_die);
      if m_btRace = 271 then PlaySound(s_wom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TToaistH.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   bofly: Boolean;
begin
   if GetTickCount - m_dwGenAnicountTime > 120 then begin
      m_dwGenAnicountTime := GetTickCount;
      Inc (m_nGenAniCount);
      if m_nGenAniCount > 100000 then m_nGenAniCount := 0;
   end;
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
         if (m_nCurrentAction = SM_LIGHTING) then begin                             //Æø»ì°è
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (Self,10,10,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtExploBujauk,False,30,bofly);
             m_nmagicfiresound  := 10131;
             m_nmagicexplosionsound := 10132;
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) then begin                             //ÀúÁÖ¼ú
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (Self,MAGIC_FOX_CURSE2,MAGIC_FOX_CURSE2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtExploBujauk,False,30,bofly);
             m_nmagicfiresound  := 10131;
             m_nmagicexplosionsound := 10461;
           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure  TToaistH.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    if m_btRace = 270 then begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(50,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(2224 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(16,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end else begin
      m_WeaponSurface:=FrmMain.GetWWeaponImg(50,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=nil;
      m_HairSurface := g_WHairImgImages.GetCachedImage(16680 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHumImg(17,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end;
  end;
end;

procedure TToaistH.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;

  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TToaistH.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


//Çö¿ù´ÜÀÚ°´
procedure TAssassinH.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_HIT then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,1960 + (m_btDir * 10),10,65,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,2050 + (m_btDir * 10),10,65,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_2 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,2230 + (m_btDir * 10),10,85,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin       //Ç³°Ë¼ú
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10605);
    end;
    SM_LIGHTING: Begin  //Ç³°Ë¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10606);
    end;
    SM_LIGHTING_2: Begin //ÃµÀÌ°Ë°ø°Ý
      m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
      m_dwFrameTime := pm.ActCritical3.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10635);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 272 then PlaySound(s_killerman_struck);
      if m_btRace = 273 then PlaySound(s_killerwom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      if m_btRace = 272 then PlaySound(s_killerman_die);
      if m_btRace = 273 then PlaySound(s_killerwom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure  TAssassinH.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    if m_btRace = 272 then begin
      m_WeaponSurface:=FrmMain.GetWWeapon_Killer_LeftImg(8,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
      m_WeaponSurface2:=FrmMain.GetWWeapon_Killer_RightImg(8,0,0,m_nCurrentFrame, m_nWp2x, m_nWp2y);
      m_HairSurface := g_WHair_KillerImgImages.GetCachedImage(1456 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHum_Killer2Img(12,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end else begin
      m_WeaponSurface:=FrmMain.GetWWeapon_Killer_LeftImg(8,0,0,m_nCurrentFrame+728, m_nWpx, m_nWpy);
      m_WeaponSurface2:=FrmMain.GetWWeapon_Killer_RightImg(8,0,0,m_nCurrentFrame+728, m_nWp2x, m_nWp2y);
      m_HairSurface := g_WHair_KillerImgImages.GetCachedImage(10920 + m_nCurrentFrame, m_nHpx, m_nHpy);
      m_BodySurface := FrmMain.GetWHum_Killer2Img(13,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
    end;
  end;
end;

procedure TAssassinH.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;

  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER4[m_btSex, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_WeaponSurface2 <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface2, dx + m_nWp2x + m_nShiftX, dy + m_nWp2y + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TAssassinH.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


//Àü½ÂÀü»ç
procedure TWarriorM2.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_LIGHTING then begin //¿¹µµ
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,800 + (m_btDir * 10),6,85,TRUE);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;
  if m_nCurrentAction = SM_LIGHTING_2 then begin  //½Ö·æÂü
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,220 + (m_btDir * 20),6,85,TRUE);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;
  if m_nCurrentAction = SM_LIGHTING_3 then begin //±¤Ç³Âü
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,40 + (m_btDir * 10),10,85,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;
  if m_nCurrentAction = SM_LIGHTING_4 then begin   //°øÆÄ¼¶
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,740 + (m_btDir * 20),20,80,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
    PlaySound(s_hit_do);
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(s_hit_do);
    end;
    SM_LIGHTING: Begin  //¿¹µµ
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(s_yedo_man);
    end;
    SM_LIGHTING_2: Begin //½Ö·æÂü°ø°Ý
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(141);
    end;
    SM_LIGHTING_3: Begin //±¤Ç³Âü°ø°Ý
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(140);
    end;
    SM_LIGHTING_4: Begin //°øÆÄ¼¶°ø°Ý
      m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
      m_dwFrameTime := 80;
      m_nMagLight    := 2;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound (10440);
      PlaySound (s_twinhit);
      PlaySound (s_hit_do);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_man_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_man_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure  TWarriorM2.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    m_WeaponSurface:=FrmMain.GetWWeaponImg(104,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
    m_WeaponSurface2:=nil;
    m_HairSurface := g_WHairImgImages.GetCachedImage(2224 + m_nCurrentFrame, m_nHpx, m_nHpy);
    m_BodySurface := FrmMain.GetWHum2Img(30,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
  end;
end;

procedure TWarriorM2.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;
  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TWarriorM2.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;

//¼º³²¼ú»ç
procedure TWizardM2.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_FLYAXE then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,400,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,1650,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_2 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,900,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_3 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,1040,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_FLYAXE: Begin       //±Ý°­È­¿°Àå
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime+40;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10050);
    end;
    SM_LIGHTING: Begin  //Æø¿­ÆÄ
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10230);
    end;
    SM_LIGHTING_2: Begin //È­¿°Ç³
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10080);
    end;
    SM_LIGHTING_3: Begin //ÈíÇ÷¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10480);
    end;
    SM_LIGHTING_4: Begin //È­·æ±â¿°
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := 100;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_nMagLight := 2;
      FrmMain.UseNormalEffect (NE_FIRECIRCLE, m_nCurrX, m_nCurrY);
      PlaySound(10450);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_wom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_wom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TWizardM2.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   bofly: Boolean;
begin
   if GetTickCount - m_dwGenAnicountTime > 120 then begin
      m_dwGenAnicountTime := GetTickCount;
      Inc (m_nGenAniCount);
      if m_nGenAniCount > 100000 then m_nGenAniCount := 0;
   end;
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
         if m_nCurrentAction = SM_FLYAXE then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (Self,1,3,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtfly,False,30,bofly);
             PlaySound (10052);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (self, MAGIC_EXPLOSIN_WIZARD, MAGIC_EXPLOSIN_WIZARD, m_nCurrX, m_nCurrY, m_nTargetX, m_nTargetY,
                                      m_nTargetRecog, mtThunder, FALSE,30, bo11);
             PlaySound(10232);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_3) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (Self,48,48,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtExplosion,False,30,bo11);
           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure  TWizardM2.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    m_WeaponSurface:=FrmMain.GetWWeaponImg(108,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
    m_WeaponSurface2:=nil;
    m_HairSurface := g_WHairImgImages.GetCachedImage(3336 + m_nCurrentFrame, m_nHpx, m_nHpy);
    m_BodySurface := FrmMain.GetWHum2Img(33,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
  end;
end;

procedure TWizardM2.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;
  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TWizardM2.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


//Á¤¿¬µµ»ç
procedure TToaistF2.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_HIT then begin //½Å¼ö ¿ø·É ¼ÒÈ¯
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,0,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_4 then begin //´ëÈ¸º¹¼ú
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagicImages,1790,10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin        //½Å¼ö, ¿ø·É¼ÒÈ¯
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10060);
    end;
    SM_LIGHTING: Begin  //Æø»ì°è
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10130);
    end;
    SM_LIGHTING_2: Begin //ÀúÁÖ¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10300);
    end;
    SM_LIGHTING_4: Begin //´ëÈ¸º¹¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10290);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_wom_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_wom_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TToaistF2.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bo11:Boolean;
   bofly: Boolean;
begin
   if GetTickCount - m_dwGenAnicountTime > 120 then begin
      m_dwGenAnicountTime := GetTickCount;
      Inc (m_nGenAniCount);
      if m_nGenAniCount > 100000 then m_nGenAniCount := 0;
   end;
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;
   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   if m_boUseEffect then begin
      if m_boMsgMuch then m_dwEffectFrameTimetime := Round(m_dwEffectFrameTime * 2 / 3)
      else m_dwEffectFrameTimetime := m_dwEffectFrameTime;
      if GetTickCount - m_dwEffectStartTime > m_dwEffectFrameTimetime then begin
         m_dwEffectStartTime := GetTickCount;
         if m_nEffectFrame < m_nEffectEnd then begin
            Inc (m_nEffectFrame);
         end else begin
            m_boUseEffect := FALSE;
         end;
      end;
   end;

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
            bo260:=False;
         end;
         if (m_nCurrentAction = SM_LIGHTING) then begin                             //Æø»ì°è
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (Self,10,10,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtExploBujauk,False,30,bofly);
             m_nmagicfiresound  := 10131;
             m_nmagicexplosionsound := 10132;
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) then begin                             //ÀúÁÖ¼ú
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (Self,MAGIC_FOX_CURSE2,MAGIC_FOX_CURSE2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtExploBujauk,False,30,bofly);
             m_nmagicfiresound  := 10131;
             m_nmagicexplosionsound := 10461;
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_4) then begin                             //´ëÈ¸º¹¼ú
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin   //4
             PlayScene.NewMagic (Self,27,27,m_nCurrX,m_nCurrY,m_nCurrX,m_nCurrY,0,mtExplosion,False,30,bo11);
             PlaySound (10292);
           end;
         end;
         m_nCurrentDefFrame := 0;
         m_dwDefFrameTime := GetTickCount;
      end;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;
end;

procedure  TToaistF2.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    m_WeaponSurface:=FrmMain.GetWWeaponImg(106,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
    m_WeaponSurface2:=nil;
    m_HairSurface := g_WHairImgImages.GetCachedImage(3336 + m_nCurrentFrame, m_nHpx, m_nHpy);
    m_BodySurface := FrmMain.GetWHum2Img(35,0 ,0,m_nCurrentFrame, m_nPx, m_nPy);
  end;
end;

procedure TToaistF2.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;
  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER[0, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);
end;

procedure TToaistF2.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


//Çõ¹®°´
procedure TAssassinM2.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_HIT then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,1960 + (m_btDir * 10),10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,2050 + (m_btDir * 10),10,60,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_2 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,2230 + (m_btDir * 10),10,85,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_3 then begin
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMagic2Images,2620 + (m_btDir * 20),20,100,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin       //Ç³°Ë¼ú
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10605);
    end;
    SM_LIGHTING: Begin  //Ç³°Ë¼ú
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10606);
    end;
    SM_LIGHTING_2: Begin //ÃµÀÌ°Ë°ø°Ý
      m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
      m_dwFrameTime := pm.ActCritical3.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(10635);
    end;
    SM_LIGHTING_3: Begin //¿ùÇÏ³­¹«°ø°Ý
      m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
      m_dwFrameTime := 100;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      m_nMagLight := 2;
      PlaySound (10725);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_killerman_struck);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      PlaySound(s_killerman_die);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure  TAssassinM2.LoadSurface;
begin
  if (not m_boReverseFrame) then begin
    m_WeaponSurface:=FrmMain.GetWWeapon_Killer_LeftImg(26,0,0,m_nCurrentFrame, m_nWpx, m_nWpy);
    m_WeaponSurface2:=FrmMain.GetWWeapon_Killer_RightImg(26,0,0,m_nCurrentFrame, m_nWp2x, m_nWp2y);
    m_HairSurface := g_WHair_KillerImgImages.GetCachedImage(1456 + m_nCurrentFrame, m_nHpx, m_nHpy);
    m_BodySurface := FrmMain.GetWHum_Killer2Img(36,0,0,m_nCurrentFrame, m_nPx, m_nPy);
  end;
end;

procedure TAssassinM2.DrawChr(dsurface: TDirectDrawSurface; dx, dy: integer;
  blend, boFlag: Boolean);
var
  ceff: TColorEffect;
begin
  if not (m_btDir in [0..7]) then exit;
  if GetTickCount - m_dwLoadSurfaceTime > 60 * 1000 then begin
    m_dwLoadSurfaceTime := GetTickCount;
    LoadSurface;
  end;
  ceff := GetDrawEffectValue;

  if (m_nCurrentFrame >= 0) and (m_nCurrentFrame <= 599) then
    m_nWpord := WORDER4[m_btSex, m_nCurrentFrame];

  if m_WeaponSurface <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface, dx + m_nWpx + m_nShiftX, dy + m_nWpy + m_nShiftY, blend, ceff);
  if m_WeaponSurface2 <> nil then
    DrawEffSurface (dsurface, m_WeaponSurface2, dx + m_nWp2x + m_nShiftX, dy + m_nWp2y + m_nShiftY, blend, ceff);
  if m_BodySurface <> nil then
    DrawEffSurface (dsurface, m_BodySurface, dx + m_nPx + m_nShiftX, dy + m_nPy + m_nShiftY, blend, ceff);
  if m_HairSurface <> nil then
    DrawEffSurface (dsurface, m_HairSurface, dx + m_nHpx + m_nShiftX, dy + m_nHpy + m_nShiftY, blend, ceff);

end;

procedure TAssassinM2.DrawEff(dsurface: TDirectDrawSurface; dx,
  dy: integer);
begin
  inherited;
  if m_boDeath then exit;
  if (m_boUseEffect) and (AttackEffectSurface <> nil) then begin
    DrawBlend (dsurface,dx + ax + m_nShiftX,dy + ay + m_nShiftY,AttackEffectSurface, 1);
  end;
end;


{À¯»ó±ÃÀå}

procedure TAchorMonster.CalcActorFrame;
var
  pm: PTMonsterAction;
begin
  inherited;
   m_nCurrentFrame := -1;
   m_nBodyOffset := GetOffset (m_wAppearance);
   pm := GetRaceByPM (m_btRace,m_wAppearance);
   if pm = nil then exit;
  case m_nCurrentAction of
    SM_FLYAXE: Begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
    end;
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
    end;
    SM_LIGHTING_2: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
    end;
    SM_BACKSTEP: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_nMoveStep := 3;
      Shift (GetBack(m_btDir), m_nMoveStep, 0, m_nEndFrame-m_nStartFrame+1);
      PlaySound(10966);
    end;
    else begin
      inherited;
    end;
  end;
end;

procedure TAchorMonster.Run;
var
   prv: integer;
   m_dwEffectFrameTimetime, m_dwFrameTimetime: longword;
   bofly: Boolean;
begin
   if (m_nCurrentAction = SM_WALK) or (m_nCurrentAction = SM_BACKSTEP) or (m_nCurrentAction = SM_RUN) or (m_nCurrentAction = SM_HORSERUN) then exit;

   m_boMsgMuch := FALSE;
   if m_MsgList.Count >= 2 then m_boMsgMuch := TRUE;

   RunActSound (m_nCurrentFrame - m_nStartFrame);
   RunFrameAction (m_nCurrentFrame - m_nStartFrame);

   prv := m_nCurrentFrame;
   if m_nCurrentAction <> 0 then begin
      if (m_nCurrentFrame < m_nStartFrame) or (m_nCurrentFrame > m_nEndFrame) then
         m_nCurrentFrame := m_nStartFrame;

      if m_boMsgMuch then m_dwFrameTimetime := Round(m_dwFrameTime * 2 / 3)
      else m_dwFrameTimetime := m_dwFrameTime;

      if GetTickCount - m_dwStartTime > m_dwFrameTimetime then begin
         if m_nCurrentFrame < m_nEndFrame then begin
            Inc (m_nCurrentFrame);
            m_dwStartTime := GetTickCount;
         end else begin
            m_nCurrentAction := 0;
            m_boUseEffect := FALSE;
         end;
         if (m_nCurrentAction = SM_FLYAXE) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (Self,MAGIC_ARCHER_ATT1,MAGIC_ARCHER_ATT1,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtfly,False,30,bofly);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (Self,MAGIC_ARCHER_ATT2,MAGIC_ARCHER_ATT2,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtfly,False,30,bofly);
             PlaySound(4372);
           end;
         end;
         if (m_nCurrentAction = SM_LIGHTING_2) then begin
           if (m_nCurrentFrame - m_nStartFrame) = 4 then begin
             PlayScene.NewMagic (Self,MAGIC_ARCHER_ATT3,MAGIC_ARCHER_ATT3,m_nCurrX,m_nCurrY,m_nTargetX,m_nTargetY,m_nTargetRecog,mtfly,False,30,bofly);
             PlaySound (4376);
            end;
          end;
      end;
      m_nCurrentDefFrame := 0;
      m_dwDefFrameTime := GetTickCount;
   end else begin
      if GetTickCount - m_dwSmoothMoveTime > 200 then begin
         if GetTickCount - m_dwDefFrameTime > 500 then begin
            m_dwDefFrameTime := GetTickCount;
            Inc (m_nCurrentDefFrame);
            if m_nCurrentDefFrame >= m_nDefFrameCount then
               m_nCurrentDefFrame := 0;
         end;
         DefaultMotion;
      end;
   end;

   if prv <> m_nCurrentFrame then begin
      m_dwLoadSurfaceTime := GetTickCount;
      LoadSurface;
   end;

end;


{¾ç¿ë¿Õ}
procedure TJobking.CalcActorFrame;
var
  Eff8:TNormalDrawEffect;
  Eff9:TNormalDrawEffect;
  Eff10:TNormalDrawEffect;
  Eff11:TNormalDrawEffect;
  Eff12:TNormalDrawEffect;
  pm: PTMonsterAction;
begin
  inherited;
  if m_nCurrentAction = SM_HIT then begin   //±¤Ç³Âü°ø°Ý
    Eff8:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5330 + (m_btDir * 10),10,80,True);
    if Eff8 <> nil then begin
      Eff8.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff8);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING then begin   //±¤¹üÀ§±¤Ç³Âü°ø°Ý
    Eff9:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5410 + (m_btDir * 10),10,80,True);
    if Eff9 <> nil then begin
      Eff9.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff9);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_2 then begin  //ºÒÁö¿°
    Eff9:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5490 + (m_btDir * 10),10,120,True);
    if Eff9 <> nil then begin
      Eff9.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff9);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_2 then begin  //ºÒÁö¿°
    Eff10:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5570 + (m_btDir * 10),10,120,True);
    if Eff10 <> nil then begin
      Eff10.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff10);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_3 then begin    //»¡°£Ä®Áú
    Eff10:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5660 + (m_btDir * 10),10,100,True);
    if Eff10 <> nil then begin
      Eff10.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff10);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_3 then begin   //»¡°£°ø°ÝÁÖº¯
    Eff11:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],6185,16,100,True);
    if Eff11 <> nil then begin
      Eff11.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff11);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_4 then begin     //ÀÏ¼¶
    Eff12:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5760 + (m_btDir * 10),10,100,True);
    if Eff12 <> nil then begin
      Eff12.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff12);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_5 then begin      //ÃµÁöÇÕÀÏ
    Eff12:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5920,20,100,True);
    if Eff12 <> nil then begin
      Eff12.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff12);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_6 then begin
    Eff12:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5836 + (m_btDir * 10),10,100,True);
    if Eff12 <> nil then begin
      Eff12.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff12);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_7 then begin     //ÀÏ½Å¾çÇ³¼º
    Eff11:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5940,10,200,True);
    if Eff11 <> nil then begin
      Eff11.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff11);
    end;
  end;
  if m_nCurrentAction = SM_LIGHTING_7 then begin     //ÀÏ½Å¾çÇ³¼º
    Eff12:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],5950 + (m_btDir * 10),10,200,TRUE);
    if Eff12 <> nil then begin
      Eff12.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff12);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_1 then begin     //ÀÏ½Å¾çÇ³¼º °ø°Ý
    Eff11:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],6033 + (m_btDir * 10),7,80,FALSE);
    if Eff11 <> nil then begin
      Eff11.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff11);
    end;
  end;
    if m_nCurrentAction = SM_LIGHTING_1 then begin     //ÀÏ½Å¾çÇ³¼º °ø°Ý
    Eff12:=TNormalDrawEffect.Create(m_nCurrX,m_nCurrY,g_WMonImagesArr[41],6110 + (m_btDir * 10),10,80,True);
    if Eff12 <> nil then begin
      Eff12.MagOwner:=g_MySelf;
      PlayScene.m_EffectList.Add(Eff12);
    end;
  end;
  m_nCurrentFrame := -1;
  m_nBodyOffset := GetOffset (m_wAppearance);
  pm := GetRaceByPM (m_btRace,m_wAppearance);
  if pm = nil then exit;

  case m_nCurrentAction of
    SM_HIT: Begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4342);
    end;
    SM_LIGHTING: begin
      m_nStartFrame := pm.ActCritical.start + m_btDir * (pm.ActCritical.frame + pm.ActCritical.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical.frame - 1;
      m_dwFrameTime := pm.ActCritical.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4346);
    end;
    SM_LIGHTING_2: begin
      m_nStartFrame := pm.ActCritical2.start + m_btDir * (pm.ActCritical2.frame + pm.ActCritical2.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical2.frame - 1;
      m_dwFrameTime := pm.ActCritical2.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      frmMain.DrawEffectHum(144,m_nTargetX-6, m_nTargetY, 0);
      frmMain.DrawEffectHum(144,m_nTargetX+7, m_nTargetY, 0);
      frmMain.DrawEffectHum(144,m_nTargetX, m_nTargetY+7, 0);
      frmMain.DrawEffectHum(144,m_nTargetX, m_nTargetY-7, 0);
      frmMain.DrawEffectHum(144,m_nTargetX+7, m_nTargetY+7, 0);
      frmMain.DrawEffectHum(144,m_nTargetX-6, m_nTargetY-7, 0);
      frmMain.DrawEffectHum(144,m_nTargetX+7, m_nTargetY-7, 0);
      frmMain.DrawEffectHum(144,m_nTargetX-6, m_nTargetY+7, 0);
      PlaySound(4347);
    end;
    SM_LIGHTING_3: begin
      m_nStartFrame := pm.ActCritical3.start + m_btDir * (pm.ActCritical3.frame + pm.ActCritical3.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical3.frame - 1;
      m_dwFrameTime := pm.ActCritical3.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4348);
    end;
    SM_LIGHTING_4: begin
      m_nStartFrame := pm.ActCritical4.start + m_btDir * (pm.ActCritical4.frame + pm.ActCritical4.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical4.frame - 1;
      m_dwFrameTime := pm.ActCritical4.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4356);
    end;
    SM_LIGHTING_5: begin      //¹Ð¾î³»±â
      m_nStartFrame := pm.ActCritical5.start + m_btDir * (pm.ActCritical5.frame + pm.ActCritical5.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical5.frame - 1;
      m_dwFrameTime := pm.ActCritical5.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4357);
    end;
    SM_LIGHTING_6: begin      //ÃµÁöÇÕÀÏ
      m_nStartFrame := pm.ActCritical6.start + m_btDir * (pm.ActCritical6.frame + pm.ActCritical6.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical6.frame - 1;
      m_dwFrameTime := pm.ActCritical6.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4358);
    end;
    SM_LIGHTING_7: begin
      m_nStartFrame := pm.ActCritical7.start + m_btDir * (pm.ActCritical7.frame + pm.ActCritical7.skip);
      m_nEndFrame := m_nStartFrame + pm.ActCritical7.frame - 1;
      m_dwFrameTime := pm.ActCritical7.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4359);
    end;
    SM_LIGHTING_1: begin
      m_nStartFrame := pm.ActAttack.start + m_btDir * (pm.ActAttack.frame + pm.ActAttack.skip);
      m_nEndFrame := m_nStartFrame + pm.ActAttack.frame - 1;
      m_dwFrameTime := pm.ActAttack.ftime;
      m_dwStartTime := GetTickCount;
      m_dwWarModeTime := GetTickCount;
      Shift (m_btDir, 0, 0, 1);
      PlaySound(4366);
    end;
    SM_STRUCK: begin
      m_nStartFrame := pm.ActStruck.start + m_btDir * (pm.ActStruck.frame + pm.ActStruck.skip);
      m_nEndFrame := m_nStartFrame + pm.ActStruck.frame - 1;
      m_dwFrameTime := m_dwStruckFrameTime;
      m_dwStartTime := GetTickCount;
      PlaySound(4344);
    end;
    SM_DEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_nStartFrame := m_nEndFrame;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
    end;
    SM_NOWDEATH: begin
      m_nStartFrame := pm.ActDie.start + m_btDir * (pm.ActDie.frame + pm.ActDie.skip);
      m_nEndFrame := m_nStartFrame + pm.ActDie.frame - 1;
      m_dwFrameTime := pm.ActDie.ftime;
      m_dwStartTime := GetTickCount;
      PlaySound(4345);
    end;
    else begin
      inherited;
    end;
  end;
end;


{---- Adjust global SVN revision ----}
initialization
  //SVNRevision('$Id: AxeMon.pas 516 2006-12-01 17:55:14Z Xander $');
end.

